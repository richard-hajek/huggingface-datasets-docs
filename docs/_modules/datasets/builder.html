
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>datasets.builder &#8212; Datasets 4.4.2.dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=564b2b0d" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=62d5458c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=fd10adb8"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/datasets/builder';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="4.4.2.dev0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ðŸ¤— Datasets</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../howto.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../concepts.html">
    Conceptual Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/huggingface/datasets" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://huggingface.co/datasets" title="Hugging Face" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Hugging Face</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../howto.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../concepts.html">
    Conceptual Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/huggingface/datasets" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://huggingface.co/datasets" title="Hugging Face" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Hugging Face</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">datasets.builder</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for datasets.builder</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020 The HuggingFace Datasets Authors and the TensorFlow Datasets Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="c1"># Lint as: python3</span>
<span class="sd">&quot;&quot;&quot;DatasetBuilder base class.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">posixpath</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">fsspec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fsspec.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">url_to_fs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.contrib.concurrent</span><span class="w"> </span><span class="kn">import</span> <span class="n">thread_map</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_reader</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ArrowReader</span><span class="p">,</span>
    <span class="n">ReadInstruction</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrowWriter</span><span class="p">,</span> <span class="n">ParquetWriter</span><span class="p">,</span> <span class="n">SchemaInferenceError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.data_files</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFilesDict</span><span class="p">,</span> <span class="n">DataFilesPatternsDict</span><span class="p">,</span> <span class="n">sanitize_patterns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.dataset_dict</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetDict</span><span class="p">,</span> <span class="n">IterableDatasetDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.download.download_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DownloadConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.download.download_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">DownloadManager</span><span class="p">,</span> <span class="n">DownloadMode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.download.streaming_download_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamingDownloadManager</span><span class="p">,</span> <span class="n">xjoin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetGenerationCastError</span><span class="p">,</span> <span class="n">DatasetGenerationError</span><span class="p">,</span> <span class="n">FileFormatError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">Features</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.filesystems</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">is_remote_filesystem</span><span class="p">,</span>
    <span class="n">rename</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fingerprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hasher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.info</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetInfo</span><span class="p">,</span> <span class="n">PostProcessedInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.iterable_dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrowExamplesIterable</span><span class="p">,</span> <span class="n">ExamplesIterable</span><span class="p">,</span> <span class="n">IterableDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.naming</span><span class="w"> </span><span class="kn">import</span> <span class="n">INVALID_WINDOWS_CHARACTERS_IN_PATH</span><span class="p">,</span> <span class="n">camelcase_to_snakecase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.splits</span><span class="w"> </span><span class="kn">import</span> <span class="n">Split</span><span class="p">,</span> <span class="n">SplitDict</span><span class="p">,</span> <span class="n">SplitGenerator</span><span class="p">,</span> <span class="n">SplitInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.streaming</span><span class="w"> </span><span class="kn">import</span> <span class="n">extend_dataset_builder_for_streaming</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">CastError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">hf_tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils._filelock</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.file_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_remote_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.info_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">VerificationMode</span><span class="p">,</span> <span class="n">get_size_checksum_dict</span><span class="p">,</span> <span class="n">verify_checksums</span><span class="p">,</span> <span class="n">verify_splits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.py_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classproperty</span><span class="p">,</span>
    <span class="n">convert_file_size_to_int</span><span class="p">,</span>
    <span class="n">has_sufficient_disk_space</span><span class="p">,</span>
    <span class="n">iflatmap_unordered</span><span class="p">,</span>
    <span class="n">map_nested</span><span class="p">,</span>
    <span class="n">memoize</span><span class="p">,</span>
    <span class="n">size_str</span><span class="p">,</span>
    <span class="n">temporary_assignment</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.sharding</span><span class="w"> </span><span class="kn">import</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">,</span> <span class="n">_split_gen_kwargs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.track</span><span class="w"> </span><span class="kn">import</span> <span class="n">tracked_list</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.load</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetModule</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">InvalidConfigName</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="BuilderConfig">
<a class="viewcode-back" href="../../api/generated/datasets.BuilderConfig.html#datasets.BuilderConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BuilderConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for `DatasetBuilder` data configuration.</span>

<span class="sd">    `DatasetBuilder` subclasses with data configuration options should subclass</span>
<span class="sd">    `BuilderConfig` and add their own properties.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (`str`, defaults to `default`):</span>
<span class="sd">            The name of the configuration.</span>
<span class="sd">        version (`Version` or `str`, defaults to `0.0.0`):</span>
<span class="sd">            The version of the configuration.</span>
<span class="sd">        data_dir (`str`, *optional*):</span>
<span class="sd">            Path to the directory containing the source data.</span>
<span class="sd">        data_files (`str` or `Sequence` or `Mapping`, *optional*):</span>
<span class="sd">            Path(s) to source data file(s).</span>
<span class="sd">        description (`str`, *optional*):</span>
<span class="sd">            A human description of the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">Version</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;0.0.0&quot;</span><span class="p">)</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">DataFilesDict</span><span class="p">,</span> <span class="n">DataFilesPatternsDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The config name is used to name the cache directory.</span>
        <span class="k">for</span> <span class="n">invalid_char</span> <span class="ow">in</span> <span class="n">INVALID_WINDOWS_CHARACTERS_IN_PATH</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">invalid_char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidConfigName</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Bad characters from black list &#39;</span><span class="si">{</span><span class="n">INVALID_WINDOWS_CHARACTERS_IN_PATH</span><span class="si">}</span><span class="s2">&#39; found in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;They could create issues when creating a directory for this config on Windows filesystem.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">,</span> <span class="p">(</span><span class="n">DataFilesDict</span><span class="p">,</span> <span class="n">DataFilesPatternsDict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a DataFilesDict in data_files but got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="c1"># we need to override the default dataclass __eq__ since it doesn&#39;t check for</span>
        <span class="c1"># other attributes that the ones of the signature.</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="BuilderConfig.create_config_id">
<a class="viewcode-back" href="../../api/generated/datasets.BuilderConfig.html#datasets.BuilderConfig.create_config_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_config_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">custom_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The config id is used to build the cache directory.</span>
<span class="sd">        By default it is equal to the config name.</span>
<span class="sd">        However the name of a config is not sufficient to have a unique identifier for the dataset being generated</span>
<span class="sd">        since it doesn&#39;t take into account:</span>
<span class="sd">        - the config kwargs that can be used to overwrite attributes</span>
<span class="sd">        - the custom features used to write the dataset</span>
<span class="sd">        - the data_files for json/text/csv/pandas datasets</span>

<span class="sd">        Therefore the config id is just the config name with an optional suffix based on these.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Possibly add a suffix to the name to handle custom features/data_files/config_kwargs</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">config_kwargs_to_add_to_suffix</span> <span class="o">=</span> <span class="n">config_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># name and version are already used to build the cache directory</span>
        <span class="n">config_kwargs_to_add_to_suffix</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">config_kwargs_to_add_to_suffix</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># data dir handling (when specified it points to the manually downloaded data):</span>
        <span class="c1"># it was previously ignored before the introduction of config id because we didn&#39;t want</span>
        <span class="c1"># to change the config name. Now it&#39;s fine to take it into account for the config id.</span>
        <span class="c1"># config_kwargs_to_add_to_suffix.pop(&quot;data_dir&quot;, None)</span>
        <span class="k">if</span> <span class="s2">&quot;data_dir&quot;</span> <span class="ow">in</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">config_kwargs_to_add_to_suffix</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;data_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># canonicalize the data dir to avoid two paths to the same location having different</span>
                <span class="c1"># hashes</span>
                <span class="n">data_dir</span> <span class="o">=</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span>
                <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
                <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="k">if</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">:</span>
            <span class="c1"># we don&#39;t care about the order of the kwargs</span>
            <span class="n">config_kwargs_to_add_to_suffix</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">config_kwargs_to_add_to_suffix</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config_kwargs_to_add_to_suffix</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>  <span class="c1"># hash if too long</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="n">Hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">config_kwargs_to_add_to_suffix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">Hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">config_kwargs_to_add_to_suffix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">custom_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Hasher</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_features</span><span class="p">)</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="n">config_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_DATASET_CONFIG_ID_READABLE_LENGTH</span><span class="p">:</span>
                <span class="n">config_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">Hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">config_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_data_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">download_config</span><span class="p">:</span> <span class="n">DownloadConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">,</span> <span class="n">DataFilesPatternsDict</span><span class="p">):</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">xjoin</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="k">else</span> <span class="n">base_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">download_config</span><span class="p">)</span></div>



<div class="viewcode-block" id="DatasetBuilder">
<a class="viewcode-back" href="../../api/generated/datasets.DatasetBuilder.html#datasets.DatasetBuilder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatasetBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for all datasets.</span>

<span class="sd">    `DatasetBuilder` has 3 key methods:</span>

<span class="sd">        - [`DatasetBuilder.info`]: Documents the dataset, including feature</span>
<span class="sd">          names, types, shapes, version, splits, citation, etc.</span>
<span class="sd">        - [`DatasetBuilder.download_and_prepare`]: Downloads the source data</span>
<span class="sd">          and writes it to disk.</span>
<span class="sd">        - [`DatasetBuilder.as_dataset`]: Generates a [`Dataset`].</span>

<span class="sd">    Some `DatasetBuilder`s expose multiple variants of the</span>
<span class="sd">    dataset by defining a [`BuilderConfig`] subclass and accepting a</span>
<span class="sd">    config object (or name) on construction. Configurable datasets expose a</span>
<span class="sd">    pre-defined set of configurations in [`DatasetBuilder.builder_configs`].</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_dir (`str`, *optional*):</span>
<span class="sd">            Directory to cache data. Defaults to `&quot;~/.cache/huggingface/datasets&quot;`.</span>
<span class="sd">        dataset_name (`str`, *optional*):</span>
<span class="sd">            Name of the dataset, if different from the builder name. Useful for packaged builders</span>
<span class="sd">            like csv, imagefolder, audiofolder, etc. to reflect the difference between datasets</span>
<span class="sd">            that use the same packaged builder.</span>
<span class="sd">        config_name (`str`, *optional*):</span>
<span class="sd">            Name of the dataset configuration.</span>
<span class="sd">            It affects the data generated on disk. Different configurations will have their own subdirectories and</span>
<span class="sd">            versions.</span>
<span class="sd">            If not provided, the default configuration is used (if it exists).</span>

<span class="sd">            &lt;Added version=&quot;2.3.0&quot;&gt;</span>

<span class="sd">            Parameter `name` was renamed to `config_name`.</span>

<span class="sd">            &lt;/Added&gt;</span>
<span class="sd">        hash (`str`, *optional*):</span>
<span class="sd">            Hash specific to the dataset builder code. Used to update the caching directory when the</span>
<span class="sd">            dataset builder code is updated (to avoid reusing old data).</span>
<span class="sd">            The typical caching directory (defined in `self._relative_data_dir`) is `name/version/hash/`.</span>
<span class="sd">        base_path (`str`, *optional*):</span>
<span class="sd">            Base path for relative paths that are used to download files.</span>
<span class="sd">            This can be a remote URL.</span>
<span class="sd">        features ([`Features`], *optional*):</span>
<span class="sd">            Features types to use with this dataset.</span>
<span class="sd">            It can be used to change the [`Features`] types of a dataset, for example.</span>
<span class="sd">        token (`str` or `bool`, *optional*):</span>
<span class="sd">            String or boolean to use as Bearer token for remote files on the</span>
<span class="sd">            Datasets Hub. If `True`, will get token from `&quot;~/.huggingface&quot;`.</span>
<span class="sd">        repo_id (`str`, *optional*):</span>
<span class="sd">            ID of the dataset repository.</span>
<span class="sd">            Used to distinguish builders with the same name but not coming from the same namespace, for example &quot;rajpurkar/squad&quot;</span>
<span class="sd">            and &quot;lhoestq/squad&quot; repo IDs. In the latter, the builder name would be &quot;lhoestq___squad&quot;.</span>
<span class="sd">        data_files (`str` or `Sequence` or `Mapping`, *optional*):</span>
<span class="sd">            Path(s) to source data file(s).</span>
<span class="sd">            For builders like &quot;csv&quot; or &quot;json&quot; that need the user to specify data files. They can be either</span>
<span class="sd">            local or remote files. For convenience, you can use a `DataFilesDict`.</span>
<span class="sd">        data_dir (`str`, *optional*):</span>
<span class="sd">            Path to directory containing source data file(s).</span>
<span class="sd">            Use only if `data_files` is not passed, in which case it is equivalent to passing</span>
<span class="sd">            `os.path.join(data_dir, &quot;**&quot;)` as `data_files`.</span>
<span class="sd">            For builders that require manual download, it must be the path to the local directory containing the</span>
<span class="sd">            manually downloaded data.</span>
<span class="sd">        storage_options (`dict`, *optional*):</span>
<span class="sd">            Key/value pairs to be passed on to the dataset file-system backend, if any.</span>
<span class="sd">        writer_batch_size (`int`, *optional*):</span>
<span class="sd">            Batch size used by the ArrowWriter.</span>
<span class="sd">            It defines the number of samples that are kept in memory before writing them</span>
<span class="sd">            and also the length of the arrow chunks.</span>
<span class="sd">            None means that the ArrowWriter will use its default value.</span>
<span class="sd">        **config_kwargs (additional keyword arguments): Keyword arguments to be passed to the corresponding builder</span>
<span class="sd">            configuration class, set on the class attribute [`DatasetBuilder.BUILDER_CONFIG_CLASS`]. The builder</span>
<span class="sd">            configuration class is [`BuilderConfig`] or a subclass of it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default version</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Default version set in BuilderConfig</span>

    <span class="c1"># Class for the builder config.</span>
    <span class="n">BUILDER_CONFIG_CLASS</span> <span class="o">=</span> <span class="n">BuilderConfig</span>

    <span class="c1"># Named configurations that modify the data generated by download_and_prepare.</span>
    <span class="n">BUILDER_CONFIGS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Optional default config name to be used when name is None</span>
    <span class="n">DEFAULT_CONFIG_NAME</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Default batch size used by the ArrowWriter</span>
    <span class="c1"># It defines the number of samples that are kept in memory before writing them</span>
    <span class="c1"># and also the length of the arrow chunks</span>
    <span class="c1"># None means that the ArrowWriter will use its default value</span>
    <span class="n">DEFAULT_WRITER_BATCH_SIZE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">hash</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">DataFilesDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">writer_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">config_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># DatasetBuilder name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">camelcase_to_snakecase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">camelcase_to_snakecase</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">dataset_name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer_batch_size</span> <span class="o">=</span> <span class="n">writer_batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_WRITER_BATCH_SIZE</span>

        <span class="k">if</span> <span class="n">data_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span> <span class="n">DataFilesDict</span><span class="p">):</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">DataFilesDict</span><span class="o">.</span><span class="n">from_patterns</span><span class="p">(</span>
                <span class="n">sanitize_patterns</span><span class="p">(</span><span class="n">data_files</span><span class="p">),</span>
                <span class="n">base_path</span><span class="o">=</span><span class="n">base_path</span><span class="p">,</span>
                <span class="n">download_config</span><span class="o">=</span><span class="n">DownloadConfig</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Prepare config: DatasetConfig contains name, version and description but can be extended by each dataset</span>
        <span class="k">if</span> <span class="s2">&quot;features&quot;</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIG_CLASS</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">and</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">if</span> <span class="n">data_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;data_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_files</span>
        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_kwargs</span> <span class="o">=</span> <span class="n">config_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_builder_config</span><span class="p">(</span>
            <span class="n">config_name</span><span class="o">=</span><span class="n">config_name</span><span class="p">,</span>
            <span class="n">custom_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span>
            <span class="o">**</span><span class="n">config_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># prepare info: DatasetInfo are a standardized dataclass across all datasets</span>
        <span class="c1"># Prefill datasetinfo</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">builder_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">info</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span>
        <span class="n">info</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span>
        <span class="n">info</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="c1"># update info with user specified infos</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

        <span class="c1"># Prepare data dirs:</span>
        <span class="c1"># cache_dir can be a remote bucket on GCS or S3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">HF_DATASETS_CACHE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span> <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DOWNLOADED_DATASETS_DIR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_dir</span>
            <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DOWNLOADED_DATASETS_PATH</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span>
            <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># In case there exists a legacy cache directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_relative_data_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lock_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">):</span>  <span class="c1"># check if data exist</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DATASET_INFO_FILENAME</span><span class="p">)):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Overwrite dataset info from restored data version if exists.&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">DatasetInfo</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># dir exists but no data, remove the empty dir as data aren&#39;t available anymore</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Old caching folder </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="si">}</span><span class="s2"> for dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> exists but no data were found. Removing it. &quot;</span>
                        <span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span><span class="p">)</span>

        <span class="c1"># Store in the cache by default unless the user specifies a custom output_dir to download_and_prepare</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">:</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">AbstractFileSystem</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>

        <span class="c1"># Set download manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_manager</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set to True by &quot;datasets-cli test&quot; to generate file checksums for (deprecated) dataset_infos.json independently of verification_mode value.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_infos</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Set in `.download_and_prepare` once the format of the generated dataset is known</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_format</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Enable streaming (e.g. it patches &quot;open&quot; to work with remote files)</span>
        <span class="n">extend_dataset_builder_for_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="c1"># Re-enable streaming, since patched functions are not kept when pickling</span>
        <span class="n">extend_dataset_builder_for_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_legacy_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for the old cache directory template {cache_dir}/{namespace}___{builder_name} from 2.13&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;datasets.&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span>
        <span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.packaged_modules</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PACKAGED_DATASETS_MODULES</span>

            <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">config_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span>
            <span class="n">config_id</span> <span class="o">=</span> <span class="n">config_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">:]</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">_PACKAGED_DATASETS_MODULES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;missing&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">legacy_relative_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">___</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">config_id</span><span class="p">,</span>
                <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
                <span class="nb">hash</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">legacy_cache_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="n">legacy_relative_data_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">legacy_cache_dir</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">legacy_relative_data_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_legacy_cache2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_module</span><span class="p">:</span> <span class="s2">&quot;DatasetModule&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for the old cache directory template {cache_dir}/{namespace}___{dataset_name}/{config_name}-xxx from 2.14 and 2.15&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;datasets.&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_kwargs</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;data_files&quot;</span><span class="p">,</span> <span class="s2">&quot;data_dir&quot;</span><span class="p">})</span>
        <span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.packaged_modules</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PACKAGED_DATASETS_MODULES_2_15_HASHES</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.utils._dill</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pickler</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">update_hash_with_config_parameters</span><span class="p">(</span><span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Used to update hash of packaged modules which is used for creating unique cache directories to reflect</span>
<span class="sd">                different config parameters which are passed in metadata from readme.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">params_to_exclude</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config_name&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">}</span>
                <span class="n">params_to_add_to_hash</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">param</span><span class="p">:</span> <span class="n">value</span>
                    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">config_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params_to_exclude</span>
                <span class="p">}</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">Hasher</span><span class="p">()</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_to_add_to_hash</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

            <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">Pickler</span><span class="p">,</span> <span class="s2">&quot;_legacy_no_dict_keys_sorting&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">config_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">Hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">({</span><span class="s2">&quot;data_files&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_files</span><span class="p">})</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">_PACKAGED_DATASETS_MODULES_2_15_HASHES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;missing&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">dataset_module</span><span class="o">.</span><span class="n">builder_configs_parameters</span><span class="o">.</span><span class="n">metadata_configs</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dataset_module</span><span class="o">.</span><span class="n">builder_configs_parameters</span><span class="o">.</span><span class="n">metadata_configs</span>
            <span class="p">):</span>
                <span class="nb">hash</span> <span class="o">=</span> <span class="n">update_hash_with_config_parameters</span><span class="p">(</span>
                    <span class="nb">hash</span><span class="p">,</span> <span class="n">dataset_module</span><span class="o">.</span><span class="n">builder_configs_parameters</span><span class="o">.</span><span class="n">metadata_configs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">legacy_relative_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">___</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">config_id</span><span class="p">,</span>
                <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
                <span class="nb">hash</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">legacy_cache_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="n">legacy_relative_data_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">legacy_cache_dir</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">legacy_relative_data_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_builder_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">config_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">BuilderConfig</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and validate BuilderConfig object as well as a unique config id for this config.</span>
<span class="sd">        Raises ValueError if there are multiple builder configs and config_name and DEFAULT_CONFIG_NAME are None.</span>
<span class="sd">        config_kwargs override the defaults kwargs in config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">builder_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># try default config</span>
        <span class="k">if</span> <span class="n">config_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CONFIG_NAME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">builder_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CONFIG_NAME</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No config specified, defaulting to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_kwargs</span><span class="p">:</span>
                        <span class="n">example_of_usage</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;load_dataset(&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Config name is missing.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please pick one among the available configs: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example of usage:</span><span class="se">\n\t</span><span class="s2">`</span><span class="si">{</span><span class="n">example_of_usage</span><span class="si">}</span><span class="s2">`&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">builder_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No config specified, defaulting to the single config: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># try to get config by name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">builder_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">builder_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;BuilderConfig &#39;</span><span class="si">{</span><span class="n">config_name</span><span class="si">}</span><span class="s2">&#39; not found. Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># if not using an existing config, then create a new config on the fly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">builder_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_name</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CONFIG_NAME</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config_kwargs</span><span class="p">:</span>
                <span class="c1"># Use DEFAULT_CONFIG_NAME only if no config_kwargs are passed</span>
                <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CONFIG_NAME</span>
            <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_kwargs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;VERSION&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span>
                <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span>
            <span class="n">builder_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BUILDER_CONFIG_CLASS</span><span class="p">(</span><span class="o">**</span><span class="n">config_kwargs</span><span class="p">)</span>

        <span class="c1"># otherwise use the config_kwargs to overwrite the attributes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">builder_config</span><span class="p">)</span> <span class="k">if</span> <span class="n">config_kwargs</span> <span class="k">else</span> <span class="n">builder_config</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">builder_config</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BuilderConfig </span><span class="si">{</span><span class="n">builder_config</span><span class="si">}</span><span class="s2"> doesn&#39;t have a &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; key.&quot;</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">builder_config</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BuilderConfig must have a name, got </span><span class="si">{</span><span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># resolve data files if needed</span>
        <span class="n">builder_config</span><span class="o">.</span><span class="n">_resolve_data_files</span><span class="p">(</span>
            <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span>
            <span class="n">download_config</span><span class="o">=</span><span class="n">DownloadConfig</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># compute the config id that is going to be used for caching</span>
        <span class="k">if</span> <span class="n">config_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_id</span> <span class="o">=</span> <span class="n">builder_config</span><span class="o">.</span><span class="n">create_config_id</span><span class="p">(</span>
                <span class="n">config_kwargs</span><span class="p">,</span>
                <span class="n">custom_features</span><span class="o">=</span><span class="n">custom_features</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">is_custom</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config_id</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span>
        <span class="k">if</span> <span class="n">is_custom</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using custom data configuration </span><span class="si">{</span><span class="n">config_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">builder_config</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span>
                <span class="ow">and</span> <span class="n">builder_config</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="p">[</span><span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot name a custom BuilderConfig the same as an available &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;BuilderConfig. Change the name. Available BuilderConfigs: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">builder_config</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BuilderConfig </span><span class="si">{</span><span class="n">builder_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must have a version&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">builder_config</span><span class="p">,</span> <span class="n">config_id</span>

    <span class="nd">@classproperty</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@memoize</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">builder_configs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BuilderConfig</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of pre-defined configurations for this builder class.&quot;&quot;&quot;</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">config</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">BUILDER_CONFIGS</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Names in BUILDER_CONFIGS must not be duplicated. Got </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">configs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cache_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_use_legacy_cache_dir_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_module</span><span class="p">:</span> <span class="s2">&quot;DatasetModule&quot;</span><span class="p">):</span>
        <span class="c1"># Check for the legacy cache directory template (datasets&lt;3.0.0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_relative_data_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_legacy_cache2</span><span class="p">(</span><span class="n">dataset_module</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_legacy_cache</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_relative_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_version</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relative path of this dataset in cache_dir:</span>
<span class="sd">        Will be:</span>
<span class="sd">            self.dataset_name/self.config.version/self.hash/</span>
<span class="sd">        or if a repo_id with a namespace has been specified:</span>
<span class="sd">            self.namespace___self.dataset_name/self.config.version/self.hash/</span>
<span class="sd">        If any of these element is missing or if ``with_version=False`` the corresponding subfolders are dropped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_relative_data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">with_version</span> <span class="ow">and</span> <span class="n">with_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_relative_data_dir</span>

        <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">builder_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">___</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">builder_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_version</span><span class="p">:</span>
            <span class="n">builder_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">with_hash</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">builder_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder_data_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_cache_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the data directory for the current version.&quot;&quot;&quot;</span>
        <span class="n">builder_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_data_dir</span><span class="p">(</span><span class="n">with_version</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">version_data_dir</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_data_dir</span><span class="p">(</span><span class="n">with_version</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_other_versions_on_disk</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns previous versions on disk.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">version_dirnames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">version_dirnames</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">utils</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">dir_name</span><span class="p">),</span> <span class="n">dir_name</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Invalid version (ex: incomplete data dir)</span>
                    <span class="k">pass</span>
            <span class="n">version_dirnames</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">version_dirnames</span>

        <span class="c1"># Check and warn if other versions exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="n">builder_data_dir</span><span class="p">):</span>
            <span class="n">version_dirs</span> <span class="o">=</span> <span class="n">_other_versions_on_disk</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">version_dirs</span><span class="p">:</span>
                <span class="n">other_version</span> <span class="o">=</span> <span class="n">version_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">other_version</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                    <span class="n">warn_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found a different version </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">other_version</span><span class="p">)</span><span class="si">}</span><span class="s2"> of dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> in &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;cache_dir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir_root</span><span class="si">}</span><span class="s2">. Using currently defined version &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">version_data_dir</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the DatasetInfo object. See `DatasetInfo` for details.</span>

<span class="sd">        Warning: This function is only called once and the result is cached for all</span>
<span class="sd">        following .info() calls.</span>

<span class="sd">        Returns:</span>
<span class="sd">            info: (DatasetInfo) The dataset information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="DatasetBuilder.get_imported_module_dir">
<a class="viewcode-back" href="../../api/generated/datasets.DatasetBuilder.html#datasets.DatasetBuilder.get_imported_module_dir">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_imported_module_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the path of the module of this class or subclass.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="bp">cls</span><span class="p">)))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

<div class="viewcode-block" id="DatasetBuilder.download_and_prepare">
<a class="viewcode-back" href="../../api/generated/datasets.DatasetBuilder.download_and_prepare.html#datasets.DatasetBuilder.download_and_prepare">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_and_prepare</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">download_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DownloadConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">download_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">DownloadMode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verification_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">VerificationMode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dl_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DownloadManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">download_and_prepare_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads and prepares dataset for reading.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (`str`, *optional*):</span>
<span class="sd">                Output directory for the dataset.</span>
<span class="sd">                Default to this builder&#39;s `cache_dir`, which is inside `~/.cache/huggingface/datasets` by default.</span>

<span class="sd">                &lt;Added version=&quot;2.5.0&quot;/&gt;</span>
<span class="sd">            download_config (`DownloadConfig`, *optional*):</span>
<span class="sd">                Specific download configuration parameters.</span>
<span class="sd">            download_mode ([`DownloadMode`] or `str`, *optional*):</span>
<span class="sd">                Select the download/generate mode, default to `REUSE_DATASET_IF_EXISTS`.</span>
<span class="sd">            verification_mode ([`VerificationMode`] or `str`, defaults to `BASIC_CHECKS`):</span>
<span class="sd">                Verification mode determining the checks to run on the downloaded/processed dataset information (checksums/size/splits/...).</span>

<span class="sd">                &lt;Added version=&quot;2.9.1&quot;/&gt;</span>
<span class="sd">            dl_manager (`DownloadManager`, *optional*):</span>
<span class="sd">                Specific `DownloadManger` to use.</span>
<span class="sd">            base_path (`str`, *optional*):</span>
<span class="sd">                Base path for relative paths that are used to download files. This can be a remote url.</span>
<span class="sd">                If not specified, the value of the `base_path` attribute (`self.base_path`) will be used instead.</span>
<span class="sd">            file_format (`str`, *optional*):</span>
<span class="sd">                Format of the data files in which the dataset will be written.</span>
<span class="sd">                Supported formats: &quot;arrow&quot;, &quot;parquet&quot;. Default to &quot;arrow&quot; format.</span>
<span class="sd">                If the format is &quot;parquet&quot;, then image and audio data are embedded into the Parquet files instead of pointing to local files.</span>

<span class="sd">                &lt;Added version=&quot;2.5.0&quot;/&gt;</span>
<span class="sd">            max_shard_size (`Union[str, int]`, *optional*):</span>
<span class="sd">                Maximum number of bytes written per shard, default is &quot;500MB&quot;.</span>
<span class="sd">                The size is based on uncompressed data size, so in practice your shard files may be smaller than</span>
<span class="sd">                `max_shard_size` thanks to Parquet compression for example.</span>

<span class="sd">                &lt;Added version=&quot;2.5.0&quot;/&gt;</span>
<span class="sd">            num_proc (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Number of processes when downloading and generating the dataset locally.</span>
<span class="sd">                Multiprocessing is disabled by default.</span>

<span class="sd">                &lt;Added version=&quot;2.7.0&quot;/&gt;</span>
<span class="sd">            storage_options (`dict`, *optional*):</span>
<span class="sd">                Key/value pairs to be passed on to the caching file-system backend, if any.</span>

<span class="sd">                &lt;Added version=&quot;2.5.0&quot;/&gt;</span>
<span class="sd">            **download_and_prepare_kwargs (additional keyword arguments): Keyword arguments.</span>

<span class="sd">        Example:</span>

<span class="sd">        Download and prepare the dataset as Arrow files that can be loaded as a Dataset using `builder.as_dataset()`:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset_builder</span>
<span class="sd">        &gt;&gt;&gt; builder = load_dataset_builder(&quot;cornell-movie-review-data/rotten_tomatoes&quot;)</span>
<span class="sd">        &gt;&gt;&gt; builder.download_and_prepare()</span>
<span class="sd">        ```</span>

<span class="sd">        Download and prepare the dataset as sharded Parquet files locally:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset_builder</span>
<span class="sd">        &gt;&gt;&gt; builder = load_dataset_builder(&quot;cornell-movie-review-data/rotten_tomatoes&quot;)</span>
<span class="sd">        &gt;&gt;&gt; builder.download_and_prepare(&quot;./output_dir&quot;, file_format=&quot;parquet&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        Download and prepare the dataset as sharded Parquet files in a cloud storage:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset_builder</span>
<span class="sd">        &gt;&gt;&gt; storage_options = {&quot;key&quot;: aws_access_key_id, &quot;secret&quot;: aws_secret_access_key}</span>
<span class="sd">        &gt;&gt;&gt; builder = load_dataset_builder(&quot;cornell-movie-review-data/rotten_tomatoes&quot;)</span>
<span class="sd">        &gt;&gt;&gt; builder.download_and_prepare(&quot;s3://my-bucket/my_rotten_tomatoes&quot;, storage_options=storage_options, file_format=&quot;parquet&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dir</span>
        <span class="c1"># output_dir can be a remote bucket on GCS or S3</span>
        <span class="n">fs</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="n">url_to_fs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">storage_options</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">download_mode</span> <span class="o">=</span> <span class="n">DownloadMode</span><span class="p">(</span><span class="n">download_mode</span> <span class="ow">or</span> <span class="n">DownloadMode</span><span class="o">.</span><span class="n">REUSE_DATASET_IF_EXISTS</span><span class="p">)</span>
        <span class="n">verification_mode</span> <span class="o">=</span> <span class="n">VerificationMode</span><span class="p">(</span><span class="n">verification_mode</span> <span class="ow">or</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">BASIC_CHECKS</span><span class="p">)</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span>

        <span class="k">if</span> <span class="n">file_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;arrow&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file_format: </span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">. Expected &#39;arrow&#39; or &#39;parquet&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_format</span> <span class="o">=</span> <span class="n">file_format</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># We don&#39;t support the root directory, because it has no dirname,</span>
            <span class="c1"># and we need a dirname to use a &lt;dirname&gt;.incomplete directory</span>
            <span class="c1"># when the dataset is being written</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to download and prepare the dataset at the root </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please specify a subdirectory, e.g. &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">dl_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">download_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">download_config</span> <span class="o">=</span> <span class="n">DownloadConfig</span><span class="p">(</span>
                    <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_downloaded_dir</span><span class="p">,</span>
                    <span class="n">force_download</span><span class="o">=</span><span class="n">download_mode</span> <span class="o">==</span> <span class="n">DownloadMode</span><span class="o">.</span><span class="n">FORCE_REDOWNLOAD</span><span class="p">,</span>
                    <span class="n">force_extract</span><span class="o">=</span><span class="n">download_mode</span> <span class="o">==</span> <span class="n">DownloadMode</span><span class="o">.</span><span class="n">FORCE_REDOWNLOAD</span><span class="p">,</span>
                    <span class="n">use_etag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">num_proc</span><span class="o">=</span><span class="n">num_proc</span><span class="p">,</span>
                    <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                    <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># We don&#39;t use etag for data files to speed up the process</span>

            <span class="n">dl_manager</span> <span class="o">=</span> <span class="n">DownloadManager</span><span class="p">(</span>
                <span class="n">dataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                <span class="n">download_config</span><span class="o">=</span><span class="n">download_config</span><span class="p">,</span>
                <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                <span class="n">base_path</span><span class="o">=</span><span class="n">base_path</span><span class="p">,</span>
                <span class="n">record_checksums</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_infos</span> <span class="ow">or</span> <span class="n">verification_mode</span> <span class="o">==</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">ALL_CHECKS</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">is_local</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_manager</span> <span class="o">=</span> <span class="n">dl_manager</span>

        <span class="c1"># Prevent parallel local disk operations</span>
        <span class="k">if</span> <span class="n">is_local</span><span class="p">:</span>
            <span class="c1"># Create parent directory of the output_dir to put the lock file in there</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lock_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">+</span> <span class="s2">&quot;_builder.lock&quot;</span>

        <span class="c1"># File locking only with local paths; no file locking on GCS or S3</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_local</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">():</span>
            <span class="c1"># Check if the data already exists</span>
            <span class="n">data_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DATASET_INFO_FILENAME</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data_exists</span> <span class="ow">and</span> <span class="n">download_mode</span> <span class="o">==</span> <span class="n">DownloadMode</span><span class="o">.</span><span class="n">REUSE_DATASET_IF_EXISTS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found cached dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="c1"># We need to update the info in case some splits were added in the meantime</span>
                <span class="c1"># for example when calling load_dataset from multiple workers.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_info</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_post_processing_resources</span><span class="p">(</span><span class="n">dl_manager</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_local</span><span class="p">:</span>  <span class="c1"># if cache dir is local, check for available space</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_sufficient_disk_space</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Not enough disk space. Needed: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> (download: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, generated: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, post-processed: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processing_size</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

            <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">incomplete_dir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Create temporary dir for dirname and rename on exit.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_local</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">dirname</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="s2">&quot;.incomplete&quot;</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">tmp_dir</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                        <span class="c1"># LocalFileSystem.mv does copy + rm, it is more efficient to simply rename a local directory</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">):</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

            <span class="c1"># Print is intentional: we want this to always go to stdout so user has</span>
            <span class="c1"># information needed to cancel download/preparation if needed.</span>
            <span class="c1"># This comes right before the progress bar.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Downloading and preparing dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(download: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span><span class="p">)</span><span class="si">}</span><span class="s2">, generated: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;post-processed: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processing_size</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;total: </span><span class="si">{</span><span class="n">size_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">...&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_local</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading and preparing dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">_dest</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="c1"># Create a tmp dir and rename to self._output_dir on successful exit.</span>
            <span class="k">with</span> <span class="n">incomplete_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_output_dir</span><span class="p">:</span>
                <span class="c1"># Temporarily assign _output_dir to tmp_data_dir to avoid having to forward</span>
                <span class="c1"># it to every sub function.</span>
                <span class="k">with</span> <span class="n">temporary_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_output_dir&quot;</span><span class="p">,</span> <span class="n">tmp_output_dir</span><span class="p">):</span>
                    <span class="n">prepare_split_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;file_format&quot;</span><span class="p">:</span> <span class="n">file_format</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">max_shard_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">prepare_split_kwargs</span><span class="p">[</span><span class="s2">&quot;max_shard_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_shard_size</span>
                    <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">prepare_split_kwargs</span><span class="p">[</span><span class="s2">&quot;num_proc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_proc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_download_and_prepare</span><span class="p">(</span>
                        <span class="n">dl_manager</span><span class="o">=</span><span class="n">dl_manager</span><span class="p">,</span>
                        <span class="n">verification_mode</span><span class="o">=</span><span class="n">verification_mode</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">prepare_split_kwargs</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">download_and_prepare_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Sync info</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">num_bytes</span> <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_checksums</span> <span class="o">=</span> <span class="n">dl_manager</span><span class="o">.</span><span class="n">get_recorded_sizes_checksums</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span>
                    <span class="c1"># Save info</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">()</span>

            <span class="c1"># Download post processing resources</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_post_processing_resources</span><span class="p">(</span><span class="n">dl_manager</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> downloaded and prepared to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Subsequent calls will reuse this data.&quot;</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_download_and_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">,</span> <span class="n">verification_mode</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare_split_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads and prepares dataset for reading.</span>

<span class="sd">        This is the internal implementation to overwrite called when user calls</span>
<span class="sd">        `download_and_prepare`. It should download all required data and generate</span>
<span class="sd">        the pre-processed datasets files.</span>

<span class="sd">        Args:</span>
<span class="sd">            dl_manager ([`DownloadManager`]):</span>
<span class="sd">                `DownloadManager` used to download and cache data.</span>
<span class="sd">            verification_mode ([`VerificationMode`]):</span>
<span class="sd">                if `ALL_CHECKS`, perform all the verifications including checksums.</span>
<span class="sd">                if `BASIC_CHECKS`, do not perform checksums, only perform split tests.</span>
<span class="sd">                if `NO_CHECKS`, do not perform any verification.</span>
<span class="sd">            prepare_split_kwargs: Additional options, such as `file_format`, `max_shard_size`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generating data for all splits</span>
        <span class="n">split_dict</span> <span class="o">=</span> <span class="n">SplitDict</span><span class="p">(</span><span class="n">dataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="n">split_generators_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_split_generators_kwargs</span><span class="p">(</span><span class="n">prepare_split_kwargs</span><span class="p">)</span>
        <span class="n">split_generators</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SplitGenerator</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_generators</span><span class="p">(</span><span class="n">dl_manager</span><span class="p">,</span> <span class="o">**</span><span class="n">split_generators_kwargs</span><span class="p">)</span>

        <span class="c1"># Checksums verification</span>
        <span class="k">if</span> <span class="n">verification_mode</span> <span class="o">==</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">ALL_CHECKS</span> <span class="ow">and</span> <span class="n">dl_manager</span><span class="o">.</span><span class="n">record_checksums</span><span class="p">:</span>
            <span class="n">verify_checksums</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_checksums</span><span class="p">,</span> <span class="n">dl_manager</span><span class="o">.</span><span class="n">get_recorded_sizes_checksums</span><span class="p">(),</span> <span class="s2">&quot;dataset source files&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Build splits</span>
        <span class="k">for</span> <span class="n">split_generator</span> <span class="ow">in</span> <span class="n">split_generators</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`all` is a special split keyword corresponding to the &quot;</span>
                    <span class="s2">&quot;union of all splits, so cannot be used as key in &quot;</span>
                    <span class="s2">&quot;._split_generator().&quot;</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split&quot;</span><span class="p">)</span>
            <span class="n">split_dict</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Prepare split will record examples associated to the split</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_split</span><span class="p">(</span><span class="n">split_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare_split_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Cannot find data file. &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original error:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
            <span class="n">dl_manager</span><span class="o">.</span><span class="n">manage_extracted_files</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verification_mode</span> <span class="o">==</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">BASIC_CHECKS</span> <span class="ow">or</span> <span class="n">verification_mode</span> <span class="o">==</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">ALL_CHECKS</span><span class="p">:</span>
            <span class="n">verify_splits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="p">,</span> <span class="n">split_dict</span><span class="p">)</span>

        <span class="c1"># Update the info object with the splits.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">split_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span> <span class="o">=</span> <span class="n">dl_manager</span><span class="o">.</span><span class="n">downloaded_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_post_processing_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">for</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">resource_file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_resources</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Post processing is not supported on filesystem </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">resource_file_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resources shouldn&#39;t be in a sub-directory: </span><span class="si">{</span><span class="n">resource_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">resource_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">resource_file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resource_path</span><span class="p">):</span>
                    <span class="n">downloaded_resource_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_post_processing_resources</span><span class="p">(</span>
                        <span class="n">split</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">dl_manager</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">downloaded_resource_path</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded post-processing resource </span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">resource_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">downloaded_resource_path</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetInfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DatasetInfo</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_lock</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">+</span> <span class="s2">&quot;_info.lock&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">file_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">write_to_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_split_generators_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prepare_split_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get kwargs for `self._split_generators()` from `prepare_split_kwargs`.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">prepare_split_kwargs</span>
        <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="DatasetBuilder.as_dataset">
<a class="viewcode-back" href="../../api/generated/datasets.DatasetBuilder.as_dataset.html#datasets.DatasetBuilder.as_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Split</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Split</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_post_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verification_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">VerificationMode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">DatasetDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a Dataset for the specified split.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (`datasets.Split`):</span>
<span class="sd">                Which subset of the data to return.</span>
<span class="sd">            run_post_process (`bool`, defaults to `True`):</span>
<span class="sd">                Whether to run post-processing dataset transforms and/or add</span>
<span class="sd">                indexes.</span>
<span class="sd">            verification_mode ([`VerificationMode`] or `str`, defaults to `BASIC_CHECKS`):</span>
<span class="sd">                Verification mode determining the checks to run on the</span>
<span class="sd">                downloaded/processed dataset information (checksums/size/splits/...).</span>

<span class="sd">                &lt;Added version=&quot;2.9.1&quot;/&gt;</span>
<span class="sd">            in_memory (`bool`, defaults to `False`):</span>
<span class="sd">                Whether to copy the data in-memory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datasets.Dataset</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset_builder</span>
<span class="sd">        &gt;&gt;&gt; builder = load_dataset_builder(&#39;cornell-movie-review-data/rotten_tomatoes&#39;)</span>
<span class="sd">        &gt;&gt;&gt; builder.download_and_prepare()</span>
<span class="sd">        &gt;&gt;&gt; ds = builder.as_dataset(split=&#39;train&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ds</span>
<span class="sd">        Dataset({</span>
<span class="sd">            features: [&#39;text&#39;, &#39;label&#39;],</span>
<span class="sd">            num_rows: 8530</span>
<span class="sd">        })</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_format</span> <span class="o">!=</span> <span class="s2">&quot;arrow&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FileFormatError</span><span class="p">(</span><span class="s1">&#39;Loading a dataset not written in the &quot;arrow&quot; format is not supported.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading a dataset cached in a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">: could not find data in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">. Please make sure to call &quot;</span>
                <span class="s2">&quot;builder.download_and_prepare(), or use &quot;</span>
                <span class="s2">&quot;datasets.load_dataset() before trying to access the Dataset object.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constructing Dataset for split </span><span class="si">{</span><span class="n">split</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span><span class="si">}</span><span class="s2">, from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># By default, return all splits</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="p">}</span>

        <span class="n">verification_mode</span> <span class="o">=</span> <span class="n">VerificationMode</span><span class="p">(</span><span class="n">verification_mode</span> <span class="ow">or</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">BASIC_CHECKS</span><span class="p">)</span>

        <span class="c1"># Create a dataset for each of the given splits</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">map_nested</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_single_dataset</span><span class="p">,</span>
                <span class="n">run_post_process</span><span class="o">=</span><span class="n">run_post_process</span><span class="p">,</span>
                <span class="n">verification_mode</span><span class="o">=</span><span class="n">verification_mode</span><span class="p">,</span>
                <span class="n">in_memory</span><span class="o">=</span><span class="n">in_memory</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">split</span><span class="p">,</span>
            <span class="n">map_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">disable_tqdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">DatasetDict</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datasets</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_single_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReadInstruction</span><span class="p">,</span> <span class="n">Split</span><span class="p">],</span>
        <span class="n">run_post_process</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">verification_mode</span><span class="p">:</span> <span class="n">VerificationMode</span><span class="p">,</span>
        <span class="n">in_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;as_dataset for a single split.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">ReadInstruction</span><span class="p">):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">Split</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>

        <span class="c1"># Build base dataset</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_dataset</span><span class="p">(</span>
            <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
            <span class="n">in_memory</span><span class="o">=</span><span class="n">in_memory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">run_post_process</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resource_file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_resources</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">resource_file_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resources shouldn&#39;t be in a sub-directory: </span><span class="si">{</span><span class="n">resource_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">resources_paths</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">resource_name</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">resource_file_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">resource_file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_resources</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">post_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">resources_paths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">post_processed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">post_processed</span>
                <span class="n">recorded_checksums</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">record_checksums</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">resource_path</span> <span class="ow">in</span> <span class="n">resources_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">size_checksum</span> <span class="o">=</span> <span class="n">get_size_checksum_dict</span><span class="p">(</span><span class="n">resource_path</span><span class="p">)</span>
                    <span class="n">recorded_checksums</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_checksum</span>
                <span class="k">if</span> <span class="n">verification_mode</span> <span class="o">==</span> <span class="n">VerificationMode</span><span class="o">.</span><span class="n">ALL_CHECKS</span> <span class="ow">and</span> <span class="n">record_checksums</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">expected_checksums</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expected_checksums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
                    <span class="n">verify_checksums</span><span class="p">(</span><span class="n">expected_checksums</span><span class="p">,</span> <span class="n">recorded_checksums</span><span class="p">,</span> <span class="s2">&quot;post processing resources&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span> <span class="o">=</span> <span class="n">PostProcessedInfo</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">)]</span> <span class="o">=</span> <span class="n">recorded_checksums</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processing_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="n">checksums_dict</span><span class="p">[</span><span class="s2">&quot;num_bytes&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">split_checksums_dicts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">resources_checksums</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">checksums_dict</span> <span class="ow">in</span> <span class="n">split_checksums_dicts</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">download_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processing_size</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_info</span><span class="p">()</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">post_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">post_processing_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processing_size</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size_in_bytes</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ds</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Post-processed features info don&#39;t match the dataset:</span><span class="se">\n</span><span class="s2">Got</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s2">but expected something like</span><span class="se">\n</span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">post_processed</span><span class="o">.</span><span class="n">features</span>

        <span class="k">return</span> <span class="n">ds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_as_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ReadInstruction</span><span class="p">,</span> <span class="n">Split</span><span class="p">]</span> <span class="o">=</span> <span class="n">Split</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">in_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs a `Dataset`.</span>

<span class="sd">        This is the internal implementation to overwrite called when user calls</span>
<span class="sd">        `as_dataset`. It should read the pre-processed datasets files and generate</span>
<span class="sd">        the `Dataset` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (`datasets.Split`):</span>
<span class="sd">                which subset of the data to read.</span>
<span class="sd">            in_memory (`bool`, defaults to `False`):</span>
<span class="sd">                Whether to copy the data in-memory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `Dataset`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">)</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_legacy_cache</span><span class="p">():</span>
            <span class="n">dataset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dataset_kwargs</span> <span class="o">=</span> <span class="n">ArrowReader</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
            <span class="n">instructions</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
            <span class="n">split_infos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">in_memory</span><span class="o">=</span><span class="n">in_memory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset_fingerprint</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fingerprint</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">,</span> <span class="o">**</span><span class="n">dataset_kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dataset_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ReadInstruction</span><span class="p">,</span> <span class="n">Split</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dataset fingerprint is the hash of the relative directory dataset_name/config_name/version/hash, as well as the split specs.&quot;&quot;&quot;</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">Hasher</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative_data_dir</span><span class="p">())</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">))</span>  <span class="c1"># for example: train, train+test, train[:10%], test[:33%](pct1_dropremainder)</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fingerprint</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_streaming_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IterableDataset</span><span class="p">],</span> <span class="n">IterableDataset</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">is_remote_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Loading a streaming dataset cached in a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not supported yet.&quot;</span>
            <span class="p">)</span>

        <span class="n">dl_manager</span> <span class="o">=</span> <span class="n">StreamingDownloadManager</span><span class="p">(</span>
            <span class="n">base_path</span><span class="o">=</span><span class="n">base_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span>
            <span class="n">download_config</span><span class="o">=</span><span class="n">DownloadConfig</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">),</span>
            <span class="n">dataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">splits_generators</span> <span class="o">=</span> <span class="p">{</span><span class="n">sg</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sg</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_generators</span><span class="p">(</span><span class="n">dl_manager</span><span class="p">)}</span>
        <span class="c1"># By default, return all splits</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splits_generator</span> <span class="o">=</span> <span class="n">splits_generators</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits_generators</span><span class="p">:</span>
            <span class="n">splits_generator</span> <span class="o">=</span> <span class="n">splits_generators</span><span class="p">[</span><span class="n">split</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad split: </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">. Available splits: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">splits_generators</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dataset for each of the given splits</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">map_nested</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_as_streaming_dataset_single</span><span class="p">,</span>
            <span class="n">splits_generator</span><span class="p">,</span>
            <span class="n">map_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">IterableDatasetDict</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datasets</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_as_streaming_dataset_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splits_generator</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableDataset</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_examples_iterable_for_split</span><span class="p">(</span><span class="n">splits_generator</span><span class="p">)</span>
        <span class="c1"># add auth to be able to access and decode audio/image files from private repositories.</span>
        <span class="n">token_per_repo_id</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_id</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">splits_generator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">token_per_repo_id</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">resources_paths</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run dataset transforms or add indexes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_processing_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping resource_name -&gt; resource_file_name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_download_post_processing_resources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">:</span> <span class="n">DownloadManager</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download the resource using the download manager and return the downloaded path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_split_generators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DownloadManager</span><span class="p">,</span> <span class="n">StreamingDownloadManager</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specify feature dictionary generators and dataset splits.</span>

<span class="sd">        This function returns a list of `SplitGenerator`s defining how to generate</span>
<span class="sd">        data and what splits to use.</span>

<span class="sd">        Example:</span>

<span class="sd">            return [</span>
<span class="sd">                    datasets.SplitGenerator(</span>
<span class="sd">                            name=datasets.Split.TRAIN,</span>
<span class="sd">                            gen_kwargs={&#39;file&#39;: &#39;train_data.zip&#39;},</span>
<span class="sd">                    ),</span>
<span class="sd">                    datasets.SplitGenerator(</span>
<span class="sd">                            name=datasets.Split.TEST,</span>
<span class="sd">                            gen_kwargs={&#39;file&#39;: &#39;test_data.zip&#39;},</span>
<span class="sd">                    ),</span>
<span class="sd">            ]</span>

<span class="sd">        The above code will first call `_generate_examples(file=&#39;train_data.zip&#39;)`</span>
<span class="sd">        to write the train data, then `_generate_examples(file=&#39;test_data.zip&#39;)` to</span>
<span class="sd">        write the test data.</span>

<span class="sd">        Datasets are typically split into different subsets to be used at various</span>
<span class="sd">        stages of training and evaluation.</span>

<span class="sd">        Note that for datasets without a `VALIDATION` split, you can use a</span>
<span class="sd">        fraction of the `TRAIN` data for evaluation as you iterate on your model</span>
<span class="sd">        so as not to overfit to the `TEST` data.</span>

<span class="sd">        For downloads and extractions, use the given `download_manager`.</span>
<span class="sd">        Note that the `DownloadManager` caches downloads, so it is fine to have each</span>
<span class="sd">        generator attempt to download the source data.</span>

<span class="sd">        A good practice is to download all data in this function, and then</span>
<span class="sd">        distribute the relevant parts to each split with the `gen_kwargs` argument</span>

<span class="sd">        Args:</span>
<span class="sd">            dl_manager (`Union[DownloadManager, StreamingDownloadManager]`):</span>
<span class="sd">                Download manager to download the data</span>

<span class="sd">        Returns:</span>
<span class="sd">            `list&lt;SplitGenerator&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">,</span>
        <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the examples and record them on disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            split_generator (`SplitGenerator`):</span>
<span class="sd">                Split generator to process</span>
<span class="sd">            file_format (`str`, *optional*):</span>
<span class="sd">                format of the data files in which the dataset will be written.</span>
<span class="sd">                Supported formats: &quot;arrow&quot;, &quot;parquet&quot;. Default to &quot;arrow&quot; format.</span>
<span class="sd">            max_shard_size (`Union[str, int]`, *optional*):</span>
<span class="sd">                Maximum number of bytes written per shard, default is &quot;500MB&quot;.</span>
<span class="sd">                The size is based on uncompressed data size, so in practice your shard files may be smaller than</span>
<span class="sd">                `max_shard_size` thanks to Parquet compression for example.</span>
<span class="sd">            num_proc (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Number of processes when downloading and generating the dataset locally.</span>
<span class="sd">                Multiprocessing is disabled by default.</span>

<span class="sd">                &lt;Added version=&quot;2.7.0&quot;/&gt;</span>
<span class="sd">            **kwargs: Additional kwargs forwarded from _download_and_prepare</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_examples_iterable_for_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExamplesIterable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the examples on the fly.</span>

<span class="sd">        Args:</span>
<span class="sd">            split_generator (`SplitGenerator`):</span>
<span class="sd">                Split generator to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>



<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Key</span><span class="p">:</span>
    <span class="n">original_shard_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">item_or_batch_id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">original_shard_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_or_batch_id</span><span class="p">))</span>


<div class="viewcode-block" id="GeneratorBasedBuilder">
<a class="viewcode-back" href="../../api/generated/datasets.GeneratorBasedBuilder.html#datasets.GeneratorBasedBuilder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GeneratorBasedBuilder</span><span class="p">(</span><span class="n">DatasetBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for datasets with data generation based on dict generators.</span>

<span class="sd">    `GeneratorBasedBuilder` is a convenience class that abstracts away much</span>
<span class="sd">    of the data writing and reading of `DatasetBuilder`. It expects subclasses to</span>
<span class="sd">    implement generators of feature dictionaries across the dataset splits</span>
<span class="sd">    (`_split_generators`). See the method docstrings for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default function generating examples for each `SplitGenerator`.</span>

<span class="sd">        This function preprocess the examples from the raw data to the preprocessed</span>
<span class="sd">        dataset files.</span>
<span class="sd">        This function is called once for each `SplitGenerator` defined in</span>
<span class="sd">        `_split_generators`. The examples yielded here will be written on</span>
<span class="sd">        disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (additional keyword arguments):</span>
<span class="sd">                Arguments forwarded from the SplitGenerator.gen_kwargs</span>

<span class="sd">        Yields:</span>
<span class="sd">            key: `str` or `int`, a unique deterministic example identification key.</span>
<span class="sd">                * Unique: An error will be raised if two examples are yield with the</span>
<span class="sd">                    same key.</span>
<span class="sd">                * Deterministic: When generating the dataset twice, the same example</span>
<span class="sd">                    should have the same key.</span>
<span class="sd">                Good keys can be the image id, or line number if examples are extracted</span>
<span class="sd">                from a text file.</span>
<span class="sd">                The key will be hashed and sorted to shuffle examples deterministically,</span>
<span class="sd">                such as generating the dataset multiple times keep examples in the</span>
<span class="sd">                same order.</span>
<span class="sd">            example: `dict&lt;str feature_name, feature_value&gt;`, a feature dictionary</span>
<span class="sd">                ready to be encoded and written to disk. The example will be</span>
<span class="sd">                encoded with `self.info.features.encode_example({...})`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">,</span>
        <span class="n">file_format</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">max_shard_size</span> <span class="o">=</span> <span class="n">convert_file_size_to_int</span><span class="p">(</span><span class="n">max_shard_size</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_SHARD_SIZE</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_generator</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_info</span> <span class="o">=</span> <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span>

        <span class="n">SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;-JJJJJ-SSSSS-of-NNNNN&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split_generator</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">SUFFIX</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">and</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_original_shards</span> <span class="o">=</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_original_shards</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Setting num_proc from </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> back to 1 for the </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split to disable multiprocessing as it only contains one shard.&quot;</span>
                <span class="p">)</span>
                <span class="n">num_proc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">num_original_shards</span> <span class="o">&lt;</span> <span class="n">num_proc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Setting num_proc from </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">num_original_shards</span><span class="si">}</span><span class="s2"> for the </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split as it only contains </span><span class="si">{</span><span class="n">num_original_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span>
                <span class="p">)</span>
                <span class="n">num_proc</span> <span class="o">=</span> <span class="n">num_original_shards</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">hf_tqdm</span><span class="p">(</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; examples&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_examples</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_prepare_split_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fpath&quot;</span><span class="p">:</span> <span class="n">fpath</span><span class="p">,</span>
            <span class="s2">&quot;file_format&quot;</span><span class="p">:</span> <span class="n">file_format</span><span class="p">,</span>
            <span class="s2">&quot;max_shard_size&quot;</span><span class="p">:</span> <span class="n">max_shard_size</span><span class="p">,</span>
            <span class="s2">&quot;split_info&quot;</span><span class="p">:</span> <span class="n">split_info</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_proc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_split_single</span><span class="p">(</span>
                    <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">_prepare_split_args</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">content</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># wrapping everything into lists for consistency with the multiprocessed code path</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Failed to retrieve results from prepare_split&quot;</span>
            <span class="p">(</span>
                <span class="n">examples_per_job</span><span class="p">,</span>
                <span class="n">bytes_per_job</span><span class="p">,</span>
                <span class="n">features_per_job</span><span class="p">,</span>
                <span class="n">shards_per_job</span><span class="p">,</span>
                <span class="n">shard_lengths_per_job</span><span class="p">,</span>
                <span class="n">original_shards_per_job</span><span class="p">,</span>
                <span class="n">original_shard_lengths_per_job</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">([</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs_per_job</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;gen_kwargs&quot;</span><span class="p">:</span> <span class="n">gen_kwargs</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">_prepare_split_args</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">gen_kwargs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="n">num_proc</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">num_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_per_job</span><span class="p">)</span>

            <span class="n">examples_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">bytes_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">features_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">shards_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">shard_lengths_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">original_shards_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">original_shard_lengths_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>

            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">iflatmap_unordered</span><span class="p">(</span>
                        <span class="n">pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_split_single</span><span class="p">,</span> <span class="n">kwargs_iterable</span><span class="o">=</span><span class="n">kwargs_per_job</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                            <span class="c1"># the content is the result of the job</span>
                            <span class="p">(</span>
                                <span class="n">examples_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">bytes_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">features_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">shards_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">shard_lengths_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">original_shards_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">original_shard_lengths_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">content</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># the content is the number of examples progress update</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">examples_per_job</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to retrieve results from prepare_split: result list </span><span class="si">{</span><span class="n">examples_per_job</span><span class="si">}</span><span class="s2"> still contains None - at least one worker failed to return its results&quot;</span>
            <span class="p">)</span>

        <span class="n">total_shards</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">)</span>
        <span class="n">total_original_shards</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">original_shards_per_job</span><span class="p">)</span>
        <span class="n">total_num_examples</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">examples_per_job</span><span class="p">)</span>
        <span class="n">total_num_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bytes_per_job</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features_per_job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_examples</span> <span class="o">=</span> <span class="n">total_num_examples</span>
        <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_bytes</span> <span class="o">=</span> <span class="n">total_num_bytes</span>

        <span class="c1"># should rename everything at the end</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming </span><span class="si">{</span><span class="n">total_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># use the -SSSSS-of-NNNNN pattern</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_rename_shard</span><span class="p">(</span><span class="n">shard_and_job</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
                <span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">=</span> <span class="n">shard_and_job</span>
                <span class="n">global_shard_id</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">[:</span><span class="n">job_id</span><span class="p">])</span> <span class="o">+</span> <span class="n">shard_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span>
                    <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ-SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NNNNN&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_shards</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="n">shards_and_jobs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">num_shards</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shards</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">thread_map</span><span class="p">(</span><span class="n">_rename_shard</span><span class="p">,</span> <span class="n">shards_and_jobs</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

            <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">shard_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">shard_length</span> <span class="k">for</span> <span class="n">shard_lengths</span> <span class="ow">in</span> <span class="n">shard_lengths_per_job</span> <span class="k">for</span> <span class="n">shard_length</span> <span class="ow">in</span> <span class="n">shard_lengths</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># don&#39;t use any pattern</span>
            <span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span>
                <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">SUFFIX</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">total_original_shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">original_shard_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">original_shard_length</span>
                <span class="k">for</span> <span class="n">original_shard_lengths</span> <span class="ow">in</span> <span class="n">original_shard_lengths_per_job</span>
                <span class="k">for</span> <span class="n">original_shard_length</span> <span class="ow">in</span> <span class="n">original_shard_lengths</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_split_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">fpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">split_info</span><span class="p">:</span> <span class="n">SplitInfo</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Features</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_examples</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="n">writer_class</span> <span class="o">=</span> <span class="n">ParquetWriter</span> <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span> <span class="k">else</span> <span class="n">ArrowWriter</span>
        <span class="n">embed_local_files</span> <span class="o">=</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span>
        <span class="n">shard_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">original_shard_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_num_examples</span><span class="p">,</span> <span class="n">total_num_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">shard_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">original_shard_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_examples_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">writer_class</span><span class="p">(</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">writer_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_writer_batch_size</span><span class="p">,</span>
                <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
                <span class="n">embed_local_files</span><span class="o">=</span><span class="n">embed_local_files</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>  <span class="c1"># old custom builders may not use Key</span>
                        <span class="n">original_shard_id</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">original_shard_id</span>
                    <span class="k">if</span> <span class="n">max_shard_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">writer</span><span class="o">.</span><span class="n">_num_bytes</span> <span class="o">&gt;</span> <span class="n">max_shard_size</span><span class="p">:</span>
                        <span class="n">num_examples</span><span class="p">,</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_examples</span><span class="p">)</span>
                        <span class="n">total_num_examples</span> <span class="o">+=</span> <span class="n">num_examples</span>
                        <span class="n">total_num_bytes</span> <span class="o">+=</span> <span class="n">num_bytes</span>
                        <span class="n">shard_id</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">writer</span> <span class="o">=</span> <span class="n">writer_class</span><span class="p">(</span>
                            <span class="n">features</span><span class="o">=</span><span class="n">writer</span><span class="o">.</span><span class="n">_features</span><span class="p">,</span>
                            <span class="n">path</span><span class="o">=</span><span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="n">writer_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_writer_batch_size</span><span class="p">,</span>
                            <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
                            <span class="n">embed_local_files</span><span class="o">=</span><span class="n">embed_local_files</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">encode_example</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">record</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shard_lengths</span><span class="p">)</span> <span class="o">==</span> <span class="n">original_shard_id</span><span class="p">:</span>
                        <span class="n">original_shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">original_shard_lengths</span><span class="p">[</span><span class="n">original_shard_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">num_examples_progress_update</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_time</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">PBAR_REFRESH_TIME_INTERVAL</span><span class="p">:</span>
                        <span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num_examples_progress_update</span>
                        <span class="n">num_examples_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num_examples_progress_update</span>
                <span class="n">num_shards</span> <span class="o">=</span> <span class="n">shard_id</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">num_original_shards</span> <span class="o">=</span> <span class="n">original_shard_id</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">num_examples</span><span class="p">,</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_examples</span><span class="p">)</span>
                <span class="n">total_num_examples</span> <span class="o">+=</span> <span class="n">num_examples</span>
                <span class="n">total_num_bytes</span> <span class="o">+=</span> <span class="n">num_bytes</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Ignore the writer&#39;s error for no examples written to the file if this error was caused by the error in _generate_examples before the first example was yielded</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">SchemaInferenceError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">__context__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__context__</span>
            <span class="k">raise</span> <span class="n">DatasetGenerationError</span><span class="p">(</span><span class="s2">&quot;An error occurred while generating the dataset&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">job_id</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">total_num_examples</span><span class="p">,</span>
                <span class="n">total_num_bytes</span><span class="p">,</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">_features</span><span class="p">,</span>
                <span class="n">num_shards</span><span class="p">,</span>
                <span class="n">shard_lengths</span><span class="p">,</span>
                <span class="n">num_original_shards</span><span class="p">,</span>
                <span class="n">original_shard_lengths</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_download_and_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">,</span> <span class="n">verification_mode</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare_splits_kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_download_and_prepare</span><span class="p">(</span>
            <span class="n">dl_manager</span><span class="p">,</span>
            <span class="n">verification_mode</span><span class="p">,</span>
            <span class="o">**</span><span class="n">prepare_splits_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_examples_iterable_for_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExamplesIterable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_examples</span><span class="p">,</span> <span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="ArrowBasedBuilder">
<a class="viewcode-back" href="../../api/generated/datasets.ArrowBasedBuilder.html#datasets.ArrowBasedBuilder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArrowBasedBuilder</span><span class="p">(</span><span class="n">DatasetBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for datasets with data generation based on Arrow loading functions (CSV/JSON/Parquet).&quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default function generating examples for each `SplitGenerator`.</span>

<span class="sd">        This function preprocess the examples from the raw data to the preprocessed</span>
<span class="sd">        dataset files.</span>
<span class="sd">        This function is called once for each `SplitGenerator` defined in</span>
<span class="sd">        `_split_generators`. The examples yielded here will be written on</span>
<span class="sd">        disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (additional keyword arguments):</span>
<span class="sd">                Arguments forwarded from the SplitGenerator.gen_kwargs</span>

<span class="sd">        Yields:</span>
<span class="sd">            key: tuple[int, int] original_shard_id and table_idx within that shard</span>
<span class="sd">            example: `pyarrow.Table`, a feature table</span>
<span class="sd">                ready to be encoded and written to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">,</span>
        <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">max_shard_size</span> <span class="o">=</span> <span class="n">convert_file_size_to_int</span><span class="p">(</span><span class="n">max_shard_size</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_SHARD_SIZE</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">split_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_generator</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">split_info</span> <span class="o">=</span> <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span>

        <span class="n">SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;-JJJJJ-SSSSS-of-NNNNN&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">split_generator</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">SUFFIX</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">and</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_original_shards</span> <span class="o">=</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_original_shards</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Setting num_proc from </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> back to 1 for the </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split to disable multiprocessing as it only contains one shard.&quot;</span>
                <span class="p">)</span>
                <span class="n">num_proc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">num_original_shards</span> <span class="o">&lt;</span> <span class="n">num_proc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Setting num_proc from </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">num_original_shards</span><span class="si">}</span><span class="s2"> for the </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split as it only contains </span><span class="si">{</span><span class="n">num_original_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span>
                <span class="p">)</span>
                <span class="n">num_proc</span> <span class="o">=</span> <span class="n">num_original_shards</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">hf_tqdm</span><span class="p">(</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; examples&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_examples</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">split_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> split&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_prepare_split_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fpath&quot;</span><span class="p">:</span> <span class="n">fpath</span><span class="p">,</span>
            <span class="s2">&quot;file_format&quot;</span><span class="p">:</span> <span class="n">file_format</span><span class="p">,</span>
            <span class="s2">&quot;max_shard_size&quot;</span><span class="p">:</span> <span class="n">max_shard_size</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_proc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_split_single</span><span class="p">(</span>
                    <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">_prepare_split_args</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">content</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># wrapping everything into lists for consistency with the multiprocessed code path</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Failed to retrieve results from prepare_split&quot;</span>
            <span class="p">(</span>
                <span class="n">examples_per_job</span><span class="p">,</span>
                <span class="n">bytes_per_job</span><span class="p">,</span>
                <span class="n">features_per_job</span><span class="p">,</span>
                <span class="n">shards_per_job</span><span class="p">,</span>
                <span class="n">shard_lengths_per_job</span><span class="p">,</span>
                <span class="n">original_shards_per_job</span><span class="p">,</span>
                <span class="n">original_shard_lengths_per_job</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">([</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs_per_job</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;gen_kwargs&quot;</span><span class="p">:</span> <span class="n">gen_kwargs</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">_prepare_split_args</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">gen_kwargs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="n">num_proc</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">num_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_per_job</span><span class="p">)</span>

            <span class="n">examples_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">bytes_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">features_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">shards_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">shard_lengths_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">original_shards_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>
            <span class="n">original_shard_lengths_per_job</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_jobs</span>

            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">iflatmap_unordered</span><span class="p">(</span>
                        <span class="n">pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_split_single</span><span class="p">,</span> <span class="n">kwargs_iterable</span><span class="o">=</span><span class="n">kwargs_per_job</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                            <span class="c1"># the content is the result of the job</span>
                            <span class="p">(</span>
                                <span class="n">examples_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">bytes_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">features_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">shards_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">shard_lengths_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">original_shards_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                                <span class="n">original_shard_lengths_per_job</span><span class="p">[</span><span class="n">job_id</span><span class="p">],</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">content</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># the content is the number of examples progress update</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">examples_per_job</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to retrieve results from prepare_split: result list </span><span class="si">{</span><span class="n">examples_per_job</span><span class="si">}</span><span class="s2"> still contains None - at least one worker failed to return its results&quot;</span>
            <span class="p">)</span>

        <span class="n">total_shards</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">)</span>
        <span class="n">total_original_shards</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">original_shards_per_job</span><span class="p">)</span>
        <span class="n">total_num_examples</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">examples_per_job</span><span class="p">)</span>
        <span class="n">total_num_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bytes_per_job</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features_per_job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_examples</span> <span class="o">=</span> <span class="n">total_num_examples</span>
        <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">num_bytes</span> <span class="o">=</span> <span class="n">total_num_bytes</span>

        <span class="c1"># should rename everything at the end</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming </span><span class="si">{</span><span class="n">total_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># use the -SSSSS-of-NNNNN pattern</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_rename_shard</span><span class="p">(</span><span class="n">shard_id_and_job</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
                <span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">=</span> <span class="n">shard_id_and_job</span>
                <span class="n">global_shard_id</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">[:</span><span class="n">job_id</span><span class="p">])</span> <span class="o">+</span> <span class="n">shard_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span>
                    <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ-SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NNNNN&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_shards</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="n">shard_ids_and_jobs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">num_shards</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shards_per_job</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shards</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">thread_map</span><span class="p">(</span><span class="n">_rename_shard</span><span class="p">,</span> <span class="n">shard_ids_and_jobs</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

            <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">shard_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">shard_length</span> <span class="k">for</span> <span class="n">shard_lengths</span> <span class="ow">in</span> <span class="n">shard_lengths_per_job</span> <span class="k">for</span> <span class="n">shard_length</span> <span class="ow">in</span> <span class="n">shard_lengths</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># don&#39;t use any pattern</span>
            <span class="n">shard_id</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span>
                <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">SUFFIX</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">total_original_shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split_generator</span><span class="o">.</span><span class="n">split_info</span><span class="o">.</span><span class="n">original_shard_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">original_shard_length</span>
                <span class="k">for</span> <span class="n">original_shard_lengths</span> <span class="ow">in</span> <span class="n">original_shard_lengths_per_job</span>
                <span class="k">for</span> <span class="n">original_shard_length</span> <span class="ow">in</span> <span class="n">original_shard_lengths</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_split_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_shard_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Features</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tracked_list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_tables</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="n">writer_class</span> <span class="o">=</span> <span class="n">ParquetWriter</span> <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span> <span class="k">else</span> <span class="n">ArrowWriter</span>
        <span class="n">embed_local_files</span> <span class="o">=</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span>
        <span class="n">shard_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">original_shard_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_num_examples</span><span class="p">,</span> <span class="n">total_num_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">shard_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">original_shard_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_examples_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">writer_class</span><span class="p">(</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">writer_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_writer_batch_size</span><span class="p">,</span>
                <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
                <span class="n">embed_local_files</span><span class="o">=</span><span class="n">embed_local_files</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>  <span class="c1"># old custom builders may not use Key</span>
                        <span class="n">original_shard_id</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">original_shard_id</span>
                    <span class="k">if</span> <span class="n">max_shard_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">writer</span><span class="o">.</span><span class="n">_num_bytes</span> <span class="o">&gt;</span> <span class="n">max_shard_size</span><span class="p">:</span>
                        <span class="n">num_examples</span><span class="p">,</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_examples</span><span class="p">)</span>
                        <span class="n">total_num_examples</span> <span class="o">+=</span> <span class="n">num_examples</span>
                        <span class="n">total_num_bytes</span> <span class="o">+=</span> <span class="n">num_bytes</span>
                        <span class="n">shard_id</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">writer</span> <span class="o">=</span> <span class="n">writer_class</span><span class="p">(</span>
                            <span class="n">features</span><span class="o">=</span><span class="n">writer</span><span class="o">.</span><span class="n">_features</span><span class="p">,</span>
                            <span class="n">path</span><span class="o">=</span><span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSSSS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shard_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JJJJJ&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="n">writer_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_writer_batch_size</span><span class="p">,</span>
                            <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
                            <span class="n">embed_local_files</span><span class="o">=</span><span class="n">embed_local_files</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">CastError</span> <span class="k">as</span> <span class="n">cast_error</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">DatasetGenerationCastError</span><span class="o">.</span><span class="n">from_cast_error</span><span class="p">(</span>
                            <span class="n">cast_error</span><span class="o">=</span><span class="n">cast_error</span><span class="p">,</span>
                            <span class="n">builder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">builder_name</span><span class="p">,</span>
                            <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
                            <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shard_lengths</span><span class="p">)</span> <span class="o">==</span> <span class="n">original_shard_id</span><span class="p">:</span>
                        <span class="n">original_shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">original_shard_lengths</span><span class="p">[</span><span class="n">original_shard_id</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="n">num_examples_progress_update</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_time</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">PBAR_REFRESH_TIME_INTERVAL</span><span class="p">:</span>
                        <span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num_examples_progress_update</span>
                        <span class="n">num_examples_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num_examples_progress_update</span>
                <span class="n">num_shards</span> <span class="o">=</span> <span class="n">shard_id</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">num_original_shards</span> <span class="o">=</span> <span class="n">original_shard_id</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">num_examples</span><span class="p">,</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">shard_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_examples</span><span class="p">)</span>
                <span class="n">total_num_examples</span> <span class="o">+=</span> <span class="n">num_examples</span>
                <span class="n">total_num_bytes</span> <span class="o">+=</span> <span class="n">num_bytes</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Ignore the writer&#39;s error for no examples written to the file if this error was caused by the error in _generate_examples before the first example was yielded</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">SchemaInferenceError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">__context__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__context__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">DatasetGenerationError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="n">DatasetGenerationError</span><span class="p">(</span><span class="s2">&quot;An error occurred while generating the dataset&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">job_id</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">total_num_examples</span><span class="p">,</span>
                <span class="n">total_num_bytes</span><span class="p">,</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">_features</span><span class="p">,</span>
                <span class="n">num_shards</span><span class="p">,</span>
                <span class="n">shard_lengths</span><span class="p">,</span>
                <span class="n">num_original_shards</span><span class="p">,</span>
                <span class="n">original_shard_lengths</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_examples_iterable_for_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_generator</span><span class="p">:</span> <span class="n">SplitGenerator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExamplesIterable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ArrowExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_tables</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">split_generator</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2025, HuggingFace Inc..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>