
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>datasets.iterable_dataset &#8212; Datasets 4.4.2.dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=564b2b0d" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=62d5458c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=fd10adb8"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/datasets/iterable_dataset';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="4.4.2.dev0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ðŸ¤— Datasets</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../howto.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../concepts.html">
    Conceptual Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/huggingface/datasets" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://huggingface.co/datasets" title="Hugging Face" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Hugging Face</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../howto.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../concepts.html">
    Conceptual Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/huggingface/datasets" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://huggingface.co/datasets" title="Hugging Face" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Hugging Face</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">datasets.iterable_dataset</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for datasets.iterable_dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fnmatch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing.pool</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">islice</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">fsspec.asyn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CommitInfo</span><span class="p">,</span>
    <span class="n">CommitOperationAdd</span><span class="p">,</span>
    <span class="n">CommitOperationDelete</span><span class="p">,</span>
    <span class="n">DatasetCard</span><span class="p">,</span>
    <span class="n">DatasetCardData</span><span class="p">,</span>
    <span class="n">HfApi</span><span class="p">,</span>
    <span class="n">HfFileSystem</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub.hf_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">RepoFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">HfHubHTTPError</span><span class="p">,</span> <span class="n">RepositoryNotFoundError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">PUSH_TO_HUB_WITHOUT_METADATA_CONFIGS_SPLIT_PATTERN_SHARDED</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DatasetInfoMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.data_files</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_patterns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">Features</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.features.features</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">FeatureType</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Value</span><span class="p">,</span>
    <span class="n">_align_features</span><span class="p">,</span>
    <span class="n">_check_if_features_can_be_aligned</span><span class="p">,</span>
    <span class="n">_fix_for_backward_compatible_features</span><span class="p">,</span>
    <span class="n">_visit</span><span class="p">,</span>
    <span class="n">cast_to_python_objects</span><span class="p">,</span>
    <span class="n">require_decoding</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.formatting</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ArrowFormatter</span><span class="p">,</span>
    <span class="n">PythonFormatter</span><span class="p">,</span>
    <span class="n">TableFormatter</span><span class="p">,</span>
    <span class="n">TensorFormatter</span><span class="p">,</span>
    <span class="n">get_format_type_from_alias</span><span class="p">,</span>
    <span class="n">get_formatter</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.info</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetInfo</span><span class="p">,</span> <span class="n">DatasetInfosDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.naming</span><span class="w"> </span><span class="kn">import</span> <span class="n">_split_re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.splits</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedSplit</span><span class="p">,</span> <span class="n">Split</span><span class="p">,</span> <span class="n">SplitDict</span><span class="p">,</span> <span class="n">SplitInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast_table_to_features</span><span class="p">,</span> <span class="n">embed_table_storage</span><span class="p">,</span> <span class="n">read_schema_from_file</span><span class="p">,</span> <span class="n">table_cast</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">hf_tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetadataConfigs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.py_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">glob_pattern_to_regex</span><span class="p">,</span> <span class="n">iflatmap_unordered</span><span class="p">,</span> <span class="n">string_to_dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.sharding</span><span class="w"> </span><span class="kn">import</span> <span class="n">_merge_gen_kwargs</span><span class="p">,</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">,</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">,</span> <span class="n">_split_gen_kwargs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathLike</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">.builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">Key</span> <span class="k">as</span> <span class="n">BuilderKey</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">Key</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;BuilderKey&quot;</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">identity_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_rename_columns_fn</span><span class="p">(</span><span class="n">example</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">column_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">example</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_mapping</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error when renaming </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">column_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2">: columns </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">example</span><span class="p">)</span><span class="si">}</span><span class="s2"> are not in the dataset.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">example</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error when renaming </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">column_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2">: columns </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">example</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">column_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2"> are already in the dataset.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">new_column_name</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="n">original_column_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">original_column_name</span><span class="p">,</span> <span class="n">new_column_name</span> <span class="ow">in</span> <span class="n">column_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_column_fn</span><span class="p">(</span><span class="n">example</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">example</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error when adding </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: column </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already in the dataset.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">column</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_infer_features_from_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">try_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Features</span><span class="p">:</span>
    <span class="n">pa_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pydict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">try_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pa_table</span> <span class="o">=</span> <span class="n">table_cast</span><span class="p">(</span><span class="n">pa_table</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">try_features</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ArrowInvalid</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ArrowNotImplementedError</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">Features</span><span class="o">.</span><span class="n">from_arrow_schema</span><span class="p">(</span><span class="n">pa_table</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_examples_to_batch</span><span class="p">(</span><span class="n">examples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="c1"># we order the columns by order of appearance</span>
    <span class="c1"># to do so, we use a dict as an ordered set</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">example</span><span class="p">}</span>
    <span class="c1"># when an example is missing a column, we set the value to None with .get()</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[[</span><span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">arrays</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_batch_to_examples</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a batch (dict of examples) to examples list&quot;&quot;&quot;</span>
    <span class="n">n_examples</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">batch</span><span class="p">))])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_arrow</span><span class="p">(</span>
    <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert and group examples in Arrow tables of size `batch_size`.</span>

<span class="sd">    Args:</span>
<span class="sd">        iterable (`Iterable[Tuple[Key, dict]]`):</span>
<span class="sd">            An examples iterable containing tuples (example_key, example) of type (int/str, dict)</span>
<span class="sd">        batch_size (`Optional[int]`):</span>
<span class="sd">            Size of each sub-table to yield. If None or &lt;= 0, yields the full table.</span>
<span class="sd">        drop_last_batch (`bool`, defaults to `False`):</span>
<span class="sd">            Drop the last batch if it is smaller than `batch_size`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pylist</span><span class="p">(</span><span class="n">cast_to_python_objects</span><span class="p">([</span><span class="n">example</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">],</span> <span class="n">only_1d_for_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="n">iterator_batch</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key_examples_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">example</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterator_batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_examples_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="n">drop_last_batch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">keys</span><span class="p">,</span> <span class="n">examples</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">key_examples_list</span><span class="p">)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pylist</span><span class="p">(</span><span class="n">cast_to_python_objects</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">only_1d_for_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">shift_ex_examples_rngs</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">:</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;We need to go through the ex_iterables recursively, create a new seed and return a new iterable, then set it to the containing ex_iterable.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_seed_recursively</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="s2">&quot;shift_rngs&quot;</span><span class="p">):</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">shift_rngs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="s2">&quot;ex_iterable&quot;</span><span class="p">):</span>
            <span class="n">ex_iterable</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">set_seed_recursively</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ex_iterable</span>

    <span class="k">return</span> <span class="n">set_seed_recursively</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_BaseExamplesIterable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for the examples iterable used by an IterableDataset&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An examples iterable should yield tuples (example_key, example) of type (int/str, dict)&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t implement __iter__ yet&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]]]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Either shuffle the shards/sources of the dataset, or propagate the shuffling to the underlying iterable.</span>
<span class="sd">        If the order of the shards must stay fixed (when using .skip or .take for example), then this method returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t implement shuffle_data_sources yet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Either keep only the requested shard, or propagate the request to the underlying iterable.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t implement shard_data_sources yet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split_shard_indices_by_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="n">div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">//</span> <span class="n">num_shards</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">%</span> <span class="n">num_shards</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">div</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">div</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">mod</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t implement num_shards yet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t implement _init_state_dict yet&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_inner_load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">new_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_state</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_inner_load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">state</span>
            <span class="k">elif</span> <span class="n">new_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)):</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_inner_load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_state</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">state</span>
            <span class="k">return</span> <span class="n">new_state</span>

        <span class="k">return</span> <span class="n">_inner_load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;State dict is not initialized, please call ex_iterable._init_state_dict() first.&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_examples_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]],</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span> <span class="o">=</span> <span class="n">generate_examples_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;shard_example_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key_example</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">),</span> <span class="n">shard_example_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">yield</span> <span class="n">key_example</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ShuffledDataSourcesExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="n">gen_kwargs_list</span> <span class="o">=</span> <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">)</span>
        <span class="n">shard_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_shard_indices_by_worker</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="n">requested_gen_kwargs</span> <span class="o">=</span> <span class="n">_merge_gen_kwargs</span><span class="p">([</span><span class="n">gen_kwargs_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shard_indices</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">,</span> <span class="n">requested_gen_kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ShuffledDataSourcesExamplesIterable</span><span class="p">(</span><span class="n">ExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">generate_examples_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]],</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">generate_examples_fn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shift_rngs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">ShuffledDataSourcesExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;shard_example_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the kwargs order to shuffle shards&quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">kwargs_with_shuffled_shards</span> <span class="o">=</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span>
            <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="n">kwargs_with_shuffled_shards</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key_example</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">),</span> <span class="n">shard_example_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">yield</span> <span class="n">key_example</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">kwargs_with_shuffled_shards</span> <span class="o">=</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">,</span> <span class="n">kwargs_with_shuffled_shards</span><span class="p">)</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span>
            <span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArrowExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_tables_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]],</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span> <span class="o">=</span> <span class="n">generate_tables_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;shard_example_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">PythonFormatter</span><span class="p">()</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">shard_example_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                    <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">pa_subtable</span> <span class="ow">in</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">to_reader</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ARROW_READER_BATCH_SIZE_IN_DATASET_ITER</span><span class="p">):</span>
                    <span class="n">formatted_batch</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_batch</span><span class="p">(</span><span class="n">pa_subtable</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">_batch_to_examples</span><span class="p">(</span><span class="n">formatted_batch</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">&gt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span>
                        <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">shard_example_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">):</span>
                <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">&lt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ArrowExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ShuffledDataSourcesArrowExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ArrowExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="n">gen_kwargs_list</span> <span class="o">=</span> <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">)</span>
        <span class="n">shard_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_shard_indices_by_worker</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="n">requested_gen_kwargs</span> <span class="o">=</span> <span class="n">_merge_gen_kwargs</span><span class="p">([</span><span class="n">gen_kwargs_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shard_indices</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ArrowExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">,</span> <span class="n">requested_gen_kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_number_of_shards_in_gen_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ShuffledDataSourcesArrowExamplesIterable</span><span class="p">(</span><span class="n">ArrowExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">generate_tables_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]],</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">generate_tables_fn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shift_rngs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">ShuffledDataSourcesArrowExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_examples_fn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;shard_example_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the kwargs order to shuffle shards&quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">kwargs_with_shuffled_shards</span> <span class="o">=</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">PythonFormatter</span><span class="p">()</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span>
            <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="n">kwargs_with_shuffled_shards</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">shard_example_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                    <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">pa_subtable</span> <span class="ow">in</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">to_reader</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ARROW_READER_BATCH_SIZE_IN_DATASET_ITER</span><span class="p">):</span>
                    <span class="n">formatted_batch</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_batch</span><span class="p">(</span><span class="n">pa_subtable</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">_batch_to_examples</span><span class="p">(</span><span class="n">formatted_batch</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">&gt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span>
                        <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">kwargs_with_shuffled_shards</span> <span class="o">=</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">shard_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gen_kwags</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span>
            <span class="n">_split_gen_kwargs</span><span class="p">(</span><span class="n">kwargs_with_shuffled_shards</span><span class="p">,</span> <span class="n">max_num_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">),</span> <span class="n">shard_idx_start</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">shard_example_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">shard_example_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwags</span><span class="p">):</span>
                <span class="n">shard_example_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shard_example_idx</span> <span class="o">&lt;=</span> <span class="n">shard_example_idx_start</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;shard_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ArrowExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">kwargs_with_shuffled_shards</span> <span class="o">=</span> <span class="n">_shuffle_gen_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ArrowExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_tables_fn</span><span class="p">,</span> <span class="n">kwargs_with_shuffled_shards</span><span class="p">)</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span>
            <span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RebatchedArrowExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span> <span class="o">=</span> <span class="n">drop_last_batch</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;previous_state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;batch_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;cropped_chunk_length&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over sub-tables of size `batch_size`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">_convert_to_arrow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;batch_idx&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">all_pa_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">([</span><span class="n">pa_table</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;batch_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">all_pa_table</span>
            <span class="k">return</span>
        <span class="n">keys_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chunks_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chunks_buffer_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_chunks_to_skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">chunk_length_to_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;cropped_chunk_length&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num_chunks_since_previous_state</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pa_table</span><span class="o">.</span><span class="n">to_reader</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">num_chunks_to_skip</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">num_chunks_to_skip</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">num_chunks_to_skip</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">chunk_length_to_crop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">num_chunks_to_skip</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">num_chunks_to_skip</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">chunk_length_to_crop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">chunk_length_to_crop</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="n">chunk_length_to_crop</span><span class="p">)</span>
                    <span class="n">num_chunks_to_skip</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">chunk_length_to_crop</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">chunks_buffer_size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                    <span class="n">keys_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">chunks_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">chunks_buffer_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">chunks_buffer_size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                    <span class="n">keys_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">chunks_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">keys_buffer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;batch_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks_buffer</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;cropped_chunk_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">yield</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_batches</span><span class="p">(</span><span class="n">chunks_buffer</span><span class="p">)</span>
                    <span class="n">keys_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">chunks_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">chunks_buffer_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_chunks_since_previous_state</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cropped_chunk_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="n">chunks_buffer_size</span>
                    <span class="n">keys_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">[:</span><span class="si">{</span><span class="n">cropped_chunk_length</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="n">chunks_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cropped_chunk_length</span><span class="p">))</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">keys_buffer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;batch_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks_buffer</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;cropped_chunk_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_chunk_length</span>
                    <span class="k">yield</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_batches</span><span class="p">(</span><span class="n">chunks_buffer</span><span class="p">)</span>
                    <span class="n">keys_buffer</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">cropped_chunk_length</span><span class="si">}</span><span class="s2">:]&quot;</span><span class="p">]</span>
                    <span class="n">chunks_buffer</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">cropped_chunk_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="n">cropped_chunk_length</span><span class="p">)]</span>
                    <span class="n">chunks_buffer_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="n">cropped_chunk_length</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_chunks_since_previous_state</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span> <span class="ow">and</span> <span class="n">chunks_buffer</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">keys_buffer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;batch_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_chunks_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;cropped_chunk_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">yield</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_batches</span><span class="p">(</span><span class="n">chunks_buffer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RebatchedArrowExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RebatchedArrowExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SelectColumnsIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span> <span class="o">=</span> <span class="n">column_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">idx</span><span class="p">,</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># empty tables have no schema</span>
                <span class="k">yield</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SelectColumnsIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SelectColumnsIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SelectColumnsIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SelectColumnsIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">StepExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="c1"># TODO(QL): implement iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">ex_iterator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StepExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StepExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StepExamplesIterable&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StepExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_BaseExamplesIterable</span><span class="p">],</span>
        <span class="n">stopping_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted_without_replacement&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span> <span class="o">=</span> <span class="n">ex_iterables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span> <span class="o">=</span> <span class="n">stopping_strategy</span>

        <span class="c1"># if undersampling (&quot;first_exhausted&quot;), we stop as soon as one dataset is exhausted</span>
        <span class="c1"># if oversampling (&quot;all_exhausted&quot;), we stop as soons as every dataset is exhausted, i.e as soon as every samples of every dataset has been visited at least once</span>
        <span class="c1"># if sampling without replacement (&quot;all_exhausted_without_replacement&quot;), we stop once all samples of every dataset has been visited exactly once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bool_strategy_func</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span> <span class="k">if</span> <span class="p">(</span><span class="n">stopping_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted_without_replacement&quot;</span><span class="p">))</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Can iterate on arrow tables if all ex_iterables can iterate</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_indices_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this is an infinite iterator to keep track of which iterator we want to pick examples from</span>
        <span class="n">ex_iterable_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">next_ex_iterable_idx</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">cycle</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">))),</span> <span class="n">ex_iterable_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_ex_iterable_idx</span>
            <span class="k">yield</span> <span class="n">ex_iterable_idx</span>
            <span class="n">ex_iterable_idx</span> <span class="o">=</span> <span class="n">next_ex_iterable_idx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ex_iterables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">],</span>
            <span class="s2">&quot;previous_states&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span>
            <span class="s2">&quot;is_exhausted&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we use this to buffer one example of each iterator to know if an iterator is exhausted</span>
        <span class="n">nexts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span>
        <span class="c1"># because of that, we need to rewind 1 example when reloading the state dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">iterators</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>

        <span class="n">indices_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_indices_iterator</span><span class="p">()</span>

        <span class="n">is_exhausted</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;is_exhausted&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices_iterator</span><span class="p">:</span>
            <span class="c1"># if the stopping criteria is met, break the main for loop</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bool_strategy_func</span><span class="p">(</span><span class="n">is_exhausted</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="c1"># Skip exhausted iterators if we sample without replacement</span>
            <span class="k">if</span> <span class="n">is_exhausted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all_exhausted_without_replacement&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="c1"># let&#39;s pick one example from the iterator at index i</span>
            <span class="k">if</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterables&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># the iterator is exhausted</span>
            <span class="k">if</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">is_exhausted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;is_exhausted&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># we reset it in case the stopping crtieria isn&#39;t met yet and we sample with replacement</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all_exhausted_without_replacement&quot;</span><span class="p">]:</span>
                    <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterables&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we use this to buffer one example of each iterator to know if an iterator is exhausted</span>
        <span class="n">nexts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span>
        <span class="c1"># because of that, we need to rewind 1 example when reloading the state dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">iterators</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>

        <span class="n">indices_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_indices_iterator</span><span class="p">()</span>

        <span class="n">is_exhausted</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;is_exhausted&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices_iterator</span><span class="p">:</span>
            <span class="c1"># if the stopping criteria is met, break the main for loop</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bool_strategy_func</span><span class="p">(</span><span class="n">is_exhausted</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="c1"># let&#39;s pick one example from the iterator at index i</span>
            <span class="k">if</span> <span class="n">is_exhausted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all_exhausted_without_replacement&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterables&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># the iterator is exhausted</span>
            <span class="k">if</span> <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">is_exhausted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;is_exhausted&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># we reset it in case the stopping crtieria isn&#39;t met yet</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all_exhausted_without_replacement&quot;</span><span class="p">]:</span>
                    <span class="n">nexts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterables&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_states&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">iterators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CyclingMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle each underlying examples iterable.&quot;&quot;&quot;</span>
        <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CyclingMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Either keep only the requested shard, or propagate the request to the underlying iterable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_shards</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span>
                <span class="p">],</span>
                <span class="n">stopping_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span>
                <span class="p">],</span>
                <span class="n">stopping_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[],</span>
                <span class="n">stopping_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VerticallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    VerticallyConcatenatedMultiSourcesExamplesIterable simply chains the input iterables.</span>
<span class="sd">    It doesn&#39;t require the examples iterables to always yield the same columns.</span>
<span class="sd">    Instead, this is handled by the `IterableDataset` class or `FormattedExamplesIterable`.</span>

<span class="sd">    For information, `IterableDataset` merges the features of all the datasets to concatenate into one.</span>
<span class="sd">    We use `IterableDataset._resolve_features` to obtain the features of all the datasets to concatenate.</span>

<span class="sd">    Then for each example, `IterableDataset` and `FormattedExamplesIterable` automatically fill missing columns with None.</span>
<span class="sd">    This is done with `_apply_feature_types_on_example`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_BaseExamplesIterable</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span> <span class="o">=</span> <span class="n">ex_iterables</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ex_iterables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">],</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterable_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">,</span> <span class="n">ex_iterable_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">ex_iterable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterable_idx_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">,</span> <span class="n">ex_iterable_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;ex_iterable_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;VerticallyConcatenatedMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the list of examples iterable, as well as each underlying examples iterable.&quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">ex_iterables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">)</span>
        <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="n">ex_iterables</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">VerticallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;VerticallyConcatenatedMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Either keep only the requested shard, or propagate the request to the underlying iterable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">VerticallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span>
            <span class="p">[</span><span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span> <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_check_column_names</span><span class="p">(</span><span class="n">column_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the column names to make sure they don&#39;t contain duplicates.&quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">duplicated_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">counter</span> <span class="k">if</span> <span class="n">counter</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The examples iterables can&#39;t have duplicated columns but columns </span><span class="si">{</span><span class="n">duplicated_columns</span><span class="si">}</span><span class="s2"> are duplicated.&quot;</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HorizontallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HorizontallyConcatenatedMultiSourcesExamplesIterable merges examples together for the input list of iterables.</span>
<span class="sd">    It also checks that there are no duplicate columns (otherwise we don&#39;t know which one to keep).</span>
<span class="sd">    This check is done once when yielding the first example.</span>

<span class="sd">    However it doesn&#39;t fill missing columns with None.</span>
<span class="sd">    Instead, this is handled by the `IterableDataset` class or `FormattedExamplesIterable`.</span>

<span class="sd">    For information, `IterableDataset` merges the features of all the datasets to concatenate into one.</span>
<span class="sd">    We use `IterableDataset._resolve_features` to obtain the features of all the datasets to concatenate.</span>

<span class="sd">    Then for each example, `IterableDataset` and `FormattedExamplesIterable` automatically fill missing columns with None.</span>
<span class="sd">    This is done with `_apply_feature_types_on_example`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_BaseExamplesIterable</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span> <span class="o">=</span> <span class="n">ex_iterables</span>
        <span class="c1"># TODO(QL): implement iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ex_iterables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">],</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterators</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ex_iterator</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ex_iterators</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ex_iterator</span><span class="p">)</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="n">ex_iterators</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ex_iterator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ex_iterators</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_check_column_names</span><span class="p">([</span><span class="n">column_name</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span> <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">example</span><span class="p">])</span>
                <span class="n">new_example</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
                    <span class="n">new_example</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">new_example</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;HorizontallyConcatenatedMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Doesn&#39;t shuffle the wrapped examples iterable since it would break the alignment between them.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;HorizontallyConcatenatedMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Either keep only the requested shard, or propagate the request to the underlying iterable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HorizontallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span>
            <span class="p">[</span><span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span> <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_BaseExamplesIterable</span><span class="p">],</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
        <span class="n">probabilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stopping_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted_without_replacement&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">,</span> <span class="n">stopping_strategy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span> <span class="o">=</span> <span class="n">probabilities</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shift_rngs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">),</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">stopping_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_indices_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">num_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">)</span>
        <span class="n">random_batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="c1"># this is an infinite iterator that randomly samples the index of the source to pick examples from</span>
        <span class="n">index_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_index_offset&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_state&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random_batch_size</span><span class="p">),</span> <span class="n">index_offset</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">index_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">random_batch_size</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_index_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_offset</span>
                        <span class="k">if</span> <span class="n">index_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span>
                    <span class="k">yield</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span>
                    <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">num_sources</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random_batch_size</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">),</span> <span class="n">index_offset</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">index_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">random_batch_size</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_index_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_offset</span>
                        <span class="k">if</span> <span class="n">index_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;bit_generator_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span>
                    <span class="k">yield</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bit_generator_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;bit_generator_index_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ex_iterables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">],</span>
            <span class="s2">&quot;previous_states&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span>
            <span class="s2">&quot;is_exhausted&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RandomlyCyclingMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the data sources of each wrapped examples iterable.&quot;&quot;&quot;</span>
        <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterables</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">stopping_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RandomlyCyclingMultiSourcesExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Either keep only the requested shard, or propagate the request to the underlying iterable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_shards</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span>
                <span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterables</span>
                <span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
                <span class="p">[],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stopping_strategy</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_table_output_to_arrow</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">POLARS_AVAILABLE</span> <span class="ow">and</span> <span class="s2">&quot;polars&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">to_arrow</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MappedExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">with_indices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">input_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">remove_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fn_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">formatting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;FormattingConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batched</span> <span class="o">=</span> <span class="n">batched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span> <span class="o">=</span> <span class="n">drop_last_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span> <span class="o">=</span> <span class="n">remove_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span> <span class="o">=</span> <span class="n">with_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span> <span class="o">=</span> <span class="n">input_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span> <span class="o">=</span> <span class="n">fn_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="o">=</span> <span class="n">formatting</span>  <span class="c1"># required for iter_arrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_num_running_async_map_functions_in_parallel</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_NUM_RUNNING_ASYNC_MAP_FUNCTIONS_IN_PARALLEL</span>
        <span class="p">)</span>
        <span class="c1"># sanity checks</span>
        <span class="k">if</span> <span class="n">formatting</span> <span class="ow">and</span> <span class="n">formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">:</span>
            <span class="c1"># batch_size should match for iter_arrow</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">formatting</span><span class="o">.</span><span class="n">format_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">-formatted </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has underlying iterable&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;that is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instead of a RebatchedArrowExamplesIterable.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">!=</span> <span class="p">(</span><span class="n">batch_size</span> <span class="k">if</span> <span class="n">batched</span> <span class="k">else</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">formatting</span><span class="o">.</span><span class="n">format_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">-formatted </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has batch_size=</span><span class="si">{</span><span class="n">batch_size</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">batched</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> which is&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;different from </span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">batch_size</span><span class="si">=}</span><span class="s2"> from its underlying iterable.&quot;</span>
                <span class="p">)</span>
        <span class="c1"># to enable graceful ends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owned_loops_and_tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># user has extracted features</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;previous_state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">PythonFormatter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_row</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">])</span>
            <span class="n">num_examples_to_skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_examples_to_skip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">)</span>

        <span class="c1"># We use the same logic as in Dataset.map, but with less features/formatting</span>
        <span class="c1"># since they&#39;re handled by FormattedExamplesIterable</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">)</span>
            <span class="n">format_dict</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">recursive_tensorize</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formatter</span><span class="p">,</span> <span class="n">TensorFormatter</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format_dict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iter_batched_inputs</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">current_idx</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="c1"># If `batched`, first build the batch, if `batch_size` is None or &lt;=0, then the batch is the whole dataset</span>
                <span class="n">iterator_batch</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">iterator</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">key_examples_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">example</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterator_batch</span><span class="p">)</span>
                <span class="n">keys</span><span class="p">,</span> <span class="n">examples</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">key_examples_list</span><span class="p">)</span>
                <span class="c1"># the new key is the concatenation of the examples keys from the batch</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="p">):</span>  <span class="c1"># ignore last batch</span>
                    <span class="k">return</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">_examples_to_batch</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
                <span class="c1"># we need to format here in case we need to stack tensors together</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">format_dict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="k">if</span> <span class="n">format_dict</span> <span class="k">else</span> <span class="n">batch</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">current_idx</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key_examples_list</span><span class="p">))]</span>
                <span class="n">current_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">indices</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iter_inputs</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">current_idx</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="c1"># If not batched, we can apply the transform and yield the example directly</span>
                <span class="c1"># first copy the example, since we might drop some keys</span>
                <span class="n">example</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
                <span class="c1"># no need to do formatting here</span>
                <span class="n">current_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">yield</span> <span class="n">current_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">example</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">validate_function_output</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span> <span class="ow">and</span> <span class="n">processed_inputs</span><span class="p">:</span>
                <span class="n">first_col</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">))</span>
                <span class="n">bad_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">processed_inputs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">[</span><span class="n">first_col</span><span class="p">])</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">bad_cols</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Column lengths mismatch: columns </span><span class="si">{</span><span class="n">bad_cols</span><span class="si">}</span><span class="s2"> have length </span><span class="si">{</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">bad_cols</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;while </span><span class="si">{</span><span class="n">first_col</span><span class="si">}</span><span class="s2"> has length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">[</span><span class="n">first_col</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_inputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="o">=</span> <span class="n">key_example</span>
            <span class="n">fn_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">]</span>
            <span class="n">additional_args</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">:</span>
                <span class="n">fn_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">indices</span><span class="p">,)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_outputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processed_inputs</span><span class="p">):</span>
            <span class="n">validate_function_output</span><span class="p">(</span><span class="n">processed_inputs</span><span class="p">)</span>
            <span class="c1"># this logic mimics the one in Dataset.map</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">inputs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">processed_inputs</span> <span class="ow">is</span> <span class="n">key_example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">processed_inputs</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">processed_inputs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">transformed_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">processed_inputs</span><span class="p">}</span>
            <span class="c1"># no need to do features decoding here</span>
            <span class="k">return</span> <span class="n">transformed_inputs</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">apply_function</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Utility to apply the function on a selection of columns.&quot;&quot;&quot;</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">,</span> <span class="n">fn_kwargs</span> <span class="o">=</span> <span class="n">prepare_inputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
            <span class="n">processed_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">fn_args</span><span class="p">,</span> <span class="o">*</span><span class="n">additional_args</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prepare_outputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processed_inputs</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_apply_function</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Utility to apply the function on a selection of columns. Same code but async&quot;&quot;&quot;</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">,</span> <span class="n">fn_kwargs</span> <span class="o">=</span> <span class="n">prepare_inputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
            <span class="n">processed_inputs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">fn_args</span><span class="p">,</span> <span class="o">*</span><span class="n">additional_args</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prepare_outputs</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processed_inputs</span><span class="p">)</span>

        <span class="n">tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owned_loops_and_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">loop</span><span class="p">,</span> <span class="n">tasks</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iter_outputs</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">loop</span>
            <span class="n">inputs_iterator</span> <span class="o">=</span> <span class="n">iter_batched_inputs</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span> <span class="k">else</span> <span class="n">iter_inputs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
                    <span class="n">previous_state_task</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">previous_state_example_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span>
                <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key_example</span> <span class="ow">in</span> <span class="n">inputs_iterator</span><span class="p">:</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">async_apply_function</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
                    <span class="c1"># keep the total active tasks under a certain number</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">:</span>
                        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
                            <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">while</span> <span class="n">tasks</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">:</span>
                            <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
                                <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">:</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># yield finished tasks</span>
                    <span class="k">while</span> <span class="n">tasks</span> <span class="ow">and</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="n">task</span> <span class="ow">is</span> <span class="n">previous_state_task</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state_example_idx</span>
                            <span class="n">previous_state</span><span class="p">,</span> <span class="n">previous_state_task</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="c1"># checkpoint</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="n">previous_state_task</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tasks</span><span class="p">:</span>
                        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                        <span class="n">previous_state_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">previous_state_example_idx</span> <span class="o">=</span> <span class="n">current_idx</span>
                <span class="k">while</span> <span class="n">tasks</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_idx</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key_example</span> <span class="ow">in</span> <span class="n">inputs_iterator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_idx</span>
                    <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">apply_function</span><span class="p">(</span><span class="n">key_example</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_idx</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">iter_outputs</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">:</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">transformed_example</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">transformed_batch</span> <span class="ow">in</span> <span class="n">outputs</span>
                    <span class="k">for</span> <span class="n">transformed_example</span> <span class="ow">in</span> <span class="n">_batch_to_examples</span><span class="p">(</span><span class="n">transformed_batch</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">transformed_example</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">num_examples_to_skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">num_examples_to_skip</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">transformed_example</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Canceling </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span><span class="si">}</span><span class="s2"> async tasks.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;KeyboardInterrupt&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tasks canceled.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_chunksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
        <span class="n">formatter</span><span class="p">:</span> <span class="n">TableFormatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="k">else</span> <span class="n">ArrowFormatter</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">_convert_to_arrow</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">drop_last_batch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">])</span>
            <span class="n">num_examples_to_skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_examples_to_skip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="n">max_chunksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batched</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span>
            <span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># first build the batch</span>
            <span class="n">function_args</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">formatter</span><span class="o">.</span><span class="n">format_batch</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="p">[</span><span class="n">pa_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">:</span>
                    <span class="n">function_args</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">current_idx</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">))])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">function_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_idx</span><span class="p">)</span>
            <span class="c1"># then apply the transform</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">function_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span><span class="p">)</span>
            <span class="n">output_table</span> <span class="o">=</span> <span class="n">_table_output_to_arrow</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_table</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Provided `function` which is applied to </span><span class="si">{</span><span class="n">formatter</span><span class="o">.</span><span class="n">table_type</span><span class="si">}</span><span class="s2"> returns a variable of type &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="s2">. Make sure provided `function` returns a </span><span class="si">{</span><span class="n">formatter</span><span class="o">.</span><span class="n">table_type</span><span class="si">}</span><span class="s2"> to update the dataset.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># we don&#39;t need to merge results for consistency with Dataset.map which merges iif both input and output are dicts</span>
            <span class="c1"># then remove the unwanted columns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">output_table</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
                        <span class="n">output_table</span> <span class="o">=</span> <span class="n">output_table</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="n">output_table</span><span class="o">.</span><span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
            <span class="c1"># return output</span>
            <span class="k">if</span> <span class="n">max_chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">output_table</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa_subtable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_table</span><span class="o">.</span><span class="n">to_reader</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="n">max_chunksize</span><span class="p">)):</span>
                    <span class="n">current_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">num_examples_to_skip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">num_examples_to_skip</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pa_subtable</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_examples_since_previous_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;previous_state_example_idx&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappedExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the wrapped examples iterable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MappedExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">drop_last_batch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span><span class="p">,</span>
            <span class="n">remove_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
            <span class="n">max_num_running_async_map_functions_in_parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappedExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MappedExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">drop_last_batch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_last_batch</span><span class="p">,</span>
            <span class="n">remove_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
            <span class="n">max_num_running_async_map_functions_in_parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_mask</span><span class="p">(</span>
    <span class="nb">input</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ChunkedArray</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">BooleanScalar</span><span class="p">],</span>
    <span class="n">mask_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ChunkedArray</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mask</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">bool_</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">input</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">mask_column_name</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">mask_column_name</span><span class="p">:</span> <span class="n">mask</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_mask</span><span class="p">(</span><span class="n">mask_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">mask_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_function</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_add_mask</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_column_name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_add_mask</span><span class="p">(</span>
    <span class="n">mask_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">mask_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="k">await</span> <span class="n">mask_function</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_add_mask</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_column_name</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FilteredExamplesIterable</span><span class="p">(</span><span class="n">MappedExamplesIterable</span><span class="p">):</span>
    <span class="n">mask_column_name</span> <span class="o">=</span> <span class="s2">&quot;===MASK===&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">with_indices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">input_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fn_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">formatting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;FormattingConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">({</span><span class="o">**</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_column_name</span><span class="p">:</span> <span class="n">Value</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">async_add_mask</span> <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="k">else</span> <span class="n">add_mask</span><span class="p">,</span>
                <span class="n">function</span><span class="p">,</span>
                <span class="n">mask_column_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_column_name</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="n">formatting</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_iter</span><span class="p">():</span>
            <span class="n">example</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">example</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_column_name</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_chunksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">(</span><span class="n">max_chunksize</span><span class="o">=</span><span class="n">max_chunksize</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">pa_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_column_name</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_column_name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;FilteredExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the wrapped examples iterable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FilteredExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FilteredExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FilteredExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BufferShuffledExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">generator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shift_rngs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_BaseExamplesIterable&quot;</span><span class="p">:</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">BufferShuffledExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_dict</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_state_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Loading a state dict of a shuffle buffer of a dataset without the buffer content.&quot;</span>
                    <span class="s2">&quot;The shuffle buffer will be refilled before starting to yield new examples.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_random_indices</span><span class="p">(</span><span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">random_batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">random_batch_size</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">indices_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_random_indices</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
        <span class="c1"># this is the shuffle buffer that we keep in memory</span>
        <span class="n">mem_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem_buffer</span><span class="p">)</span> <span class="o">==</span> <span class="n">buffer_size</span><span class="p">:</span>  <span class="c1"># if the buffer is full, pick and example from it</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">indices_iterator</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">mem_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">mem_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># replace the picked example by a new one</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># otherwise, keep filling the buffer</span>
                <span class="n">mem_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># when we run out of examples, we shuffle the remaining examples in the buffer and yield them</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">mem_buffer</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">mem_buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">indices_iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_random_indices</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
        <span class="c1"># this is the shuffle buffer that we keep in memory</span>
        <span class="n">mem_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem_buffer</span><span class="p">)</span> <span class="o">==</span> <span class="n">buffer_size</span><span class="p">:</span>  <span class="c1"># if the buffer is full, pick and example from it</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">indices_iterator</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">mem_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">mem_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span><span class="p">)</span>  <span class="c1"># replace the picked example by a new one</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># otherwise, keep filling the buffer</span>
                <span class="n">mem_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span><span class="p">))</span>
        <span class="c1"># when we run out of examples, we shuffle the remaining examples in the buffer and yield them</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">mem_buffer</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">mem_buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BufferShuffledExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the wrapped examples iterable as well as the shuffling buffer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BufferShuffledExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BufferShuffledExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BufferShuffledExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SkipExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">block_sources_order_when_shuffling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">split_when_sharding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span> <span class="o">=</span> <span class="n">block_sources_order_when_shuffling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span> <span class="o">=</span> <span class="n">split_when_sharding</span>
        <span class="c1"># TODO(QL): implement iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterable_idx_start</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield from</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">ex_iterable_idx_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_number</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">quotient</span> <span class="o">=</span> <span class="n">num</span> <span class="o">//</span> <span class="n">n</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">num</span> <span class="o">%</span> <span class="n">n</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">quotient</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">remainder</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SkipExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;May not shuffle the wrapped examples iterable since it would skip examples from other shards instead.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SkipExamplesIterable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">,</span>
                <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SkipExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SkipExamplesIterable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span>
                <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">,</span>
                <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RepeatExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterable that repeats the underlying iterable a given number of times.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">num_times</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_times</span> <span class="o">=</span> <span class="n">num_times</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;repeat_index&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repeat_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;repeat_index&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">repeat_index</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span>
            <span class="n">repeat_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;repeat_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_index</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;examples_iterable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RepeatExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the underlying iterable, then repeat.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RepeatExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="n">num_times</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_times</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RepeatExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shard, then repeat shards.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RepeatExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">num_times</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_times</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TakeExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">block_sources_order_when_shuffling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">split_when_sharding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span> <span class="o">=</span> <span class="n">block_sources_order_when_shuffling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span> <span class="o">=</span> <span class="n">split_when_sharding</span>
        <span class="c1"># TODO(QL): implement iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;num_taken&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterable_num_taken</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_taken&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key_example</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">ex_iterable_num_taken</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">[</span><span class="s2">&quot;num_taken&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="n">key_example</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_number</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">quotient</span> <span class="o">=</span> <span class="n">num</span> <span class="o">//</span> <span class="n">n</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">num</span> <span class="o">%</span> <span class="n">n</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">quotient</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">remainder</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TakeExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;May not shuffle the wrapped examples iterable since it would take examples from other shards instead.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TakeExamplesIterable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">,</span>
                <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TakeExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TakeExamplesIterable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span>
                <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">,</span>
                <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TakeExamplesIterable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_sources_order_when_shuffling</span><span class="p">,</span>
                <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_when_sharding</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_apply_feature_types_on_example</span><span class="p">(</span>
    <span class="n">example</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Features</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">example</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
    <span class="c1"># add missing columns</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">example</span><span class="p">:</span>
            <span class="n">example</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># we encode the example for ClassLabel feature types for example</span>
    <span class="n">encoded_example</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">encode_example</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
    <span class="c1"># Decode example for Audio feature, e.g.</span>
    <span class="n">decoded_example</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">decode_example</span><span class="p">(</span><span class="n">encoded_example</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">token_per_repo_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decoded_example</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_apply_feature_types_on_batch</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Features</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="c1"># add missing columns</span>
    <span class="n">n_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">batch</span><span class="p">))])</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">batch</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_examples</span>
    <span class="c1"># we encode the batch for ClassLabel feature types for example</span>
    <span class="n">encoded_batch</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="c1"># Decode batch for Audio feature, e.g.</span>
    <span class="n">decoded_batch</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span><span class="n">encoded_batch</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">token_per_repo_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decoded_batch</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FormattingConfig</span><span class="p">:</span>
    <span class="n">format_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_type</span><span class="p">),</span> <span class="n">TableFormatter</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_type</span><span class="p">),</span> <span class="n">TensorFormatter</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FormattedExamplesIterable</span><span class="p">(</span><span class="n">_BaseExamplesIterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">formatting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FormattingConfig</span><span class="p">],</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">],</span>
        <span class="n">token_per_repo_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="o">=</span> <span class="n">formatting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span> <span class="o">=</span> <span class="n">token_per_repo_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">PythonFormatter</span><span class="p">(</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
            <span class="c1"># feature casting (inc column addition) handled within self._iter_arrow()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">():</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_batch</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">_batch_to_examples</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format_dict</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">formatter</span><span class="o">.</span><span class="n">recursive_tensorize</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formatter</span><span class="p">,</span> <span class="n">TensorFormatter</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># cast in case features is None</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="p">:</span>
                <span class="c1"># don&#39;t apply feature types if already applied by ex_iterable (e.g. in case of chained with_format)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span><span class="p">:</span>
                    <span class="n">example</span> <span class="o">=</span> <span class="n">_apply_feature_types_on_example</span><span class="p">(</span>
                        <span class="n">example</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">format_dict</span><span class="p">:</span>
                    <span class="n">example</span> <span class="o">=</span> <span class="n">format_dict</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">_iter_arrow</span><span class="p">():</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pa_table</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">arrow_schema</span>
            <span class="c1"># add missing columns</span>
            <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">NullArray</span><span class="o">.</span><span class="n">from_buffers</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_table</span><span class="p">),</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
                    <span class="n">pa_table</span> <span class="o">=</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pa_table</span><span class="o">.</span><span class="n">schema</span> <span class="o">!=</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">pa_table</span> <span class="o">=</span> <span class="n">cast_table_to_features</span><span class="p">(</span><span class="n">pa_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FormattedExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the wrapped examples iterable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span>
            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shard_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FormattedExamplesIterable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the requested shard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">),</span>
            <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_per_repo_id</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ShufflingConfig</span><span class="p">:</span>
    <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span>
    <span class="n">_original_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DistributedConfig</span><span class="p">:</span>
    <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">world_size</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_add_torch_iterable_dataset_parent_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add torch.utils.data.IterableDataset as a parent class if &#39;torch&#39; is available&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">TORCH_AVAILABLE</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.data</span>

        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IterableDataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">+=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IterableDataset</span><span class="p">,)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_share_with_torch_persistent_workers</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;torch.Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;torch.Tensor&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">TORCH_AVAILABLE</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">share_memory_</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">share_memory_</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IterableColumn</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An iterable for a specific column of an [`IterableDataset`].</span>

<span class="sd">    Example:</span>

<span class="sd">    Iterate on the texts of the &quot;text&quot; column of a dataset:</span>

<span class="sd">    ```python</span>
<span class="sd">    for text in dataset[&quot;text&quot;]:</span>
<span class="sd">        ...</span>
<span class="sd">    ```</span>

<span class="sd">    It also works with nested columns:</span>

<span class="sd">    ```python</span>
<span class="sd">    for source in dataset[&quot;metadata&quot;][&quot;source&quot;]:</span>
<span class="sd">        ...</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;IterableDataset&quot;</span><span class="p">,</span> <span class="s2">&quot;IterableColumn&quot;</span><span class="p">],</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_name</span> <span class="o">=</span> <span class="n">column_name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">example</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableColumn&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IterableColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span>


<div class="viewcode-block" id="IterableDataset">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IterableDataset</span><span class="p">(</span><span class="n">DatasetInfoMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Dataset backed by an iterable.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ex_iterable</span><span class="p">:</span> <span class="n">_BaseExamplesIterable</span><span class="p">,</span>
        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NamedSplit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">formatting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FormattingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ShufflingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">distributed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DistributedConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token_per_repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">distributed</span> <span class="ow">and</span> <span class="n">distributed</span><span class="o">.</span><span class="n">world_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">shuffling</span> <span class="ow">and</span> <span class="n">shuffling</span><span class="o">.</span><span class="n">_original_seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The dataset doesn&#39;t have a fixed random seed across nodes to shuffle and split the list of dataset shards by node. &quot;</span>
                <span class="s2">&quot;Please pass e.g. `seed=42` in `.shuffle()` to make all the nodes use the same seed. &quot;</span>
            <span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DatasetInfo</span><span class="p">()</span>
        <span class="n">DatasetInfoMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="o">=</span> <span class="n">formatting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span> <span class="o">=</span> <span class="n">shuffling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="o">=</span> <span class="n">distributed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="n">token_per_repo_id</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;torch.Tensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_maybe_share_with_torch_persistent_workers</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hffs_cache</span> <span class="o">=</span> <span class="n">HfFileSystem</span><span class="o">.</span><span class="n">_cache</span>  <span class="c1"># keep the cache on pickling (e.g. for dataloader workers)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ex_iterable_for_iteration</span><span class="p">()</span>  <span class="c1"># set state_dict</span>
        <span class="n">_maybe_add_torch_iterable_dataset_parent_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>  <span class="c1"># subclass of torch IterableDataset</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of columns in the dataset.</span>
<span class="sd">        This can be None if the dataset has unknown features (e.g. after a map() operation).</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;validation&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ds.num_columns</span>
<span class="sd">        2</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Names of the columns in the dataset.</span>
<span class="sd">        This can be None if the dataset has unknown features (e.g. after a map() operation).</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;validation&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; ds.column_names</span>
<span class="sd">        [&#39;text&#39;, &#39;label&#39;]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

<div class="viewcode-block" id="IterableDataset.state_dict">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.state_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current state_dict of the dataset.</span>
<span class="sd">        It corresponds to the state at the latest example it yielded.</span>

<span class="sd">        Resuming returns exactly where the checkpoint was saved except in two cases:</span>

<span class="sd">        1. examples from shuffle buffers are lost when resuming and the buffers are refilled with new data</span>
<span class="sd">        2. combinations of `.with_format(arrow)` and batched `.map()` may skip one batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `dict`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import Dataset, concatenate_datasets</span>
<span class="sd">        &gt;&gt;&gt; ds = Dataset.from_dict({&quot;a&quot;: range(6)}).to_iterable_dataset(num_shards=3)</span>
<span class="sd">        &gt;&gt;&gt; for idx, example in enumerate(ds):</span>
<span class="sd">        ...     print(example)</span>
<span class="sd">        ...     if idx == 2:</span>
<span class="sd">        ...         state_dict = ds.state_dict()</span>
<span class="sd">        ...         print(&quot;checkpoint&quot;)</span>
<span class="sd">        ...         break</span>
<span class="sd">        &gt;&gt;&gt; ds.load_state_dict(state_dict)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;restart from checkpoint&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for example in ds:</span>
<span class="sd">        ...     print(example)</span>
<span class="sd">        ```</span>

<span class="sd">        which returns:</span>
<span class="sd">        ```</span>
<span class="sd">        {&#39;a&#39;: 0}</span>
<span class="sd">        {&#39;a&#39;: 1}</span>
<span class="sd">        {&#39;a&#39;: 2}</span>
<span class="sd">        checkpoint</span>
<span class="sd">        restart from checkpoint</span>
<span class="sd">        {&#39;a&#39;: 3}</span>
<span class="sd">        {&#39;a&#39;: 4}</span>
<span class="sd">        {&#39;a&#39;: 5}</span>
<span class="sd">        ```</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from torchdata.stateful_dataloader import StatefulDataLoader</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;deepmind/code_contests&quot;, streaming=True, split=&quot;train&quot;)</span>
<span class="sd">        &gt;&gt;&gt; dataloader = StatefulDataLoader(ds, batch_size=32, num_workers=4)</span>
<span class="sd">        &gt;&gt;&gt; # checkpoint</span>
<span class="sd">        &gt;&gt;&gt; state_dict = dataloader.state_dict()  # uses ds.state_dict() under the hood</span>
<span class="sd">        &gt;&gt;&gt; # resume from checkpoint</span>
<span class="sd">        &gt;&gt;&gt; dataloader.load_state_dict(state_dict)  # uses ds.load_state_dict() under the hood</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.load_state_dict">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.load_state_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the state_dict of the dataset.</span>
<span class="sd">        The iteration will restart at the next example from when the state was saved.</span>

<span class="sd">        Resuming returns exactly where the checkpoint was saved except in two cases:</span>

<span class="sd">        1. examples from shuffle buffers are lost when resuming and the buffers are refilled with new data</span>
<span class="sd">        2. combinations of `.with_format(arrow)` and batched `.map()` may skip one batch.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import Dataset, concatenate_datasets</span>
<span class="sd">        &gt;&gt;&gt; ds = Dataset.from_dict({&quot;a&quot;: range(6)}).to_iterable_dataset(num_shards=3)</span>
<span class="sd">        &gt;&gt;&gt; for idx, example in enumerate(ds):</span>
<span class="sd">        ...     print(example)</span>
<span class="sd">        ...     if idx == 2:</span>
<span class="sd">        ...         state_dict = ds.state_dict()</span>
<span class="sd">        ...         print(&quot;checkpoint&quot;)</span>
<span class="sd">        ...         break</span>
<span class="sd">        &gt;&gt;&gt; ds.load_state_dict(state_dict)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;restart from checkpoint&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for example in ds:</span>
<span class="sd">        ...     print(example)</span>
<span class="sd">        ```</span>

<span class="sd">        which returns:</span>
<span class="sd">        ```</span>
<span class="sd">        {&#39;a&#39;: 0}</span>
<span class="sd">        {&#39;a&#39;: 1}</span>
<span class="sd">        {&#39;a&#39;: 2}</span>
<span class="sd">        checkpoint</span>
<span class="sd">        restart from checkpoint</span>
<span class="sd">        {&#39;a&#39;: 3}</span>
<span class="sd">        {&#39;a&#39;: 4}</span>
<span class="sd">        {&#39;a&#39;: 5}</span>
<span class="sd">        ```</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from torchdata.stateful_dataloader import StatefulDataLoader</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;deepmind/code_contests&quot;, streaming=True, split=&quot;train&quot;)</span>
<span class="sd">        &gt;&gt;&gt; dataloader = StatefulDataLoader(ds, batch_size=32, num_workers=4)</span>
<span class="sd">        &gt;&gt;&gt; # checkpoint</span>
<span class="sd">        &gt;&gt;&gt; state_dict = dataloader.state_dict()  # uses ds.state_dict() under the hood</span>
<span class="sd">        &gt;&gt;&gt; # resume from checkpoint</span>
<span class="sd">        &gt;&gt;&gt; dataloader.load_state_dict(state_dict)  # uses ds.load_state_dict() under the hood</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span> <span class="o">=</span> <span class="n">state_dict</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;IterableDataset(</span><span class="se">{{\n</span><span class="s2">    features: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">    num_shards: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="se">\n}}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="c1"># Re-add torch shared memory, since shared memory is not always kept when pickling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">=</span> <span class="n">_maybe_share_with_torch_persistent_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">)</span>
        <span class="c1"># Re-add the cache to keep on pickling (e.g. for dataloader workers)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hffs_cache</span> <span class="o">=</span> <span class="n">HfFileSystem</span><span class="o">.</span><span class="n">_cache</span>
        <span class="c1"># Re-add torch iterable dataset as a parent class, since dynamically added parent classes are not kept when pickling</span>
        <span class="n">_maybe_add_torch_iterable_dataset_parent_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">n</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_effective_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="o">.</span><span class="n">generator</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">:</span>
            <span class="c1"># Create effective seed using self.epoch (we subtract in order to avoir overflow in long_scalars)</span>
            <span class="n">effective_seed</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="n">effective_seed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">+</span> <span class="n">effective_seed</span> <span class="k">if</span> <span class="n">effective_seed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">effective_seed</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">effective_seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This dataset is not shuffled&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">world_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">world_size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">num_shards</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># backward compatibility</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_pytorch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ex_iterable_for_iteration</span><span class="p">()</span>
        <span class="c1"># Fix for fsspec when using multiprocess to avoid hanging in the ML training loop. (only required for fsspec &gt;= 0.9.0)</span>
        <span class="c1"># See https://github.com/fsspec/gcsfs/issues/379</span>
        <span class="n">fsspec</span><span class="o">.</span><span class="n">asyn</span><span class="o">.</span><span class="n">reset_lock</span><span class="p">()</span>
        <span class="c1"># check if there aren&#39;t too many workers</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.data</span>

        <span class="n">worker_info</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_worker_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_main_process</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">&lt;</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many dataloader workers: </span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> (max is dataset.num_shards=</span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> dataloader workers.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;To parallelize data loading, we give each process some shards (or data sources) to process. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Therefore it&#39;s unnecessary to have a number of workers greater than dataset.num_shards=</span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;To enable more parallelism, please split the dataset in more files than </span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># split workload</span>
        <span class="n">_log_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;node#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">shards_indices</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">split_shard_indices_by_worker</span><span class="p">(</span>
            <span class="n">num_shards</span><span class="o">=</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">shards_indices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">dataloader worker#</span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, &#39;: Starting to iterate over </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shards_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span>
            <span class="p">)</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span>
                <span class="n">num_shards</span><span class="o">=</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">shift_ex_examples_rngs</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]:</span>
                <span class="n">ex_iterable</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span><span class="p">[</span><span class="s2">&quot;examples_iterable&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">):</span>
                <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
                    <span class="n">iterator</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iterator</span> <span class="o">=</span> <span class="n">_convert_to_arrow</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_row</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ex_iterable</span><span class="p">:</span>
                    <span class="c1"># no need to format thanks to FormattedExamplesIterable</span>
                    <span class="k">yield</span> <span class="n">example</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">dataloader worker#</span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, &#39;: Finished iterating over </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shards_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> shards.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_log_prefix</span><span class="si">}</span><span class="s2">dataloader worker#</span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, &#39;: Stopping... Number of dataset shards &lt; num_workers (</span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_main_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;torch&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.data</span>

            <span class="n">worker_info</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_worker_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">worker_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_ex_iterable_for_iteration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_BaseExamplesIterable</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span>
                <span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">:</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">shuffle_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_generator</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">:</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">world_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">world_size</span>
            <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">%</span> <span class="n">world_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_main_process</span><span class="p">():</span>
                    <span class="n">num_shards_per_node</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span> <span class="o">//</span> <span class="n">world_size</span>
                    <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">num_shards_per_node</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Assigning </span><span class="si">{</span><span class="n">num_shards_per_node</span><span class="si">}</span><span class="s2"> shard</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> (or data source</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2">) of the dataset to each node.&quot;</span>
                    <span class="p">)</span>
                <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_main_process</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Assigning 1 out of </span><span class="si">{</span><span class="n">world_size</span><span class="si">}</span><span class="s2"> examples of the dataset to each node. The others are skipped during the iteration.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;It is more optimized to distribute the dataset shards (or data sources) across nodes. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;You can do that by using a dataset with number of shards that is a factor of world_size=</span><span class="si">{</span><span class="n">world_size</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;The current dataset has </span><span class="si">{</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> which is not a factor of </span><span class="si">{</span><span class="n">world_size</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">StepExamplesIterable</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">rank</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
                <span class="n">ex_iterable</span><span class="p">,</span>
                <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;examples_iterable&quot;</span><span class="p">:</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">_init_state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]:</span>
            <span class="n">ex_iterable</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_starting_state_dict</span><span class="p">[</span><span class="s2">&quot;examples_iterable&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ex_iterable</span>

<div class="viewcode-block" id="IterableDataset.__iter__">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.__iter__.html#datasets.IterableDataset.__iter__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;torch&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.data</span>

            <span class="n">worker_info</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_worker_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IterableDataset</span><span class="p">)</span> <span class="ow">and</span> <span class="n">worker_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We&#39;re a torch.utils.data.IterableDataset in a PyTorch worker process</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_pytorch</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ex_iterable_for_iteration</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">):</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">_convert_to_arrow</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_row</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ex_iterable</span><span class="p">:</span>
            <span class="c1"># no need to format thanks to FormattedExamplesIterable</span>
            <span class="k">yield</span> <span class="n">example</span></div>


<div class="viewcode-block" id="IterableDataset.iter">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.iter.html#datasets.IterableDataset.iter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate through the batches of size `batch_size`.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (:obj:`int`): size of each batch to yield.</span>
<span class="sd">            drop_last_batch (:obj:`bool`, default `False`): Whether a last batch smaller than the batch_size should be</span>
<span class="sd">                dropped</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">get_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">format_type</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
            <span class="n">format_dict</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">recursive_tensorize</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formatter</span><span class="p">,</span> <span class="n">TensorFormatter</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format_dict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ex_iterable_for_iteration</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">_convert_to_arrow</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pa_table</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format_batch</span><span class="p">(</span><span class="n">pa_table</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="c1"># If batched, first build the batch</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">example</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">drop_last_batch</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>  <span class="c1"># ignore last batch</span>
                <span class="k">return</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">_examples_to_batch</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
            <span class="c1"># we need to format here in case we need to stack tensors together</span>
            <span class="k">yield</span> <span class="n">format_dict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="k">if</span> <span class="n">format_dict</span> <span class="k">else</span> <span class="n">batch</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableColumn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IterableColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span>

<div class="viewcode-block" id="IterableDataset.from_generator">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.from_generator.html#datasets.IterableDataset.from_generator">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_generator</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">NamedSplit</span> <span class="o">=</span> <span class="n">Split</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an Iterable Dataset from a generator.</span>

<span class="sd">        Args:</span>
<span class="sd">            generator (`Callable`):</span>
<span class="sd">                A generator function that `yields` examples.</span>
<span class="sd">            features (`Features`, *optional*):</span>
<span class="sd">                Dataset features.</span>
<span class="sd">            gen_kwargs(`dict`, *optional*):</span>
<span class="sd">                Keyword arguments to be passed to the `generator` callable.</span>
<span class="sd">                You can define a sharded iterable dataset by passing the list of shards in `gen_kwargs`.</span>
<span class="sd">                This can be used to improve shuffling and when iterating over the dataset with multiple workers.</span>
<span class="sd">            split ([`NamedSplit`], defaults to `Split.TRAIN`):</span>
<span class="sd">                Split name to be assigned to the dataset.</span>

<span class="sd">                &lt;Added version=&quot;2.21.0&quot;/&gt;</span>
<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; def gen():</span>
<span class="sd">        ...     yield {&quot;text&quot;: &quot;Good&quot;, &quot;label&quot;: 0}</span>
<span class="sd">        ...     yield {&quot;text&quot;: &quot;Bad&quot;, &quot;label&quot;: 1}</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; ds = IterableDataset.from_generator(gen)</span>
<span class="sd">        ```</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; def gen(shards):</span>
<span class="sd">        ...     for shard in shards:</span>
<span class="sd">        ...         with open(shard) as f:</span>
<span class="sd">        ...             for line in f:</span>
<span class="sd">        ...                 yield {&quot;line&quot;: line}</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; shards = [f&quot;data{i}.txt&quot; for i in range(32)]</span>
<span class="sd">        &gt;&gt;&gt; ds = IterableDataset.from_generator(gen, gen_kwargs={&quot;shards&quot;: shards})</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.shuffle(seed=42, buffer_size=10_000)  # shuffles the shards order + uses a shuffle buffer</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.data import DataLoader</span>
<span class="sd">        &gt;&gt;&gt; dataloader = DataLoader(ds.with_format(&quot;torch&quot;), num_workers=4)  # give each worker a subset of 32/4=8 shards</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io.generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeneratorDatasetInputStream</span>

        <span class="k">return</span> <span class="n">GeneratorDatasetInputStream</span><span class="p">(</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span>
        <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="IterableDataset.from_spark">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.from_spark">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_spark</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="s2">&quot;pyspark.sql.DataFrame&quot;</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NamedSplit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an IterableDataset from Spark DataFrame. The dataset is streamed to the driver in batches.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (`pyspark.sql.DataFrame`):</span>
<span class="sd">                The DataFrame containing the desired data.</span>
<span class="sd">            split (`NamedSplit`, *optional*):</span>
<span class="sd">                Split name to be assigned to the dataset.</span>
<span class="sd">            features (`Features`, *optional*):</span>
<span class="sd">                Dataset features.</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`IterableDataset`]</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame(</span>
<span class="sd">        &gt;&gt;&gt;     data=[[1, &quot;Elia&quot;], [2, &quot;Teo&quot;], [3, &quot;Fang&quot;]],</span>
<span class="sd">        &gt;&gt;&gt;     columns=[&quot;id&quot;, &quot;name&quot;],</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">        &gt;&gt;&gt; ds = IterableDataset.from_spark(df)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io.spark</span><span class="w"> </span><span class="kn">import</span> <span class="n">SparkDatasetReader</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;IterableDataset.from_spark is not currently supported on Windows&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SparkDatasetReader</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="IterableDataset.from_file">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.from_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate a IterableDataset from Arrow table at filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (`str`):</span>
<span class="sd">                File name of the dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`IterableDataset`]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pa_table_schema</span> <span class="o">=</span> <span class="n">read_schema_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">inferred_features</span> <span class="o">=</span> <span class="n">Features</span><span class="o">.</span><span class="n">from_arrow_schema</span><span class="p">(</span><span class="n">pa_table_schema</span><span class="p">)</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">ArrowExamplesIterable</span><span class="p">(</span><span class="n">Dataset</span><span class="o">.</span><span class="n">_generate_tables_from_cache_file</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">DatasetInfo</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">inferred_features</span><span class="p">))</span></div>


<div class="viewcode-block" id="IterableDataset.with_format">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.with_format.html#datasets.IterableDataset.with_format">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">with_format</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dataset with the specified format.</span>

<span class="sd">        Args:</span>

<span class="sd">            type (`str`, *optional*):</span>
<span class="sd">                Either output type selected in `[None, &#39;numpy&#39;, &#39;torch&#39;, &#39;tensorflow&#39;, &#39;jax&#39;, &#39;arrow&#39;, &#39;pandas&#39;, &#39;polars&#39;]`.</span>
<span class="sd">                `None` means it returns python objects (default).</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; from transformers import AutoTokenizer</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;validation&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; tokenizer = AutoTokenizer.from_pretrained(&quot;bert-base-cased&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.map(lambda x: tokenizer(x[&#39;text&#39;], truncation=True, padding=True), batched=True)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.with_format(&quot;torch&quot;)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;text&#39;: &#39;compassionately explores the seemingly irreconcilable situation between conservative christian parents and their estranged gay and lesbian children .&#39;,</span>
<span class="sd">         &#39;label&#39;: tensor(1),</span>
<span class="sd">         &#39;input_ids&#39;: tensor([  101, 18027, 16310, 16001,  1103,  9321,   178, 11604,  7235,  6617,</span>
<span class="sd">                1742,  2165,  2820,  1206,  6588, 22572, 12937,  1811,  2153,  1105,</span>
<span class="sd">                1147, 12890, 19587,  6463,  1105, 15026,  1482,   119,   102,     0,</span>
<span class="sd">                    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,</span>
<span class="sd">                    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,</span>
<span class="sd">                    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,</span>
<span class="sd">                    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,</span>
<span class="sd">                    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,</span>
<span class="sd">                    0,     0,     0,     0]),</span>
<span class="sd">         &#39;token_type_ids&#39;: tensor([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="sd">                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="sd">                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="sd">                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),</span>
<span class="sd">         &#39;attention_mask&#39;: tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span>
<span class="sd">                1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="sd">                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="sd">                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">get_format_type_from_alias</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="c1"># TODO(QL): add format_kwargs</span>
        <span class="c1"># TODO(QL): add format_columns and return_all_columns</span>
        <span class="c1"># TODO(QL): add pandas format</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="n">FormattingConfig</span><span class="p">(</span><span class="n">format_type</span><span class="o">=</span><span class="nb">type</span><span class="p">),</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.map">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.map.html#datasets.IterableDataset.map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">with_indices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">input_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">remove_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Features</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fn_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a function to all the examples in the iterable dataset (individually or in batches) and update them.</span>
<span class="sd">        If your function returns a column that already exists, then it overwrites it.</span>
<span class="sd">        The function is applied on-the-fly on the examples when iterating over the dataset.</span>

<span class="sd">        You can specify whether the function should be batched or not with the `batched` parameter:</span>

<span class="sd">        - If batched is `False`, then the function takes 1 example in and should return 1 example.</span>
<span class="sd">          An example is a dictionary, e.g. `{&quot;text&quot;: &quot;Hello there !&quot;}`.</span>
<span class="sd">        - If batched is `True` and `batch_size` is 1, then the function takes a batch of 1 example as input and can return a batch with 1 or more examples.</span>
<span class="sd">          A batch is a dictionary, e.g. a batch of 1 example is {&quot;text&quot;: [&quot;Hello there !&quot;]}.</span>
<span class="sd">        - If batched is `True` and `batch_size` is `n` &gt; 1, then the function takes a batch of `n` examples as input and can return a batch with `n` examples, or with an arbitrary number of examples.</span>
<span class="sd">          Note that the last batch may have less than `n` examples.</span>
<span class="sd">          A batch is a dictionary, e.g. a batch of `n` examples is `{&quot;text&quot;: [&quot;Hello there !&quot;] * n}`.</span>

<span class="sd">        If the function is asynchronous, then `map` will run your function in parallel, with up to one thousand simulatenous calls.</span>
<span class="sd">        It is recommended to use a `asyncio.Semaphore` in your function if you want to set a maximum number of operations that can run at the same time.</span>

<span class="sd">        Args:</span>
<span class="sd">            function (`Callable`, *optional*, defaults to `None`):</span>
<span class="sd">                Function applied on-the-fly on the examples when you iterate on the dataset.</span>
<span class="sd">                It must have one of the following signatures:</span>

<span class="sd">                - `function(example: Dict[str, Any]) -&gt; Dict[str, Any]` if `batched=False` and `with_indices=False`</span>
<span class="sd">                - `function(example: Dict[str, Any], idx: int) -&gt; Dict[str, Any]` if `batched=False` and `with_indices=True`</span>
<span class="sd">                - `function(batch: Dict[str, List]) -&gt; Dict[str, List]` if `batched=True` and `with_indices=False`</span>
<span class="sd">                - `function(batch: Dict[str, List], indices: List[int]) -&gt; Dict[str, List]` if `batched=True` and `with_indices=True`</span>

<span class="sd">                For advanced usage, the function can also return a `pyarrow.Table`.</span>
<span class="sd">                If the function is asynchronous, then `map` will run your function in parallel.</span>
<span class="sd">                Moreover if your function returns nothing (`None`), then `map` will run your function and return the dataset unchanged.</span>
<span class="sd">                If no function is provided, default to identity function: `lambda x: x`.</span>
<span class="sd">            with_indices (`bool`, defaults to `False`):</span>
<span class="sd">                Provide example indices to `function`. Note that in this case the signature of `function` should be `def function(example, idx[, rank]): ...`.</span>
<span class="sd">            input_columns (`Optional[Union[str, List[str]]]`, defaults to `None`):</span>
<span class="sd">                The columns to be passed into `function`</span>
<span class="sd">                as positional arguments. If `None`, a dict mapping to all formatted columns is passed as one argument.</span>
<span class="sd">            batched (`bool`, defaults to `False`):</span>
<span class="sd">                Provide batch of examples to `function`.</span>
<span class="sd">            batch_size (`int`, *optional*, defaults to `1000`):</span>
<span class="sd">                Number of examples per batch provided to `function` if `batched=True`.</span>
<span class="sd">                `batch_size &lt;= 0` or `batch_size == None` then provide the full dataset as a single batch to `function`.</span>
<span class="sd">            drop_last_batch (`bool`, defaults to `False`):</span>
<span class="sd">                Whether a last batch smaller than the batch_size should be</span>
<span class="sd">                dropped instead of being processed by the function.</span>
<span class="sd">            remove_columns (`[List[str]]`, *optional*, defaults to `None`):</span>
<span class="sd">                Remove a selection of columns while doing the mapping.</span>
<span class="sd">                Columns will be removed before updating the examples with the output of `function`, i.e. if `function` is adding</span>
<span class="sd">                columns with names in `remove_columns`, these columns will be kept.</span>
<span class="sd">            features (`[Features]`, *optional*, defaults to `None`):</span>
<span class="sd">                Feature types of the resulting dataset.</span>
<span class="sd">            fn_kwargs (`Dict`, *optional*, default `None`):</span>
<span class="sd">                Keyword arguments to be passed to `function`.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; def add_prefix(example):</span>
<span class="sd">        ...     example[&quot;text&quot;] = &quot;Review: &quot; + example[&quot;text&quot;]</span>
<span class="sd">        ...     return example</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.map(add_prefix)</span>
<span class="sd">        &gt;&gt;&gt; list(ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;Review: the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;Review: the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;Review: effective but too-tepid biopic&#39;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">remove_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">remove_columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">identity_func</span>
        <span class="k">if</span> <span class="n">fn_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">_fix_for_backward_compatible_features</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span>
        <span class="c1"># no need to apply features if ex_iterable is typed and if there was no cast_column()</span>
        <span class="n">input_features</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="o">==</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">is_table</span><span class="p">:</span>
            <span class="c1"># apply formatting before iter_arrow to keep map examples iterable happy</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
                <span class="n">ex_iterable</span><span class="p">,</span>
                <span class="n">formatting</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">),</span>
                <span class="n">features</span><span class="o">=</span><span class="n">input_features</span><span class="p">,</span>
                <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span>
                <span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span> <span class="k">if</span> <span class="n">batched</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span><span class="p">:</span>
                <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span> <span class="k">if</span> <span class="n">batched</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">or</span> <span class="n">input_features</span><span class="p">:</span>
                <span class="c1"># apply formatting after iter_arrow to avoid re-encoding the examples</span>
                <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
                    <span class="n">ex_iterable</span><span class="p">,</span>
                    <span class="n">formatting</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">),</span>
                    <span class="n">features</span><span class="o">=</span><span class="n">input_features</span><span class="p">,</span>
                    <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">MappedExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span><span class="p">,</span>
            <span class="n">remove_columns</span><span class="o">=</span><span class="n">remove_columns</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.filter">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.filter.html#datasets.IterableDataset.filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">with_indices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">input_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fn_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a filter function to all the elements so that the dataset only includes examples according to the filter function.</span>
<span class="sd">        The filtering is done on-the-fly when iterating over the dataset.</span>

<span class="sd">        If the function is asynchronous, then `filter` will run your function in parallel, with up to one thousand simulatenous calls (configurable).</span>
<span class="sd">        It is recommended to use a `asyncio.Semaphore` in your function if you want to set a maximum number of operations that can run at the same time.</span>

<span class="sd">        Args:</span>
<span class="sd">            function (`Callable`):</span>
<span class="sd">                Callable with one of the following signatures:</span>

<span class="sd">                - `function(example: Dict[str, Any]) -&gt; bool` if `with_indices=False, batched=False`</span>
<span class="sd">                - `function(example: Dict[str, Any], indices: int) -&gt; bool` if `with_indices=True, batched=False`</span>
<span class="sd">                - `function(example: Dict[str, List]) -&gt; List[bool]` if `with_indices=False, batched=True`</span>
<span class="sd">                - `function(example: Dict[str, List], indices: List[int]) -&gt; List[bool]` if `with_indices=True, batched=True`</span>

<span class="sd">                If the function is asynchronous, then `filter` will run your function in parallel.</span>
<span class="sd">                If no function is provided, defaults to an always True function: `lambda x: True`.</span>
<span class="sd">            with_indices (`bool`, defaults to `False`):</span>
<span class="sd">                Provide example indices to `function`. Note that in this case the signature of `function` should be `def function(example, idx): ...`.</span>
<span class="sd">            input_columns (`str` or `List[str]`, *optional*):</span>
<span class="sd">                The columns to be passed into `function` as</span>
<span class="sd">                positional arguments. If `None`, a dict mapping to all formatted columns is passed as one argument.</span>
<span class="sd">            batched (`bool`, defaults to `False`):</span>
<span class="sd">                Provide batch of examples to `function`.</span>
<span class="sd">            batch_size (`int`, *optional*, default `1000`):</span>
<span class="sd">                Number of examples per batch provided to `function` if `batched=True`.</span>
<span class="sd">            fn_kwargs (`Dict`, *optional*, default `None`):</span>
<span class="sd">                Keyword arguments to be passed to `function`.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.filter(lambda x: x[&quot;label&quot;] == 0)</span>
<span class="sd">        &gt;&gt;&gt; list(ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 0, &#39;movie_review&#39;: &#39;simplistic , silly and tedious .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 0,</span>
<span class="sd">         &#39;movie_review&#39;: &quot;it&#39;s so laddish and juvenile , only teenage boys could possibly find it funny .&quot;},</span>
<span class="sd">         {&#39;label&#39;: 0,</span>
<span class="sd">         &#39;movie_review&#39;: &#39;exploitative and largely devoid of the depth or sophistication that would make watching such a graphic treatment of the crimes bearable .&#39;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_columns</span><span class="p">]</span>

        <span class="c1"># We need the examples to be decoded for certain feature types like Image or Audio,</span>
        <span class="c1"># format and type before filtering</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">:</span>
            <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">FormattedExamplesIterable</span><span class="p">(</span>
                <span class="n">ex_iterable</span><span class="p">,</span>
                <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ex_iterable</span><span class="o">.</span><span class="n">is_typed</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
                <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">FilteredExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
            <span class="n">with_indices</span><span class="o">=</span><span class="n">with_indices</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="o">=</span><span class="n">input_columns</span><span class="p">,</span>
            <span class="n">batched</span><span class="o">=</span><span class="n">batched</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="n">fn_kwargs</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.shuffle">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.shuffle.html#datasets.IterableDataset.shuffle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Randomly shuffles the elements of this dataset.</span>

<span class="sd">        This dataset fills a buffer with `buffer_size` elements, then randomly samples elements from this buffer,</span>
<span class="sd">        replacing the selected elements with new elements. For perfect shuffling, a buffer size greater than or</span>
<span class="sd">        equal to the full size of the dataset is required.</span>

<span class="sd">        For instance, if your dataset contains 10,000 elements but `buffer_size` is set to 1000, then `shuffle` will</span>
<span class="sd">        initially select a random element from only the first 1000 elements in the buffer. Once an element is</span>
<span class="sd">        selected, its space in the buffer is replaced by the next (i.e. 1,001-st) element,</span>
<span class="sd">        maintaining the 1000 element buffer.</span>

<span class="sd">        If the dataset is made of several shards, it also does shuffle the order of the shards.</span>
<span class="sd">        However if the order has been fixed by using [`~datasets.IterableDataset.skip`] or [`~datasets.IterableDataset.take`]</span>
<span class="sd">        then the order of the shards is kept unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            seed (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Random seed that will be used to shuffle the dataset.</span>
<span class="sd">                It is used to sample from the shuffle buffer and also to shuffle the data shards.</span>
<span class="sd">            generator (`numpy.random.Generator`, *optional*):</span>
<span class="sd">                Numpy random Generator to use to compute the permutation of the dataset rows.</span>
<span class="sd">                If `generator=None` (default), uses `np.random.default_rng` (the default BitGenerator (PCG64) of NumPy).</span>
<span class="sd">            buffer_size (`int`, defaults to `1000`):</span>
<span class="sd">                Size of the buffer.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; list(ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;effective but too-tepid biopic&#39;}]</span>
<span class="sd">        &gt;&gt;&gt; shuffled_ds = ds.shuffle(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; list(shuffled_ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &quot;a sports movie with action that&#39;s exciting on the field and a story you care about off it .&quot;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;at its best , the good girl is a refreshingly adult take on adultery . . .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &quot;sam jones became a very lucky filmmaker the day wilco got dropped from their record label , proving that one man&#39;s ruin may be another&#39;s fortune .&quot;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="n">shuffling</span> <span class="o">=</span> <span class="n">ShufflingConfig</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span> <span class="n">_original_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">BufferShuffledExamplesIterable</span><span class="p">(</span>
                <span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
                <span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span>
                <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">shuffling</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">+=</span> <span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span>  <span class="c1"># update torch value in shared memory in-place</span>

<div class="viewcode-block" id="IterableDataset.skip">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.skip.html#datasets.IterableDataset.skip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new [`IterableDataset`] that skips the first `n` elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            n (`int`):</span>
<span class="sd">                Number of elements to skip.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; list(ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;effective but too-tepid biopic&#39;}]</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.skip(1)</span>
<span class="sd">        &gt;&gt;&gt; list(ds.take(3))</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;effective but too-tepid biopic&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;if you sometimes like to go to the movies to have fun , wasabi is a good place to start .&#39;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">SkipExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">n</span><span class="p">,</span>
            <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.repeat">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.repeat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_times</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new [`IterableDataset`] that repeats the underlying dataset `num_times` times.</span>

<span class="sd">        N.B. The effect of calling shuffle after repeat depends significantly on buffer size.</span>
<span class="sd">        With buffer_size 1, duplicate data is never seen in the same iteration, even after shuffling:</span>
<span class="sd">        ds.repeat(n).shuffle(seed=42, buffer_size=1) is equivalent to ds.shuffle(seed=42, buffer_size=1).repeat(n),</span>
<span class="sd">        and only shuffles shard orders within each iteration.</span>
<span class="sd">        With buffer size &gt;= (num samples in the dataset * num_times), we get full shuffling of the repeated data, i.e. we can observe duplicates in</span>
<span class="sd">        the same iteration.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_times (`int`) or (`None`):</span>
<span class="sd">                Number of times to repeat the dataset. If `None`, the dataset will be repeated indefinitely.</span>

<span class="sd">        Example:</span>
<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.take(2).repeat(2)</span>
<span class="sd">        &gt;&gt;&gt; list(ds)</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;effective but too-tepid biopic&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1, &#39;text&#39;: &#39;effective but too-tepid biopic&#39;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">RepeatExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">num_times</span><span class="o">=</span><span class="n">num_times</span><span class="p">),</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.take">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.take.html#datasets.IterableDataset.take">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new [`IterableDataset`] with only the first `n` elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            n (`int`):</span>
<span class="sd">                Number of elements to take.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; small_ds = ds.take(2)</span>
<span class="sd">        &gt;&gt;&gt; list(small_ds)</span>
<span class="sd">        [{&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;},</span>
<span class="sd">         {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the gorgeously elaborate continuation of &quot; the lord of the rings &quot; trilogy is so huge that a column of words cannot adequately describe co-writer/director peter jackson\&#39;s expanded vision of j . r . r . tolkien\&#39;s middle-earth .&#39;}]</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">TakeExamplesIterable</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">n</span><span class="p">,</span>
            <span class="n">block_sources_order_when_shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">split_when_sharding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.shard">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.shard">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shard</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">contiguous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the `index`-nth shard from dataset split into `num_shards` pieces.</span>

<span class="sd">        This shards deterministically. `dataset.shard(n, i)` splits the dataset into contiguous chunks,</span>
<span class="sd">        so it can be easily concatenated back together after processing. If `dataset.num_shards % n == l`, then the</span>
<span class="sd">        first `l` datasets each have `(dataset.num_shards // n) + 1` shards, and the remaining datasets have `(dataset.num_shards // n)` shards.</span>
<span class="sd">        `datasets.concatenate_datasets([dset.shard(n, i) for i in range(n)])` returns a dataset with the same order as the original.</span>
<span class="sd">        In particular, `dataset.shard(dataset.num_shards, i)` returns a dataset with 1 shard.</span>

<span class="sd">        Note: n should be less or equal to the number of shards in the dataset `dataset.num_shards`.</span>

<span class="sd">        On the other hand, `dataset.shard(n, i, contiguous=False)` contains all the shards of the dataset whose index mod `n = i`.</span>

<span class="sd">        Be sure to shard before using any randomizing operator (such as `shuffle`).</span>
<span class="sd">        It is best if the shard operator is used early in the dataset pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_shards (`int`):</span>
<span class="sd">                How many shards to split the dataset into.</span>
<span class="sd">            index (`int`):</span>
<span class="sd">                Which shard to select and return.</span>
<span class="sd">            contiguous: (`bool`, defaults to `True`):</span>
<span class="sd">                Whether to select contiguous blocks of indices for shards.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;fancyzhx/amazon_polarity&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; ds</span>
<span class="sd">        Dataset({</span>
<span class="sd">            features: [&#39;label&#39;, &#39;title&#39;, &#39;content&#39;],</span>
<span class="sd">            num_shards: 4</span>
<span class="sd">        })</span>
<span class="sd">        &gt;&gt;&gt; ds.shard(num_shards=2, index=0)</span>
<span class="sd">        Dataset({</span>
<span class="sd">            features: [&#39;label&#39;, &#39;title&#39;, &#39;content&#39;],</span>
<span class="sd">            num_shards: 2</span>
<span class="sd">        })</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">shard_data_sources</span><span class="p">(</span><span class="n">num_shards</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.add_column">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.add_column.html#datasets.IterableDataset.add_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add column to Dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Column name.</span>
<span class="sd">            column (list or np.array): Column data to be added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">add_column_fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">),</span> <span class="n">with_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.rename_column">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.rename_column.html#datasets.IterableDataset.rename_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename a column in the dataset, and move the features associated to the original column under the new column</span>
<span class="sd">        name.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_column_name (`str`):</span>
<span class="sd">                Name of the column to rename.</span>
<span class="sd">            new_column_name (`str`):</span>
<span class="sd">                New name for the column.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset with a renamed column.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;}</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.rename_column(&quot;text&quot;, &quot;movie_review&quot;)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;label&#39;: 1,</span>
<span class="sd">         &#39;movie_review&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">({</span><span class="n">original_column_name</span><span class="p">:</span> <span class="n">new_column_name</span><span class="p">})</span></div>


<div class="viewcode-block" id="IterableDataset.rename_columns">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.rename_columns.html#datasets.IterableDataset.rename_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename several columns in the dataset, and move the features associated to the original columns under</span>
<span class="sd">        the new column names.</span>

<span class="sd">        Args:</span>
<span class="sd">            column_mapping (`Dict[str, str]`): A mapping of columns to rename to their new names</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset with renamed columns</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">original_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ds_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">_rename_columns_fn</span><span class="p">,</span> <span class="n">column_mapping</span><span class="o">=</span><span class="n">column_mapping</span><span class="p">),</span> <span class="n">remove_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">original_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_iterable</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">column_mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">col</span><span class="p">:</span> <span class="n">feature</span>
                    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">original_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_iterable</span></div>


<div class="viewcode-block" id="IterableDataset.remove_columns">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.remove_columns.html#datasets.IterableDataset.remove_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove one or several column(s) in the dataset and the features associated to them.</span>
<span class="sd">        The removal is done on-the-fly on the examples when iterating over the dataset.</span>


<span class="sd">        Args:</span>
<span class="sd">            column_names (`Union[str, List[str]]`):</span>
<span class="sd">                Name of the column(s) to remove.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset object without the columns to remove.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;, &#39;label&#39;: 1}</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.remove_columns(&quot;label&quot;)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ds_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">remove_columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_iterable</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">original_features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">original_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ds_iterable</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ds_iterable</span></div>


<div class="viewcode-block" id="IterableDataset.select_columns">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.select_columns.html#datasets.IterableDataset.select_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select one or several column(s) in the dataset and the features</span>
<span class="sd">        associated to them. The selection is done on-the-fly on the examples</span>
<span class="sd">        when iterating over the dataset.</span>


<span class="sd">        Args:</span>
<span class="sd">            column_names (`Union[str, List[str]]`):</span>
<span class="sd">                Name of the column(s) to select.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset object with selected columns.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;, &#39;label&#39;: 1}</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.select_columns(&quot;text&quot;)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;text&#39;: &#39;the rock is destined to be the 21st century\&#39;s new &quot; conan &quot; and that he\&#39;s going to make a splash even greater than arnold schwarzenegger , jean-claud van damme or steven segal .&#39;}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_names</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Column name </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> not in the &quot;</span>
                        <span class="s2">&quot;dataset. Columns in the dataset: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">})</span>

        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">SelectColumnsIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">,</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.cast_column">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.cast_column.html#datasets.IterableDataset.cast_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cast_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="n">FeatureType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cast column to feature for decoding.</span>

<span class="sd">        Args:</span>
<span class="sd">            column (`str`):</span>
<span class="sd">                Column name.</span>
<span class="sd">            feature (`Feature`):</span>
<span class="sd">                Target feature.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset, Audio</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;PolyAI/minds14&quot;, name=&quot;en-US&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; ds.features</span>
<span class="sd">        {&#39;audio&#39;: Audio(sampling_rate=8000, mono=True, decode=True, id=None),</span>
<span class="sd">         &#39;english_transcription&#39;: Value(&#39;string&#39;),</span>
<span class="sd">         &#39;intent_class&#39;: ClassLabel(num_classes=14, names=[&#39;abroad&#39;, &#39;address&#39;, &#39;app_error&#39;, &#39;atm_limit&#39;, &#39;balance&#39;, &#39;business_loan&#39;,  &#39;card_issues&#39;, &#39;cash_deposit&#39;, &#39;direct_debit&#39;, &#39;freeze&#39;, &#39;high_value_payment&#39;, &#39;joint_account&#39;, &#39;latest_transactions&#39;, &#39;pay_bill&#39;]),</span>
<span class="sd">         &#39;lang_id&#39;: ClassLabel(num_classes=14, names=[&#39;cs-CZ&#39;, &#39;de-DE&#39;, &#39;en-AU&#39;, &#39;en-GB&#39;, &#39;en-US&#39;, &#39;es-ES&#39;, &#39;fr-FR&#39;, &#39;it-IT&#39;, &#39;ko-KR&#39;,  &#39;nl-NL&#39;, &#39;pl-PL&#39;, &#39;pt-PT&#39;, &#39;ru-RU&#39;, &#39;zh-CN&#39;]),</span>
<span class="sd">         &#39;path&#39;: Value(&#39;string&#39;),</span>
<span class="sd">         &#39;transcription&#39;: Value(&#39;string&#39;)}</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.cast_column(&quot;audio&quot;, Audio(sampling_rate=16000))</span>
<span class="sd">        &gt;&gt;&gt; ds.features</span>
<span class="sd">        {&#39;audio&#39;: Audio(sampling_rate=16000, mono=True, decode=True, id=None),</span>
<span class="sd">         &#39;english_transcription&#39;: Value(&#39;string&#39;),</span>
<span class="sd">         &#39;intent_class&#39;: ClassLabel(num_classes=14, names=[&#39;abroad&#39;, &#39;address&#39;, &#39;app_error&#39;, &#39;atm_limit&#39;, &#39;balance&#39;, &#39;business_loan&#39;,  &#39;card_issues&#39;, &#39;cash_deposit&#39;, &#39;direct_debit&#39;, &#39;freeze&#39;, &#39;high_value_payment&#39;, &#39;joint_account&#39;, &#39;latest_transactions&#39;, &#39;pay_bill&#39;]),</span>
<span class="sd">         &#39;lang_id&#39;: ClassLabel(num_classes=14, names=[&#39;cs-CZ&#39;, &#39;de-DE&#39;, &#39;en-AU&#39;, &#39;en-GB&#39;, &#39;en-US&#39;, &#39;es-ES&#39;, &#39;fr-FR&#39;, &#39;it-IT&#39;, &#39;ko-KR&#39;,  &#39;nl-NL&#39;, &#39;pl-PL&#39;, &#39;pt-PT&#39;, &#39;ru-RU&#39;, &#39;zh-CN&#39;]),</span>
<span class="sd">         &#39;path&#39;: Value(&#39;string&#39;),</span>
<span class="sd">         &#39;transcription&#39;: Value(&#39;string&#39;)}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">_fix_for_backward_compatible_features</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.cast">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.cast.html#datasets.IterableDataset.cast">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cast</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">Features</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cast the dataset to a new set of features.</span>

<span class="sd">        Args:</span>
<span class="sd">            features ([`Features`]):</span>
<span class="sd">                New features to cast the dataset to.</span>
<span class="sd">                The name of the fields in the features must match the current column names.</span>
<span class="sd">                The type of the data must also be convertible from one type to the other.</span>
<span class="sd">                For non-trivial conversion, e.g. `string` &lt;-&gt; `ClassLabel` you should use [`~Dataset.map`] to update the Dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset with casted features.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset, ClassLabel, Value</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;cornell-movie-review-data/rotten_tomatoes&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; ds.features</span>
<span class="sd">        {&#39;label&#39;: ClassLabel(names=[&#39;neg&#39;, &#39;pos&#39;]),</span>
<span class="sd">         &#39;text&#39;: Value(&#39;string&#39;)}</span>
<span class="sd">        &gt;&gt;&gt; new_features = ds.features.copy()</span>
<span class="sd">        &gt;&gt;&gt; new_features[&quot;label&quot;] = ClassLabel(names=[&quot;bad&quot;, &quot;good&quot;])</span>
<span class="sd">        &gt;&gt;&gt; new_features[&quot;text&quot;] = Value(&quot;large_string&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.cast(new_features)</span>
<span class="sd">        &gt;&gt;&gt; ds.features</span>
<span class="sd">        {&#39;label&#39;: ClassLabel(names=[&#39;bad&#39;, &#39;good&#39;]),</span>
<span class="sd">         &#39;text&#39;: Value(&#39;large_string&#39;)}</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">_fix_for_backward_compatible_features</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.decode">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.decode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable or disable the dataset features decoding for audio, image, video.</span>

<span class="sd">        When enabled (default), media types are decoded:</span>

<span class="sd">        * audio -&gt; dict of &quot;array&quot; and &quot;sampling_rate&quot; and &quot;path&quot;</span>
<span class="sd">        * image -&gt; PIL.Image</span>
<span class="sd">        * video -&gt; torchvision.io.VideoReader</span>

<span class="sd">        You can enable multithreading using `num_threads`. This is especially useful to speed up remote</span>
<span class="sd">        data streaming. However it can be slower than `num_threads=0` for local data on fast disks.</span>

<span class="sd">        Disabling decoding is useful if you want to iterate on the paths or bytes of the media files</span>
<span class="sd">        without actually decoding their content. To disable decoding you can use `.decode(False)`, which</span>
<span class="sd">        is equivalent to calling `.cast()` or `.cast_column()` with all the Audio, Image and Video types</span>
<span class="sd">        set to `decode=False`.</span>

<span class="sd">        Args:</span>
<span class="sd">            enable (`bool`, defaults to `True`):</span>
<span class="sd">                Enable or disable features decoding.</span>
<span class="sd">            num_threads (`int`, defaults to `0`):</span>
<span class="sd">                Enable multithreading for features decoding.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `IterableDataset`: A copy of the dataset with casted features.</span>

<span class="sd">        Examples:</span>

<span class="sd">        Disable decoding:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;sshh12/planet-textures&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {&#39;image&#39;: &lt;PIL.PngImagePlugin.PngImageFile image mode=RGB size=2048x1024&gt;,</span>
<span class="sd">        &#39;text&#39;: &#39;A distant celestial object with an icy crust, displaying a light blue shade, covered with round pits and rugged terrains.&#39;}</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.decode(False)</span>
<span class="sd">        &gt;&gt;&gt; ds.features</span>
<span class="sd">        {&#39;image&#39;: Image(mode=None, decode=False, id=None),</span>
<span class="sd">        &#39;text&#39;: Value(&#39;string&#39;)}</span>
<span class="sd">        &gt;&gt;&gt; next(iter(ds))</span>
<span class="sd">        {</span>
<span class="sd">          &#39;image&#39;: {</span>
<span class="sd">            &#39;path&#39;: &#39;hf://datasets/sshh12/planet-textures@69dc4cef7a5c4b2cfe387727ec8ea73d4bff7302/train/textures/0000.png&#39;,</span>
<span class="sd">            &#39;bytes&#39;: None</span>
<span class="sd">          },</span>
<span class="sd">          &#39;text&#39;: &#39;A distant celestial object with an icy crust, displaying a light blue shade, covered with round pits and rugged terrains.&#39;</span>
<span class="sd">        }</span>
<span class="sd">        ```</span>

<span class="sd">        Speed up streaming with multithreading:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="sd">        &gt;&gt;&gt; from tqdm import tqdm</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;sshh12/planet-textures&quot;, split=&quot;train&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; num_threads = min(32, (os.cpu_count() or 1) + 4)</span>
<span class="sd">        &gt;&gt;&gt; ds = ds.decode(num_threads=num_threads)</span>
<span class="sd">        &gt;&gt;&gt; for _ in tqdm(ds):  # 20 times faster !</span>
<span class="sd">        ...     ...</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Features decoding is only available for datasets with known features, but features are Unknown. &quot;</span>
                <span class="s2">&quot;Please set the datasets features with `ds = ds.cast(features)`.&quot;</span>
            <span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">set_decoding</span><span class="p">(</span><span class="n">decode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="s2">&quot;decode&quot;</span><span class="p">):</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">decode</span> <span class="o">=</span> <span class="n">decode</span>

        <span class="k">if</span> <span class="n">enable</span> <span class="ow">and</span> <span class="n">num_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">disabled_decoding_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">enabled_decoding_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">_visit</span><span class="p">(</span><span class="n">disabled_decoding_features</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">set_decoding</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">_visit</span><span class="p">(</span><span class="n">enabled_decoding_features</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">set_decoding</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">disabled_decoding_features</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ThreadPool</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_apply_async</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">enabled_decoding_features</span><span class="o">.</span><span class="n">decode_example</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">enabled_decoding_features</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">MappedExamplesIterable</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">max_num_running_async_map_functions_in_parallel</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_threads</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_visit</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">set_decoding</span><span class="p">,</span> <span class="n">enable</span><span class="p">))</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">StepExamplesIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">is_typed</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="o">.</span><span class="n">features</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">_infer_features_from_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">_head</span><span class="p">())</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
            <span class="n">ex_iterable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
            <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
            <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span><span class="p">),</span>
            <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="IterableDataset.batch">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IterableDataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group samples from the dataset into batches.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (`int`): The number of samples in each batch.</span>
<span class="sd">            drop_last_batch (`bool`, defaults to `False`): Whether to drop the last incomplete batch.</span>

<span class="sd">        Example:</span>
<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds = load_dataset(&quot;some_dataset&quot;, streaming=True)</span>
<span class="sd">        &gt;&gt;&gt; batched_ds = ds.batch(batch_size=32)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">List</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">_batch_fn</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_last_batch</span><span class="o">=</span><span class="n">drop_last_batch</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.to_dict">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dataset as a Python dict. Can also return a generator for large datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (`int`, *optional*): The size (number of rows) of the batches if `batched` is `True`.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `dict` or `Iterator[dict]`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_dict()</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">batched</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="IterableDataset.to_list">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dataset as a Python list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `list`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_list()</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span></div>


<div class="viewcode-block" id="IterableDataset.to_pandas">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_pandas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_pandas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dataset as a `pandas.DataFrame`. Can also return a generator for large datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                The size (number of rows) of the batches if `batched` is `True`.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            batched (`bool`):</span>
<span class="sd">                Set to `True` to return a generator that yields the dataset as batches</span>
<span class="sd">                of `batch_size` rows. Defaults to `False` (returns the whole datasets once).</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pandas.DataFrame` or `Iterator[pandas.DataFrame]`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_pandas()</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">batched</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span></div>


<div class="viewcode-block" id="IterableDataset.to_polars">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_polars">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">schema_overrides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rechunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;pl.DataFrame&quot;</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="s2">&quot;pl.DataFrame&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dataset as a `polars.DataFrame`. Can also return a generator for large datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                The size (number of rows) of the batches if `batched` is `True`.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            batched (`bool`):</span>
<span class="sd">                Set to `True` to return a generator that yields the dataset as batches</span>
<span class="sd">                of `batch_size` rows. Defaults to `False` (returns the whole datasets once).</span>
<span class="sd">            schema_overrides (`dict`, *optional*):</span>
<span class="sd">                Support type specification or override of one or more columns; note that</span>
<span class="sd">                any dtypes inferred from the schema param will be overridden.</span>
<span class="sd">            rechunk (`bool`):</span>
<span class="sd">                Make sure that all data is in contiguous memory. Defaults to `True`.</span>
<span class="sd">        Returns:</span>
<span class="sd">            `polars.DataFrame` or `Iterator[polars.DataFrame]`</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_polars()</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">batched</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">schema_overrides</span><span class="o">=</span><span class="n">schema_overrides</span><span class="p">,</span> <span class="n">rechunk</span><span class="o">=</span><span class="n">rechunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">schema_overrides</span><span class="o">=</span><span class="n">schema_overrides</span><span class="p">,</span> <span class="n">rechunk</span><span class="o">=</span><span class="n">rechunk</span><span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.to_csv">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_csv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_or_buf</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">to_csv_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports the dataset to csv.</span>

<span class="sd">        This iterates on the dataset and loads it completely in memory before writing it.</span>

<span class="sd">        Args:</span>
<span class="sd">            path_or_buf (`PathLike` or `FileOrBuffer`):</span>
<span class="sd">                Either a path to a file (e.g. `file.csv`), a remote URI (e.g. `hf://datasets/username/my_dataset_name/data.csv`),</span>
<span class="sd">                or a BinaryIO, where the dataset will be saved to in the specified format.</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                Size of the batch to load in memory and write at once.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            storage_options (`dict`, *optional*):</span>
<span class="sd">                Key/value pairs to be passed on to the file-system backend, if any.</span>
<span class="sd">            **to_csv_kwargs (additional keyword arguments):</span>
<span class="sd">                Parameters to pass to pandas&#39;s [`pandas.DataFrame.to_csv`](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_csv.html).</span>
<span class="sd">                The parameter `index` defaults to `False` if not specified.</span>
<span class="sd">                If you would like to write the index, pass `index=True` and also set a name for the index column by</span>
<span class="sd">                passing `index_label`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `int`: The number of characters or bytes written.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_csv(&quot;path/to/dataset/directory&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">path_or_buf</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
            <span class="o">**</span><span class="n">to_csv_kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.to_json">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_or_buf</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">to_json_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export the dataset to JSON Lines or JSON.</span>

<span class="sd">        This iterates on the dataset and loads it completely in memory before writing it.</span>

<span class="sd">        The default output format is [JSON Lines](https://jsonlines.org/).</span>
<span class="sd">        To export to [JSON](https://www.json.org), pass `lines=False` argument and the desired `orient`.</span>

<span class="sd">        Args:</span>
<span class="sd">            path_or_buf (`PathLike` or `FileOrBuffer`):</span>
<span class="sd">                Either a path to a file (e.g. `file.json`), a remote URI (e.g. `hf://datasets/username/my_dataset_name/data.json`),</span>
<span class="sd">                or a BinaryIO, where the dataset will be saved to in the specified format.</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                Size of the batch to load in memory and write at once.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            storage_options (`dict`, *optional*):</span>
<span class="sd">                Key/value pairs to be passed on to the file-system backend, if any.</span>
<span class="sd">            **to_json_kwargs (additional keyword arguments):</span>
<span class="sd">                Parameters to pass to pandas&#39;s [`pandas.DataFrame.to_json`](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_json.html).</span>
<span class="sd">                Default arguments are `lines=True` and `orient=&quot;records&quot;.</span>
<span class="sd">                The parameter `index` defaults to `False` if `orient` is `&quot;split&quot;` or `&quot;table&quot;`.</span>
<span class="sd">                If you would like to write the index, pass `index=True`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `int`: The number of characters or bytes written.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_json(&quot;path/to/dataset/directory/filename.jsonl&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; num_shards = dataset.num_shards</span>
<span class="sd">        &gt;&gt;&gt; for index in range(num_shards):</span>
<span class="sd">        ...     shard = dataset.shard(index, num_shards)</span>
<span class="sd">        ...     shard.to_json(f&quot;path/of/my/dataset/data-{index:05d}.jsonl&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span>
            <span class="n">path_or_buf</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
            <span class="o">**</span><span class="n">to_json_kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.to_sql">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_sql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">con</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;sqlalchemy.engine.Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlalchemy.engine.Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite3.Connection&quot;</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">sql_writer_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports the dataset to a SQL database.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (`str`):</span>
<span class="sd">                Name of SQL table.</span>
<span class="sd">            con (`str` or `sqlite3.Connection` or `sqlalchemy.engine.Connection` or `sqlalchemy.engine.Connection`):</span>
<span class="sd">                A [URI string](https://docs.sqlalchemy.org/en/13/core/engines.html#database-urls) or a SQLite3/SQLAlchemy connection object used to write to a database.</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                Size of the batch to load in memory and write at once.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            **sql_writer_kwargs (additional keyword arguments):</span>
<span class="sd">                Parameters to pass to pandas&#39;s [`pandas.DataFrame.to_sql`](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_sql.html).</span>
<span class="sd">                The parameter `index` defaults to `False` if not specified.</span>
<span class="sd">                If you would like to write the index, pass `index=True` and also set a name for the index column by</span>
<span class="sd">                passing `index_label`.</span>


<span class="sd">        Returns:</span>
<span class="sd">            `int`: The number of records written.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; # con provided as a connection URI string</span>
<span class="sd">        &gt;&gt;&gt; ds.to_sql(&quot;data&quot;, &quot;sqlite:///my_own_db.sql&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # con provided as a sqlite3 connection object</span>
<span class="sd">        &gt;&gt;&gt; import sqlite3</span>
<span class="sd">        &gt;&gt;&gt; con = sqlite3.connect(&quot;my_own_db.sql&quot;)</span>
<span class="sd">        &gt;&gt;&gt; with con:</span>
<span class="sd">        ...     ds.to_sql(&quot;data&quot;, con)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">**</span><span class="n">sql_writer_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="IterableDataset.to_parquet">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.to_parquet">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_parquet</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_or_buf</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">parquet_writer_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports the dataset to parquet</span>

<span class="sd">        Args:</span>
<span class="sd">            path_or_buf (`PathLike` or `FileOrBuffer`):</span>
<span class="sd">                Either a path to a file (e.g. `file.parquet`), a remote URI (e.g. `hf://datasets/username/my_dataset_name/data.parquet`),</span>
<span class="sd">                or a BinaryIO, where the dataset will be saved to in the specified format.</span>
<span class="sd">            batch_size (`int`, *optional*):</span>
<span class="sd">                Size of the batch to load in memory and write at once.</span>
<span class="sd">                Defaults to `datasets.config.DEFAULT_MAX_BATCH_SIZE`.</span>
<span class="sd">            storage_options (`dict`, *optional*):</span>
<span class="sd">                Key/value pairs to be passed on to the file-system backend, if any.</span>

<span class="sd">                &lt;Added version=&quot;2.19.0&quot;/&gt;</span>
<span class="sd">            **parquet_writer_kwargs (additional keyword arguments):</span>
<span class="sd">                Parameters to pass to PyArrow&#39;s `pyarrow.parquet.ParquetWriter`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `int`: The number of characters or bytes written.</span>

<span class="sd">        Example:</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; ds.to_parquet(&quot;path/to/dataset/directory&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        ```py</span>
<span class="sd">        &gt;&gt;&gt; num_shards = dataset.num_shards</span>
<span class="sd">        &gt;&gt;&gt; for index in range(num_shards):</span>
<span class="sd">        ...     shard = dataset.shard(index, num_shards)</span>
<span class="sd">        ...     shard.to_parquet(f&quot;path/of/my/dataset/data-{index:05d}.parquet&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_arrow_writer_batch_size_from_features</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">get_arrow_writer_batch_size_from_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_MAX_BATCH_SIZE</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fingerprint</span><span class="o">=</span><span class="s2">&quot;unset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
            <span class="n">path_or_buf</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span> <span class="o">**</span><span class="n">parquet_writer_kwargs</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_push_parquet_shards_to_hub_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_jobs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">create_pr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="c1"># max_shard_size: Optional[Union[int, str]] = None,  # TODO(QL): add arg</span>
        <span class="n">num_shards</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">embed_external_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationAdd</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pushes the dataset shards as Parquet files to the hub.</span>

<span class="sd">        Returns:</span>
<span class="sd">            additions (`List[CommitOperation]`): list of the `CommitOperationAdd` of the uploaded shards</span>
<span class="sd">            uploaded_size (`int`): number of uploaded bytes to the repository</span>
<span class="sd">            dataset_nbytes (`int`): approximate size in bytes of the uploaded dataset after uncompression</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">div</span> <span class="o">=</span> <span class="n">num_shards</span> <span class="o">//</span> <span class="n">num_jobs</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">num_shards</span> <span class="o">%</span> <span class="n">num_jobs</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">div</span> <span class="o">*</span> <span class="n">job_id</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">div</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">job_id</span> <span class="o">&lt;</span> <span class="n">mod</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">index_shards</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="o">=</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">HfApi</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HF_ENDPOINT</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

        <span class="n">uploaded_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dataset_nbytes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_examples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">additions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationAdd</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">shard</span> <span class="ow">in</span> <span class="n">index_shards</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">embed_external_files</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.arrow_writer</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_arrow_writer_batch_size_from_features</span>

                <span class="n">shard</span> <span class="o">=</span> <span class="n">shard</span><span class="o">.</span><span class="n">with_format</span><span class="p">(</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span>
                <span class="n">shard</span> <span class="o">=</span> <span class="n">shard</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span><span class="n">embed_table_storage</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">),</span>
                    <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">get_arrow_writer_batch_size_from_features</span><span class="p">(</span><span class="n">shard</span><span class="o">.</span><span class="n">features</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="n">shard_path_in_repo</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">-of-</span><span class="si">{</span><span class="n">num_shards</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">shard</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">parquet_metadata</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">num_examples</span> <span class="o">+=</span> <span class="n">parquet_metadata</span><span class="o">.</span><span class="n">num_rows</span>
            <span class="n">dataset_nbytes</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">parquet_metadata</span><span class="o">.</span><span class="n">row_group</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_byte_size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parquet_metadata</span><span class="o">.</span><span class="n">num_row_groups</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">parquet_content</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">uploaded_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parquet_content</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">buffer</span>
            <span class="n">shard_addition</span> <span class="o">=</span> <span class="n">CommitOperationAdd</span><span class="p">(</span><span class="n">path_in_repo</span><span class="o">=</span><span class="n">shard_path_in_repo</span><span class="p">,</span> <span class="n">path_or_fileobj</span><span class="o">=</span><span class="n">parquet_content</span><span class="p">)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">preupload_lfs_files</span><span class="p">(</span>
                <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
                <span class="n">additions</span><span class="o">=</span><span class="p">[</span><span class="n">shard_addition</span><span class="p">],</span>
                <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
                <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
                <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shard_addition</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span>

        <span class="k">yield</span> <span class="n">job_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">additions</span><span class="p">,</span> <span class="n">dataset_nbytes</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_push_parquet_shards_to_hub</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">create_pr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="c1"># max_shard_size: Optional[Union[int, str]],  # TODO(QL): add arg</span>
        <span class="n">num_shards</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">embed_external_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationAdd</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pushes the dataset shards as Parquet files to the hub.</span>

<span class="sd">        Returns:</span>
<span class="sd">            additions (`List[CommitOperation]`): list of the `CommitOperationAdd` of the uploaded shards</span>
<span class="sd">            uploaded_size (`int`): number of uploaded bytes to the repository</span>
<span class="sd">            dataset_nbytes (`int`): approximate size in bytes of the uploaded dataset after uncompression</span>
<span class="sd">            num_examples (`int`): number of examples of the uploaded dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find decodable columns, because if there are any, we need to:</span>
        <span class="c1"># embed the bytes from the files in the shards</span>
        <span class="n">decodable_columns</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">require_decoding</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ignore_decode_attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">embed_external_files</span>
            <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">embed_external_files</span> <span class="o">=</span> <span class="n">embed_external_files</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">decodable_columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_shards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO(QL): this can depend on max_shard_size later</span>
            <span class="n">num_shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span>

        <span class="n">additions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationAdd</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dataset_nbytes</span> <span class="o">=</span> <span class="n">num_examples</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">num_jobs</span> <span class="o">=</span> <span class="n">num_proc</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="n">kwargs_iterable</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span><span class="o">=</span><span class="n">num_jobs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                <span class="s2">&quot;num_jobs&quot;</span><span class="p">:</span> <span class="n">num_jobs</span><span class="p">,</span>
                <span class="s2">&quot;repo_id&quot;</span><span class="p">:</span> <span class="n">repo_id</span><span class="p">,</span>
                <span class="s2">&quot;data_dir&quot;</span><span class="p">:</span> <span class="n">data_dir</span><span class="p">,</span>
                <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span>
                <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
                <span class="s2">&quot;revision&quot;</span><span class="p">:</span> <span class="n">revision</span><span class="p">,</span>
                <span class="s2">&quot;create_pr&quot;</span><span class="p">:</span> <span class="n">create_pr</span><span class="p">,</span>
                <span class="s2">&quot;num_shards&quot;</span><span class="p">:</span> <span class="n">num_shards</span><span class="p">,</span>
                <span class="s2">&quot;embed_external_files&quot;</span><span class="p">:</span> <span class="n">embed_external_files</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Uploading the dataset shards&quot;</span>
        <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (num_proc=</span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_proc</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">hf_tqdm</span><span class="p">(</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; shards&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span> <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_proc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">update_stream</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">IterableDataset</span><span class="o">.</span><span class="n">_push_parquet_shards_to_hub_single</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_iterable</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">iflatmap_unordered</span><span class="p">(</span>
                    <span class="n">pool</span><span class="p">,</span>
                    <span class="n">IterableDataset</span><span class="o">.</span><span class="n">_push_parquet_shards_to_hub_single</span><span class="p">,</span>
                    <span class="n">kwargs_iterable</span><span class="o">=</span><span class="n">kwargs_iterable</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">update_stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additions</span> <span class="o">+=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dataset_nbytes</span> <span class="o">+=</span> <span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">num_examples</span> <span class="o">+=</span> <span class="n">content</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">uploaded_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">addition</span><span class="o">.</span><span class="n">upload_info</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">addition</span> <span class="ow">in</span> <span class="n">additions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">additions</span><span class="p">,</span> <span class="n">uploaded_size</span><span class="p">,</span> <span class="n">dataset_nbytes</span><span class="p">,</span> <span class="n">num_examples</span>

<div class="viewcode-block" id="IterableDataset.push_to_hub">
<a class="viewcode-back" href="../../api/generated/datasets.IterableDataset.html#datasets.IterableDataset.push_to_hub">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_to_hub</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="n">set_default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">commit_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">commit_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_pr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="c1"># max_shard_size: Optional[Union[int, str]] = None,  # TODO(QL): add arg</span>
        <span class="n">num_shards</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">embed_external_files</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">num_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommitInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pushes the dataset to the hub as a Parquet dataset.</span>
<span class="sd">        The dataset is pushed using HTTP requests and does not need to have neither git or git-lfs installed.</span>

<span class="sd">        The resulting Parquet files are self-contained by default. If your dataset contains [`Image`], [`Audio`] or [`Video`]</span>
<span class="sd">        data, the Parquet files will store the bytes of your images or audio files.</span>
<span class="sd">        You can disable this by setting `embed_external_files` to `False`.</span>

<span class="sd">        Args:</span>
<span class="sd">            repo_id (`str`):</span>
<span class="sd">                The ID of the repository to push to in the following format: `&lt;user&gt;/&lt;dataset_name&gt;` or</span>
<span class="sd">                `&lt;org&gt;/&lt;dataset_name&gt;`. Also accepts `&lt;dataset_name&gt;`, which will default to the namespace</span>
<span class="sd">                of the logged-in user.</span>
<span class="sd">            config_name (`str`, defaults to &quot;default&quot;):</span>
<span class="sd">                The configuration name (or subset) of a dataset. Defaults to &quot;default&quot;.</span>
<span class="sd">            set_default (`bool`, *optional*):</span>
<span class="sd">                Whether to set this configuration as the default one. Otherwise, the default configuration is the one</span>
<span class="sd">                named &quot;default&quot;.</span>
<span class="sd">            split (`str`, *optional*):</span>
<span class="sd">                The name of the split that will be given to that dataset. Defaults to `self.split`.</span>
<span class="sd">            data_dir (`str`, *optional*):</span>
<span class="sd">                Directory name that will contain the uploaded data files. Defaults to the `config_name` if different</span>
<span class="sd">                from &quot;default&quot;, else &quot;data&quot;.</span>
<span class="sd">            commit_message (`str`, *optional*):</span>
<span class="sd">                Message to commit while pushing. Will default to `&quot;Upload dataset&quot;`.</span>
<span class="sd">            commit_description (`str`, *optional*):</span>
<span class="sd">                Description of the commit that will be created.</span>
<span class="sd">                Additionally, description of the PR if a PR is created (`create_pr` is True).</span>
<span class="sd">            private (`bool`, *optional*):</span>
<span class="sd">                Whether to make the repo private. If `None` (default), the repo will be public unless the</span>
<span class="sd">                organization&#39;s default is private. This value is ignored if the repo already exists.</span>
<span class="sd">            token (`str`, *optional*):</span>
<span class="sd">                An optional authentication token for the Hugging Face Hub. If no token is passed, will default</span>
<span class="sd">                to the token saved locally when logging in with `huggingface-cli login`. Will raise an error</span>
<span class="sd">                if no token is passed and the user is not logged-in.</span>
<span class="sd">            revision (`str`, *optional*):</span>
<span class="sd">                Branch to push the uploaded files to. Defaults to the `&quot;main&quot;` branch.</span>
<span class="sd">            create_pr (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether to create a PR with the uploaded files or directly commit.</span>
<span class="sd">            num_shards (`int`, *optional*):</span>
<span class="sd">                Number of shards to write. Equals to this dataset&#39;s `.num_shards` by default.</span>
<span class="sd">            embed_external_files (`bool`, defaults to `True`):</span>
<span class="sd">                Whether to embed file bytes in the shards.</span>
<span class="sd">                In particular, this will do the following before the push for the fields of type:</span>

<span class="sd">                - [`Audio`] and [`Image`]: remove local path information and embed file content in the Parquet files.</span>
<span class="sd">            num_proc (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Number of processes when preparing and uploading the dataset.</span>
<span class="sd">                This is helpful if the dataset is made of many samples and transformations.</span>
<span class="sd">                Multiprocessing is disabled by default.</span>

<span class="sd">        Return:</span>
<span class="sd">            huggingface_hub.CommitInfo</span>

<span class="sd">        Example:</span>

<span class="sd">        ```python</span>
<span class="sd">        &gt;&gt;&gt; dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;)</span>
<span class="sd">        &gt;&gt;&gt; dataset_dict.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, private=True)</span>
<span class="sd">        &gt;&gt;&gt; dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, num_shards=1024)</span>
<span class="sd">        ```</span>

<span class="sd">        If your dataset has multiple splits (e.g. train/validation/test):</span>

<span class="sd">        ```python</span>
<span class="sd">        &gt;&gt;&gt; train_dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, split=&quot;train&quot;)</span>
<span class="sd">        &gt;&gt;&gt; val_dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, split=&quot;validation&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # later</span>
<span class="sd">        &gt;&gt;&gt; dataset = load_dataset(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;)</span>
<span class="sd">        &gt;&gt;&gt; train_dataset = dataset[&quot;train&quot;]</span>
<span class="sd">        &gt;&gt;&gt; val_dataset = dataset[&quot;validation&quot;]</span>
<span class="sd">        ```</span>

<span class="sd">        If you want to add a new configuration (or subset) to a dataset (e.g. if the dataset has multiple tasks/versions/languages):</span>

<span class="sd">        ```python</span>
<span class="sd">        &gt;&gt;&gt; english_dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, &quot;en&quot;)</span>
<span class="sd">        &gt;&gt;&gt; french_dataset.push_to_hub(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, &quot;fr&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # later</span>
<span class="sd">        &gt;&gt;&gt; english_dataset = load_dataset(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, &quot;en&quot;)</span>
<span class="sd">        &gt;&gt;&gt; french_dataset = load_dataset(&quot;&lt;organization&gt;/&lt;dataset_id&gt;&quot;, &quot;fr&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Video(&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;push_to_hub is not implemented for video datasets, instead you should upload the video files &quot;</span>
                <span class="s2">&quot;using e.g. the huggingface_hub library and optionally upload a metadata.csv or metadata.jsonl &quot;</span>
                <span class="s2">&quot;file containing other information like video captions, features or labels. More information &quot;</span>
                <span class="s2">&quot;at https://huggingface.co/docs/datasets/main/en/video_load#videofolder&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many num_proc: </span><span class="si">{</span><span class="n">num_proc</span><span class="si">}</span><span class="s2"> (max is dataset.num_shards=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">num_proc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2"> processes.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;To parallelize data loading, we give each process some shards (or data sources) to process. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Therefore it&#39;s unnecessary to have a number of processes greater than dataset.num_shards=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;To enable more parallelism, please split the dataset in more files than </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">num_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_shards</span>

        <span class="k">if</span> <span class="n">config_name</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`config_name` cannot be &#39;data&#39;. Please, choose another name for configuration.&quot;</span><span class="p">)</span>

        <span class="c1"># if max_shard_size is not None and num_shards is not None:</span>
        <span class="c1">#     raise ValueError(</span>
        <span class="c1">#         &quot;Failed to push_to_hub: please specify either max_shard_size or num_shards, but not both.&quot;</span>
        <span class="c1">#     )</span>

        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;train&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">_split_re</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split name should match &#39;</span><span class="si">{</span><span class="n">_split_re</span><span class="si">}</span><span class="s2">&#39; but got &#39;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">HfApi</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HF_ENDPOINT</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">repo_info</span><span class="p">(</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="k">except</span> <span class="n">RepositoryNotFoundError</span><span class="p">:</span>
            <span class="n">repo_url</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">create_repo</span><span class="p">(</span>
                <span class="n">repo_id</span><span class="p">,</span>
                <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
                <span class="n">private</span><span class="o">=</span><span class="n">private</span><span class="p">,</span>
                <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_url</span><span class="o">.</span><span class="n">repo_id</span>

        <span class="k">if</span> <span class="n">revision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">revision</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;refs/pr/&quot;</span><span class="p">):</span>
            <span class="c1"># We do not call create_branch for a PR reference: 400 Bad Request</span>
            <span class="n">api</span><span class="o">.</span><span class="n">create_branch</span><span class="p">(</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dir</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">config_name</span> <span class="k">if</span> <span class="n">config_name</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>  <span class="c1"># for backward compatibility</span>

        <span class="n">additions</span><span class="p">,</span> <span class="n">uploaded_size</span><span class="p">,</span> <span class="n">dataset_nbytes</span><span class="p">,</span> <span class="n">num_examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_push_parquet_shards_to_hub</span><span class="p">(</span>
            <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
            <span class="c1"># max_shard_size=max_shard_size,  # TODO(QL): add arg</span>
            <span class="n">num_shards</span><span class="o">=</span><span class="n">num_shards</span><span class="p">,</span>
            <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
            <span class="n">embed_external_files</span><span class="o">=</span><span class="n">embed_external_files</span><span class="p">,</span>
            <span class="n">num_proc</span><span class="o">=</span><span class="n">num_proc</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_deletions_and_dataset_card</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationDelete</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
            <span class="n">parent_commit</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">repo_info</span><span class="p">(</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span><span class="o">.</span><span class="n">sha</span>

            <span class="c1"># Check if the repo already has a README.md and/or a dataset_infos.json to update them with the new split info (size and pattern)</span>
            <span class="c1"># and delete old split shards (if they exist)</span>
            <span class="n">repo_with_dataset_card</span><span class="p">,</span> <span class="n">repo_with_dataset_infos</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
            <span class="n">deletions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommitOperationDelete</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">deleted_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">repo_splits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># use a list to keep the order of the splits</span>
            <span class="n">repo_files_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="n">addition</span><span class="o">.</span><span class="n">path_in_repo</span> <span class="k">for</span> <span class="n">addition</span> <span class="ow">in</span> <span class="n">additions</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">repo_file</span> <span class="ow">in</span> <span class="n">api</span><span class="o">.</span><span class="n">list_repo_tree</span><span class="p">(</span>
                <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">parent_commit</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo_file</span><span class="p">,</span> <span class="n">RepoFile</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">REPOCARD_FILENAME</span><span class="p">:</span>
                    <span class="n">repo_with_dataset_card</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">DATASETDICT_INFOS_FILENAME</span><span class="p">:</span>
                    <span class="n">repo_with_dataset_infos</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">-&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repo_files_to_add</span>
                <span class="p">):</span>
                    <span class="n">deletions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommitOperationDelete</span><span class="p">(</span><span class="n">path_in_repo</span><span class="o">=</span><span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span><span class="p">))</span>
                    <span class="n">deleted_size</span> <span class="o">+=</span> <span class="n">repo_file</span><span class="o">.</span><span class="n">size</span>
                <span class="k">elif</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span>
                    <span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span><span class="p">,</span>
                    <span class="n">PUSH_TO_HUB_WITHOUT_METADATA_CONFIGS_SPLIT_PATTERN_SHARDED</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{split}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">),</span>
                <span class="p">):</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">glob_pattern_to_regex</span><span class="p">(</span><span class="n">PUSH_TO_HUB_WITHOUT_METADATA_CONFIGS_SPLIT_PATTERN_SHARDED</span><span class="p">)</span>
                    <span class="n">split_pattern_fields</span> <span class="o">=</span> <span class="n">string_to_dict</span><span class="p">(</span><span class="n">repo_file</span><span class="o">.</span><span class="n">rfilename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">split_pattern_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">repo_split</span> <span class="o">=</span> <span class="n">split_pattern_fields</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">repo_split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repo_splits</span><span class="p">:</span>
                        <span class="n">repo_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repo_split</span><span class="p">)</span>

            <span class="n">organization</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">repo_id</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>
            <span class="n">info_to_dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">download_checksums</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">download_size</span> <span class="o">=</span> <span class="n">uploaded_size</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">=</span> <span class="n">dataset_nbytes</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">uploaded_size</span> <span class="o">+</span> <span class="n">dataset_nbytes</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="n">config_name</span>
            <span class="n">info_to_dump</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">SplitDict</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">split</span><span class="p">:</span> <span class="n">SplitInfo</span><span class="p">(</span>
                        <span class="n">split</span><span class="p">,</span> <span class="n">num_bytes</span><span class="o">=</span><span class="n">dataset_nbytes</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="n">num_examples</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># get the info from the README to update them</span>
            <span class="k">if</span> <span class="n">repo_with_dataset_card</span><span class="p">:</span>
                <span class="n">dataset_card_path</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">hf_hub_download</span><span class="p">(</span>
                    <span class="n">repo_id</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">REPOCARD_FILENAME</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">parent_commit</span>
                <span class="p">)</span>
                <span class="n">dataset_card</span> <span class="o">=</span> <span class="n">DatasetCard</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_card_path</span><span class="p">))</span>
                <span class="n">dataset_card_data</span> <span class="o">=</span> <span class="n">dataset_card</span><span class="o">.</span><span class="n">data</span>
                <span class="n">metadata_configs</span> <span class="o">=</span> <span class="n">MetadataConfigs</span><span class="o">.</span><span class="n">from_dataset_card_data</span><span class="p">(</span><span class="n">dataset_card_data</span><span class="p">)</span>
                <span class="n">dataset_infos</span><span class="p">:</span> <span class="n">DatasetInfosDict</span> <span class="o">=</span> <span class="n">DatasetInfosDict</span><span class="o">.</span><span class="n">from_dataset_card_data</span><span class="p">(</span><span class="n">dataset_card_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dataset_infos</span> <span class="ow">and</span> <span class="n">config_name</span> <span class="ow">in</span> <span class="n">dataset_infos</span><span class="p">:</span>
                    <span class="n">repo_info</span> <span class="o">=</span> <span class="n">dataset_infos</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">repo_info</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># get the deprecated dataset_infos.json to update them</span>
            <span class="k">elif</span> <span class="n">repo_with_dataset_infos</span><span class="p">:</span>
                <span class="n">dataset_card</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dataset_card_data</span> <span class="o">=</span> <span class="n">DatasetCardData</span><span class="p">()</span>
                <span class="n">metadata_configs</span> <span class="o">=</span> <span class="n">MetadataConfigs</span><span class="p">()</span>
                <span class="n">dataset_infos_path</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">hf_hub_download</span><span class="p">(</span>
                    <span class="n">repo_id</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DATASETDICT_INFOS_FILENAME</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">parent_commit</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_infos_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">dataset_infos</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">dataset_info</span> <span class="o">=</span> <span class="n">dataset_infos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">dataset_infos</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">repo_info</span> <span class="o">=</span> <span class="n">DatasetInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dataset_info</span><span class="p">)</span> <span class="k">if</span> <span class="n">dataset_info</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset_card</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dataset_card_data</span> <span class="o">=</span> <span class="n">DatasetCardData</span><span class="p">()</span>
                <span class="n">metadata_configs</span> <span class="o">=</span> <span class="n">MetadataConfigs</span><span class="p">()</span>
                <span class="n">repo_info</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># update the total info to dump from existing info</span>
            <span class="k">if</span> <span class="n">repo_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating downloaded metadata with the new split.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[</span><span class="n">split</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span> <span class="o">!=</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Features of the new split don&#39;t match the features of the existing splits on the hub: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">repo_info</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span><span class="p">:</span>
                        <span class="n">repo_info</span><span class="o">.</span><span class="n">download_size</span> <span class="o">-=</span> <span class="n">deleted_size</span>
                        <span class="n">repo_info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">-=</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">SplitInfo</span><span class="p">())</span><span class="o">.</span><span class="n">num_bytes</span> <span class="ow">or</span> <span class="mi">0</span>

                    <span class="n">repo_info</span><span class="o">.</span><span class="n">download_checksums</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">repo_info</span><span class="o">.</span><span class="n">download_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo_info</span><span class="o">.</span><span class="n">download_size</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">uploaded_size</span>
                    <span class="n">repo_info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo_info</span><span class="o">.</span><span class="n">dataset_size</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dataset_nbytes</span>
                    <span class="n">repo_info</span><span class="o">.</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">download_size</span> <span class="o">+</span> <span class="n">repo_info</span><span class="o">.</span><span class="n">dataset_size</span>
                    <span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">repo_info</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">SplitInfo</span><span class="p">(</span>
                        <span class="n">split</span><span class="p">,</span> <span class="n">num_bytes</span><span class="o">=</span><span class="n">dataset_nbytes</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span>
                    <span class="p">)</span>
                    <span class="n">info_to_dump</span> <span class="o">=</span> <span class="n">repo_info</span>
            <span class="c1"># create the metadata configs if it was uploaded with push_to_hub before metadata configs existed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_configs</span> <span class="ow">and</span> <span class="n">repo_splits</span><span class="p">:</span>
                <span class="n">default_metadata_configs_to_dump</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data_files&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">-*&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">repo_splits</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">MetadataConfigs</span><span class="p">({</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default_metadata_configs_to_dump</span><span class="p">})</span><span class="o">.</span><span class="n">to_dataset_card_data</span><span class="p">(</span><span class="n">dataset_card_data</span><span class="p">)</span>
            <span class="c1"># update the metadata configs</span>
            <span class="k">if</span> <span class="n">config_name</span> <span class="ow">in</span> <span class="n">metadata_configs</span><span class="p">:</span>
                <span class="n">metadata_config</span> <span class="o">=</span> <span class="n">metadata_configs</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;data_files&quot;</span> <span class="ow">in</span> <span class="n">metadata_config</span><span class="p">:</span>
                    <span class="n">data_files_to_dump</span> <span class="o">=</span> <span class="n">sanitize_patterns</span><span class="p">(</span><span class="n">metadata_config</span><span class="p">[</span><span class="s2">&quot;data_files&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_files_to_dump</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># add the new split</span>
                <span class="n">data_files_to_dump</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">-*&quot;</span><span class="p">]</span>
                <span class="n">metadata_config_to_dump</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data_files&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">_split</span><span class="p">,</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">_pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pattern</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">_pattern</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">_split</span><span class="p">,</span> <span class="n">_pattern</span> <span class="ow">in</span> <span class="n">data_files_to_dump</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata_config_to_dump</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data_files&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">-*&quot;</span><span class="p">}]}</span>
            <span class="n">configs_to_dump</span> <span class="o">=</span> <span class="p">{</span><span class="n">config_name</span><span class="p">:</span> <span class="n">metadata_config_to_dump</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">set_default</span> <span class="ow">and</span> <span class="n">config_name</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metadata_configs</span><span class="p">:</span>
                    <span class="n">current_default_config_name</span> <span class="o">=</span> <span class="n">metadata_configs</span><span class="o">.</span><span class="n">get_default_config_name</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">current_default_config_name</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;There exists a configuration named &#39;default&#39;. To set a different configuration as default, &quot;</span>
                            <span class="s2">&quot;rename the &#39;default&#39; one first.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_default_config_name</span><span class="p">:</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">metadata_configs</span><span class="p">[</span><span class="n">current_default_config_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
                        <span class="n">configs_to_dump</span><span class="p">[</span><span class="n">current_default_config_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_configs</span><span class="p">[</span><span class="n">current_default_config_name</span><span class="p">]</span>
                <span class="n">metadata_config_to_dump</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># push to the deprecated dataset_infos.json</span>
            <span class="k">if</span> <span class="n">repo_with_dataset_infos</span><span class="p">:</span>
                <span class="n">dataset_infos_path</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">hf_hub_download</span><span class="p">(</span>
                    <span class="n">repo_id</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DATASETDICT_INFOS_FILENAME</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">parent_commit</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_infos_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">dataset_infos</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">dataset_infos</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">info_to_dump</span><span class="p">)</span>
                <span class="n">new_dataset_infos</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dataset_infos</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dataset_infos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># push to README</span>
            <span class="n">DatasetInfosDict</span><span class="p">({</span><span class="n">config_name</span><span class="p">:</span> <span class="n">info_to_dump</span><span class="p">})</span><span class="o">.</span><span class="n">to_dataset_card_data</span><span class="p">(</span><span class="n">dataset_card_data</span><span class="p">)</span>
            <span class="n">MetadataConfigs</span><span class="p">(</span><span class="n">configs_to_dump</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataset_card_data</span><span class="p">(</span><span class="n">dataset_card_data</span><span class="p">)</span>
            <span class="n">new_dataset_card</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">DatasetCard</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;---</span><span class="se">\n</span><span class="si">{</span><span class="n">dataset_card_data</span><span class="si">}</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">dataset_card</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dataset_card</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">parent_commit</span><span class="p">,</span> <span class="n">deletions</span><span class="p">,</span> <span class="n">new_dataset_card</span><span class="p">,</span> <span class="n">new_dataset_infos</span>

        <span class="n">commit_message</span> <span class="o">=</span> <span class="n">commit_message</span> <span class="k">if</span> <span class="n">commit_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Upload dataset&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">UPLOADS_MAX_NUMBER_PER_COMMIT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of files to upload is larger than </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">UPLOADS_MAX_NUMBER_PER_COMMIT</span><span class="si">}</span><span class="s2">. Splitting the push into multiple commits.&quot;</span>
            <span class="p">)</span>
            <span class="n">num_commits</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additions</span><span class="p">)</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">UPLOADS_MAX_NUMBER_PER_COMMIT</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_commits</span><span class="p">):</span>
                <span class="n">operations</span> <span class="o">=</span> <span class="n">additions</span><span class="p">[</span>
                    <span class="n">i</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">UPLOADS_MAX_NUMBER_PER_COMMIT</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">UPLOADS_MAX_NUMBER_PER_COMMIT</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">retry</span><span class="p">,</span> <span class="n">sleep_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">30</span><span class="p">)),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># We need to retry if another commit happens at the same time</span>
                    <span class="n">sleep_time</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">commit_info</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">create_commit</span><span class="p">(</span>
                            <span class="n">repo_id</span><span class="p">,</span>
                            <span class="n">operations</span><span class="o">=</span><span class="n">operations</span><span class="p">,</span>
                            <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (part </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">-of-</span><span class="si">{</span><span class="n">num_commits</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">commit_description</span><span class="o">=</span><span class="n">commit_description</span><span class="p">,</span>
                            <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
                            <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
                            <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="n">HfHubHTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">err</span><span class="o">.</span><span class="n">__context__</span>
                            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="n">HfHubHTTPError</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span>
                        <span class="p">):</span>
                            <span class="c1"># 409 is Conflict (another commit is in progress)</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Retrying intermediate commit for </span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">retry</span><span class="si">}</span><span class="s2">/n with status_code </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="k">break</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Commit #</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> completed&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (still </span><span class="si">{</span><span class="n">num_commits</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> to go)&quot;</span> <span class="k">if</span> <span class="n">num_commits</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                <span class="p">)</span>
            <span class="n">last_commit_additions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_commit_additions</span> <span class="o">=</span> <span class="n">additions</span>

        <span class="k">for</span> <span class="n">retry</span><span class="p">,</span> <span class="n">sleep_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">30</span><span class="p">)),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># We need to retry if there was a commit in between in case it touched the dataset card data</span>
            <span class="n">sleep_time</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">parent_commit</span><span class="p">,</span> <span class="n">deletions</span><span class="p">,</span> <span class="n">dataset_card</span><span class="p">,</span> <span class="n">dataset_infos</span> <span class="o">=</span> <span class="n">get_deletions_and_dataset_card</span><span class="p">()</span>
            <span class="n">dataset_card_additions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">dataset_infos</span><span class="p">:</span>
                <span class="n">dataset_card_additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">CommitOperationAdd</span><span class="p">(</span>
                        <span class="n">path_in_repo</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">DATASETDICT_INFOS_FILENAME</span><span class="p">,</span>
                        <span class="n">path_or_fileobj</span><span class="o">=</span><span class="n">dataset_infos</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">dataset_card_additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">CommitOperationAdd</span><span class="p">(</span><span class="n">path_in_repo</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">REPOCARD_FILENAME</span><span class="p">,</span> <span class="n">path_or_fileobj</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_card</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commit_info</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">create_commit</span><span class="p">(</span>
                    <span class="n">repo_id</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">=</span><span class="n">last_commit_additions</span> <span class="o">+</span> <span class="n">dataset_card_additions</span> <span class="o">+</span> <span class="n">deletions</span><span class="p">,</span>
                    <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
                    <span class="n">commit_description</span><span class="o">=</span><span class="n">commit_description</span><span class="p">,</span>
                    <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
                    <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
                    <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
                    <span class="n">parent_commit</span><span class="o">=</span><span class="n">parent_commit</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">HfHubHTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">__context__</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="n">HfHubHTTPError</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">412</span><span class="p">,</span> <span class="mi">409</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c1"># 412 is Precondition failed (parent_commit isn&#39;t satisfied)</span>
                    <span class="c1"># 409 is Conflict (another commit is in progress)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Retrying commit for </span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">retry</span><span class="si">}</span><span class="s2">/n with status_code </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">break</span>

        <span class="k">return</span> <span class="n">commit_info</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_concatenate_iterable_datasets</span><span class="p">(</span>
    <span class="n">dsets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IterableDataset</span><span class="p">],</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NamedSplit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a list of `IterableDataset` with the same schema into a single `IterableDataset`.</span>
<span class="sd">    Missing data are filled with None values.</span>

<span class="sd">    &lt;Added version=&quot;2.4.0&quot;/&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">        dsets (`List[datasets.IterableDataset]`): List of Datasets to concatenate.</span>
<span class="sd">        info (`DatasetInfo`, optional): Dataset information, like description, citation, etc.</span>
<span class="sd">        split (`NamedSplit`, optional): Name of the dataset split.</span>
<span class="sd">        axis (``{0, 1}``, default ``0``, meaning over rows):</span>
<span class="sd">            Axis to concatenate over, where ``0`` means over rows (vertically) and ``1`` means over columns</span>
<span class="sd">            (horizontally).</span>

<span class="sd">            *New in version 1.6.0*</span>

<span class="sd">    Example:</span>

<span class="sd">    ```py</span>
<span class="sd">    &gt;&gt;&gt; ds3 = _concatenate_iterable_datasets([ds1, ds2])</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">_resolve_features</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">]</span>

    <span class="c1"># Perform checks (and a potentional cast if axis=0)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_check_if_features_can_be_aligned</span><span class="p">([</span><span class="n">dset</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_check_column_names</span><span class="p">([</span><span class="n">col_name</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">features</span><span class="p">])</span>

    <span class="c1"># Check format is consistent; if so, will set format for concatenated dataset</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="n">formatting</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">_formatting</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="n">formatting</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Some of the datasets have disparate format or format not set. Resetting the format of the concatenated dataset.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">format_type_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">dset</span><span class="o">.</span><span class="n">_formatting</span><span class="o">.</span><span class="n">format_type</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">format_type_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">format_type</span> <span class="o">=</span> <span class="n">format_type_set</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">formatting</span> <span class="o">=</span> <span class="n">FormattingConfig</span><span class="p">(</span><span class="n">format_type</span><span class="o">=</span><span class="n">format_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formatting</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Some of the datasets have disparate format or format not set. Resetting the format of the concatenated dataset.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># TODO: improve this to account for a mix of ClassLabel and Value for example</span>
    <span class="c1"># right now it would keep the type of the first dataset in the list</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">_align_features</span><span class="p">([</span><span class="n">dset</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="p">)</span>

    <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">VerticallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">HorizontallyConcatenatedMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">)</span>
    <span class="c1"># Set new info - we update the features</span>
    <span class="c1"># setting the features also ensures to fill missing columns with None</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">DatasetInfo</span><span class="o">.</span><span class="n">from_merge</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
    <span class="c1"># Get all the auth tokens per repository - in case the datasets come from different private repositories</span>
    <span class="n">token_per_repo_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">repo_id</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">dsets</span> <span class="k">for</span> <span class="n">repo_id</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># Return new daset</span>
    <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
        <span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
        <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">token_per_repo_id</span><span class="p">,</span>
        <span class="n">formatting</span><span class="o">=</span><span class="n">formatting</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_interleave_iterable_datasets</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">IterableDataset</span><span class="p">],</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">split</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NamedSplit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stopping_strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted&quot;</span><span class="p">,</span> <span class="s2">&quot;all_exhausted_without_replacement&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;first_exhausted&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interleave several iterable datasets (sources) into a single iterable dataset.</span>
<span class="sd">    The new iterable dataset alternates between the sources to yield examples.</span>
<span class="sd">    If `probabilities = None` (default) the iterable dataset will cycles through the sources in order for each next example in the iteration.</span>
<span class="sd">    If `probabilities` is not `None, the iterable dataset will sample a random source according to the provided probabilities for each next examples in the iteration.</span>

<span class="sd">    &lt;Added version=&quot;2.4.0&quot;/&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">        datasets (`List[IterableDataset]`): list of datasets to interleave</span>
<span class="sd">        probabilities (`List[float]`, optional, default None): If specified, the new iterable dataset samples</span>
<span class="sd">            examples from one source at a time according to these probabilities.</span>
<span class="sd">        seed (`int`, optional, default None): The random seed used to choose a source for each example.</span>
<span class="sd">        stopping_strategy (`str`, defaults to `first_exhausted`):</span>
<span class="sd">            Two strategies are proposed right now.</span>
<span class="sd">            By default, `first_exhausted` is an undersampling strategy, i.e the dataset construction is stopped as soon as one dataset has ran out of samples.</span>
<span class="sd">            If the strategy is `all_exhausted`,  we use an oversampling strategy, i.e the dataset construction is stopped as soon as every samples of every dataset has been added at least once.</span>
<span class="sd">            Note that if the strategy is `all_exhausted`, the interleaved dataset size can get enormous:</span>
<span class="sd">            - with no probabilities, the resulting dataset will have max_length_datasets*nb_dataset samples.</span>
<span class="sd">            - with given probabilities, the resulting dataset will have more samples if some datasets have really low probability of visiting.</span>

<span class="sd">    Output:</span>
<span class="sd">        `datasets.IterableDataset`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">_resolve_features</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>

    <span class="c1"># Perform checks</span>
    <span class="n">_check_if_features_can_be_aligned</span><span class="p">([</span><span class="n">dset</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span>

    <span class="c1"># TODO: improve this to account for a mix of ClassLabel and Value for example</span>
    <span class="c1"># right now it would keep the type of the first dataset in the list</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">_align_features</span><span class="p">([</span><span class="n">dset</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="p">)</span>

    <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">.</span><span class="n">iter_arrow</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="n">ex_iterables</span><span class="p">):</span>
        <span class="n">ex_iterables</span> <span class="o">=</span> <span class="p">[</span><span class="n">RebatchedArrowExamplesIterable</span><span class="p">(</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ex_iterable</span> <span class="ow">in</span> <span class="n">ex_iterables</span><span class="p">]</span>
    <span class="c1"># Use cycling or random cycling of sources</span>
    <span class="k">if</span> <span class="n">probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">CyclingMultiSourcesExamplesIterable</span><span class="p">(</span><span class="n">ex_iterables</span><span class="p">,</span> <span class="n">stopping_strategy</span><span class="o">=</span><span class="n">stopping_strategy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ex_iterable</span> <span class="o">=</span> <span class="n">RandomlyCyclingMultiSourcesExamplesIterable</span><span class="p">(</span>
            <span class="n">ex_iterables</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">stopping_strategy</span><span class="o">=</span><span class="n">stopping_strategy</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Set new info - we update the features</span>
    <span class="c1"># setting the features also ensures to fill missing columns with None</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">DatasetInfo</span><span class="o">.</span><span class="n">from_merge</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">info</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">info</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
    <span class="c1"># Get all the auth tokens per repository - in case the datasets come from different private repositories</span>
    <span class="n">token_per_repo_id</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">for</span> <span class="n">repo_id</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1"># Return new daset</span>
    <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span><span class="n">ex_iterable</span><span class="o">=</span><span class="n">ex_iterable</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">token_per_repo_id</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_split_by_node_iterable_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">IterableDataset</span><span class="p">,</span> <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">world_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split an iterable dataset for the node at rank `rank` in a pool of nodes of size `world_size`.</span>

<span class="sd">    If the dataset has a number of shards that is a factor of `world_size` (i.e. if `dataset.num_shards % world_size == 0`),</span>
<span class="sd">    then the shards are evenly assigned across the nodes, which is the most optimized.</span>
<span class="sd">    Otherwise, each node keeps 1 example out of `world_size`, skipping the other examples.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset ([`IterableDataset`]):</span>
<span class="sd">            The iterable dataset to split by node.</span>
<span class="sd">        rank (`int`):</span>
<span class="sd">            Rank of the current node.</span>
<span class="sd">        world_size (`int`):</span>
<span class="sd">            Total number of nodes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`IterableDataset`]: The iterable dataset to be used on the node at rank `rank`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_distributed</span><span class="p">:</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">world_size</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="n">rank</span>
        <span class="n">world_size</span> <span class="o">=</span> <span class="n">world_size</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_distributed</span><span class="o">.</span><span class="n">world_size</span>
    <span class="n">distributed</span> <span class="o">=</span> <span class="n">DistributedConfig</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">IterableDataset</span><span class="p">(</span>
        <span class="n">ex_iterable</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_ex_iterable</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">split</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_split</span><span class="p">,</span>
        <span class="n">formatting</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_formatting</span><span class="p">,</span>
        <span class="n">shuffling</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_shuffling</span><span class="p">),</span>
        <span class="n">distributed</span><span class="o">=</span><span class="n">distributed</span><span class="p">,</span>
        <span class="n">token_per_repo_id</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_token_per_repo_id</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_apply_async</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_batch_fn</span><span class="p">(</span><span class="n">unbatched</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unbatched</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2025, HuggingFace Inc..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>